/* Created by Perspecta http://www.perspecta.com */
/*
        Licensed to the Apache Software Foundation (ASF) under one
        or more contributor license agreements.  See the NOTICE file
        distributed with this work for additional information
        regarding copyright ownership.  The ASF licenses this file
        to you under the Apache License, Version 2.0 (the
        "License"); you may not use this file except in compliance
        with the License.  You may obtain a copy of the License at
        http://www.apache.org/licenses/LICENSE-2.0
        Unless required by applicable law or agreed to in writing,
        software distributed under the License is distributed on an
        "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        KIND, either express or implied.  See the License for the
        specific language governing permissions and limitations
        under the License.
*/
package com.healthconcourse.vista.fhir.api.test.parser;

import com.healthconcourse.vista.fhir.api.HcConstants;
import com.healthconcourse.vista.fhir.api.parser.ObservationParser;
import org.hl7.fhir.dstu3.model.DecimalType;
import org.hl7.fhir.dstu3.model.Observation;
import org.hl7.fhir.dstu3.model.Quantity;
import org.junit.Assert;
import org.junit.Test;

import java.math.BigDecimal;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;

public class ObservationParserTest {

    @Test
    public void TestInvalidVitalsObservationParse () {
        String input = "-1^Patientidentifiernotrecognised";

        ObservationParser parser = new ObservationParser();

        List<Observation> result = parser.parseVitalsList(input);

        Assert.assertTrue(result.isEmpty());
    }

    @Test
    public void TestEmptyVitalsObservationParse () {
        String input = "";

        ObservationParser parser = new ObservationParser();

        List<Observation> result = parser.parseVitalsList(input);

        Assert.assertTrue(result.isEmpty());
    }

    @Test
    public void TestSuccessfulVitalsObservationParse() throws ParseException {
        String input = "{ \"Vitals\": [ { \"Vitals\": { \"dateTimeVitalsEntered\": \"FEB 1,2010@11:38\", \"dateTimeVitalsEnteredFHIR\": \"2010-02-01T11:38:00-05:00\", \"dateTimeVitalsEnteredFM\": 3100201.1138, \"dateTimeVitalsEnteredHL7\": \"201002011138-0500\", \"dateTimeVitalsTaken\": \"FEB 1,2010@11:38\", \"dateTimeVitalsTakenFHIR\": \"2010-02-01T11:38:00-05:00\", \"dateTimeVitalsTakenFM\": 3100201.1138, \"dateTimeVitalsTakenHL7\": \"201002011138-0500\", \"enteredBy\": \"NURSE,EIGHT\", \"enteredById\": 20171, \"enteredByResId\": \"V-500-200-20171\", \"enteredInError\": \"\", \"enteredInErrorCd\": \"\", \"errorEnteredBy\": \"\", \"errorEnteredById\": \"\", \"hospitalLocation\": \"GEN MED\", \"hospitalLocationId\": 9, \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"rate\": \"105\\/59\", \"resourceId\": \"V-500-120.5-24027\", \"resourceType\": \"Observation\", \"supplementalO2\": \"\", \"vitalType\": \"BLOOD PRESSURE\", \"vitalTypeId\": 1, \"vitalTypeSCT\": 75367002, \"vitalTypeSc\": \"Blood pressure\", \"vitalsIen\": 24027 } }, { \"Vitals\": { \"dateTimeVitalsEntered\": \"FEB 1,2010@11:38:01\", \"dateTimeVitalsEnteredFHIR\": \"2010-02-01T11:38:01-05:00\", \"dateTimeVitalsEnteredFM\": 3100201.113801, \"dateTimeVitalsEnteredHL7\": \"20100201113801-0500\", \"dateTimeVitalsTaken\": \"FEB 1,2010@11:38:01\", \"dateTimeVitalsTakenFHIR\": \"2010-02-01T11:38:01-05:00\", \"dateTimeVitalsTakenFM\": 3100201.113801, \"dateTimeVitalsTakenHL7\": \"20100201113801-0500\", \"enteredBy\": \"NURSE,EIGHT\", \"enteredById\": 20171, \"enteredByResId\": \"V-500-200-20171\", \"enteredInError\": \"\", \"enteredInErrorCd\": \"\", \"errorEnteredBy\": \"\", \"errorEnteredById\": \"\", \"hospitalLocation\": \"GEN MED\", \"hospitalLocationId\": 9, \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"rate\": 101.1, \"resourceId\": \"V-500-120.5-24028\", \"resourceType\": \"Observation\", \"supplementalO2\": \"\", \"vitalType\": \"TEMPERATURE\", \"vitalTypeId\": 2, \"vitalTypeSCT\": 386725007, \"vitalTypeSc\": \"Temperature\", \"vitalsIen\": 24028 } }, { \"Vitals\": { \"dateTimeVitalsEntered\": \"FEB 1,2010@11:38:02\", \"dateTimeVitalsEnteredFHIR\": \"2010-02-01T11:38:02-05:00\", \"dateTimeVitalsEnteredFM\": 3100201.113802, \"dateTimeVitalsEnteredHL7\": \"20100201113802-0500\", \"dateTimeVitalsTaken\": \"FEB 1,2010@11:38:02\", \"dateTimeVitalsTakenFHIR\": \"2010-02-01T11:38:02-05:00\", \"dateTimeVitalsTakenFM\": 3100201.113802, \"dateTimeVitalsTakenHL7\": \"20100201113802-0500\", \"enteredBy\": \"NURSE,EIGHT\", \"enteredById\": 20171, \"enteredByResId\": \"V-500-200-20171\", \"enteredInError\": \"\", \"enteredInErrorCd\": \"\", \"errorEnteredBy\": \"\", \"errorEnteredById\": \"\", \"hospitalLocation\": \"GEN MED\", \"hospitalLocationId\": 9, \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"rate\": 195, \"resourceId\": \"V-500-120.5-24029\", \"resourceType\": \"Observation\", \"supplementalO2\": \"\", \"vitalType\": \"WEIGHT\", \"vitalTypeId\": 9, \"vitalTypeSCT\": 27113001, \"vitalTypeSc\": \"Weight\", \"vitalsIen\": 24029 } }, { \"Vitals\": { \"dateTimeVitalsEntered\": \"FEB 1,2010@11:38:03\", \"dateTimeVitalsEnteredFHIR\": \"2010-02-01T11:38:03-05:00\", \"dateTimeVitalsEnteredFM\": 3100201.113803, \"dateTimeVitalsEnteredHL7\": \"20100201113803-0500\", \"dateTimeVitalsTaken\": \"FEB 1,2010@11:38:03\", \"dateTimeVitalsTakenFHIR\": \"2010-02-01T11:38:03-05:00\", \"dateTimeVitalsTakenFM\": 3100201.113803, \"dateTimeVitalsTakenHL7\": \"20100201113803-0500\", \"enteredBy\": \"NURSE,EIGHT\", \"enteredById\": 20171, \"enteredByResId\": \"V-500-200-20171\", \"enteredInError\": \"\", \"enteredInErrorCd\": \"\", \"errorEnteredBy\": \"\", \"errorEnteredById\": \"\", \"hospitalLocation\": \"GEN MED\", \"hospitalLocationId\": 9, \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"rate\": 72, \"resourceId\": \"V-500-120.5-24030\", \"resourceType\": \"Observation\", \"supplementalO2\": \"\", \"vitalType\": \"HEIGHT\", \"vitalTypeId\": 8, \"vitalTypeSCT\": 50373000, \"vitalTypeSc\": \"Height\", \"vitalsIen\": 24030 } }, { \"Vitals\": { \"dateTimeVitalsEntered\": \"FEB 1,2010@11:38\", \"dateTimeVitalsEnteredFHIR\": \"2010-02-01T11:38:00-05:00\", \"dateTimeVitalsEnteredFM\": 3100201.1138, \"dateTimeVitalsEnteredHL7\": \"201002011138-0500\", \"dateTimeVitalsTaken\": \"FEB 1,2010@11:38\", \"dateTimeVitalsTakenFHIR\": \"2010-02-01T11:38:00-05:00\", \"dateTimeVitalsTakenFM\": 3100201.1138, \"dateTimeVitalsTakenHL7\": \"201002011138-0500\", \"enteredBy\": \"NURSE,EIGHT\", \"enteredById\": 20171, \"enteredByResId\": \"V-500-200-20171\", \"enteredInError\": \"\", \"enteredInErrorCd\": \"\", \"errorEnteredBy\": \"\", \"errorEnteredById\": \"\", \"hospitalLocation\": \"GEN MED\", \"hospitalLocationId\": 9, \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"rate\": 96, \"resourceId\": \"V-500-120.5-24031\", \"resourceType\": \"Observation\", \"supplementalO2\": \"\", \"vitalType\": \"PULSE\", \"vitalTypeId\": 5, \"vitalTypeSCT\": 78564009, \"vitalTypeSc\": \"Pulse\", \"vitalsIen\": 24031 } } ] }";

        ObservationParser parser = new ObservationParser();

        List<Observation> result = parser.parseVitalsList(input);

        Assert.assertEquals("Correct number of items", 5, result.size());

        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ssX");
        Date expectedDate = sdf.parse("2010-02-01T11:38:00-05:00");
        Assert.assertEquals("Correct issued date and time", expectedDate, result.get(0).getIssued());
    }

    @Test
    public void TestVitalsObservationParseOrganizationBug() throws ParseException {
        String input = "{ \"Vitals\": [ { \"Vitals\": { \"dateTimeVitalsEntered\": \"FEB 1,2010@11:38\", \"dateTimeVitalsEnteredFHIR\": \"2010-02-01T11:38:00-05:00\", \"dateTimeVitalsEnteredFM\": 3100201.1138, \"dateTimeVitalsEnteredHL7\": \"201002011138-0500\", \"dateTimeVitalsTaken\": \"FEB 1,2010@11:38\", \"dateTimeVitalsTakenFHIR\": \"2010-02-01T11:38:00-05:00\", \"dateTimeVitalsTakenFM\": 3100201.1138, \"dateTimeVitalsTakenHL7\": \"201002011138-0500\", \"enteredBy\": \"NURSE,EIGHT\", \"enteredById\": 20171, \"enteredByResId\": \"V-500-200-20171\", \"enteredInError\": \"\", \"enteredInErrorCd\": \"\", \"errorEnteredBy\": \"\", \"errorEnteredById\": \"\", \"hospitalLocation\": \"GEN MED\", \"hospitalLocationId\": 9, \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"rate\": \"105\\/59\", \"resourceId\": \"V-500-120.5-24027\", \"resourceType\": \"Observation\", \"supplementalO2\": \"\", \"vitalType\": \"BLOOD PRESSURE\", \"vitalTypeId\": 1, \"vitalTypeSCT\": 75367002, \"vitalTypeSc\": \"Blood pressure\", \"vitalsIen\": 24027 } }, { \"Vitals\": { \"dateTimeVitalsEntered\": \"FEB 1,2010@11:38:01\", \"dateTimeVitalsEnteredFHIR\": \"2010-02-01T11:38:01-05:00\", \"dateTimeVitalsEnteredFM\": 3100201.113801, \"dateTimeVitalsEnteredHL7\": \"20100201113801-0500\", \"dateTimeVitalsTaken\": \"FEB 1,2010@11:38:01\", \"dateTimeVitalsTakenFHIR\": \"2010-02-01T11:38:01-05:00\", \"dateTimeVitalsTakenFM\": 3100201.113801, \"dateTimeVitalsTakenHL7\": \"20100201113801-0500\", \"enteredBy\": \"NURSE,EIGHT\", \"enteredById\": 20171, \"enteredByResId\": \"V-500-200-20171\", \"enteredInError\": \"\", \"enteredInErrorCd\": \"\", \"errorEnteredBy\": \"\", \"errorEnteredById\": \"\", \"hospitalLocation\": \"GEN MED\", \"hospitalLocationId\": 9, \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"rate\": 101.1, \"resourceId\": \"V-500-120.5-24028\", \"resourceType\": \"Observation\", \"supplementalO2\": \"\", \"vitalType\": \"TEMPERATURE\", \"vitalTypeId\": 2, \"vitalTypeSCT\": 386725007, \"vitalTypeSc\": \"Temperature\", \"vitalsIen\": 24028 } }, { \"Vitals\": { \"dateTimeVitalsEntered\": \"FEB 1,2010@11:38:02\", \"dateTimeVitalsEnteredFHIR\": \"2010-02-01T11:38:02-05:00\", \"dateTimeVitalsEnteredFM\": 3100201.113802, \"dateTimeVitalsEnteredHL7\": \"20100201113802-0500\", \"dateTimeVitalsTaken\": \"FEB 1,2010@11:38:02\", \"dateTimeVitalsTakenFHIR\": \"2010-02-01T11:38:02-05:00\", \"dateTimeVitalsTakenFM\": 3100201.113802, \"dateTimeVitalsTakenHL7\": \"20100201113802-0500\", \"enteredBy\": \"NURSE,EIGHT\", \"enteredById\": 20171, \"enteredByResId\": \"V-500-200-20171\", \"enteredInError\": \"\", \"enteredInErrorCd\": \"\", \"errorEnteredBy\": \"\", \"errorEnteredById\": \"\", \"hospitalLocation\": \"GEN MED\", \"hospitalLocationId\": 9, \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"rate\": 195, \"resourceId\": \"V-500-120.5-24029\", \"resourceType\": \"Observation\", \"supplementalO2\": \"\", \"vitalType\": \"WEIGHT\", \"vitalTypeId\": 9, \"vitalTypeSCT\": 27113001, \"vitalTypeSc\": \"Weight\", \"vitalsIen\": 24029 } }, { \"Vitals\": { \"dateTimeVitalsEntered\": \"FEB 1,2010@11:38:03\", \"dateTimeVitalsEnteredFHIR\": \"2010-02-01T11:38:03-05:00\", \"dateTimeVitalsEnteredFM\": 3100201.113803, \"dateTimeVitalsEnteredHL7\": \"20100201113803-0500\", \"dateTimeVitalsTaken\": \"FEB 1,2010@11:38:03\", \"dateTimeVitalsTakenFHIR\": \"2010-02-01T11:38:03-05:00\", \"dateTimeVitalsTakenFM\": 3100201.113803, \"dateTimeVitalsTakenHL7\": \"20100201113803-0500\", \"enteredBy\": \"NURSE,EIGHT\", \"enteredById\": 20171, \"enteredByResId\": \"V-500-200-20171\", \"enteredInError\": \"\", \"enteredInErrorCd\": \"\", \"errorEnteredBy\": \"\", \"errorEnteredById\": \"\", \"hospitalLocation\": \"GEN MED\", \"hospitalLocationId\": 9, \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"rate\": 72, \"resourceId\": \"V-500-120.5-24030\", \"resourceType\": \"Observation\", \"supplementalO2\": \"\", \"vitalType\": \"HEIGHT\", \"vitalTypeId\": 8, \"vitalTypeSCT\": 50373000, \"vitalTypeSc\": \"Height\", \"vitalsIen\": 24030 } }, { \"Vitals\": { \"dateTimeVitalsEntered\": \"FEB 1,2010@11:38\", \"dateTimeVitalsEnteredFHIR\": \"2010-02-01T11:38:00-05:00\", \"dateTimeVitalsEnteredFM\": 3100201.1138, \"dateTimeVitalsEnteredHL7\": \"201002011138-0500\", \"dateTimeVitalsTaken\": \"FEB 1,2010@11:38\", \"dateTimeVitalsTakenFHIR\": \"2010-02-01T11:38:00-05:00\", \"dateTimeVitalsTakenFM\": 3100201.1138, \"dateTimeVitalsTakenHL7\": \"201002011138-0500\", \"enteredBy\": \"NURSE,EIGHT\", \"enteredById\": 20171, \"enteredByResId\": \"V-500-200-20171\", \"enteredInError\": \"\", \"enteredInErrorCd\": \"\", \"errorEnteredBy\": \"\", \"errorEnteredById\": \"\", \"hospitalLocation\": \"GEN MED\", \"hospitalLocationId\": 9, \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"rate\": 96, \"resourceId\": \"V-500-120.5-24031\", \"resourceType\": \"Observation\", \"supplementalO2\": \"\", \"vitalType\": \"PULSE\", \"vitalTypeId\": 5, \"vitalTypeSCT\": 78564009, \"vitalTypeSc\": \"Pulse\", \"vitalsIen\": 24031 } } ] }";

        ObservationParser parser = new ObservationParser();

        List<Observation> result = parser.parseVitalsList(input);

        Assert.assertEquals("Correct number of items", 5, result.size());

        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ssX");
        Date expectedDate = sdf.parse("2010-02-01T11:38:00-05:00");
        Assert.assertEquals("Correct issued date and time", expectedDate, result.get(0).getIssued());
        Assert.assertEquals("Correct organization reference", true, result.get(0).getPerformer().get(1).getReference().startsWith("/Organization"));
        Assert.assertEquals("Correct organization system", HcConstants.URN_VISTA_ORGANIZATION, result.get(0).getPerformer().get(1).getIdentifier().getSystem());
    }

    @Test
    public void TestInvalidLabsObservationParse () {

        String input = "-1^Patientidentifiernotrecognised";

        ObservationParser parser = new ObservationParser();

        List<Observation> result = parser.parseLabsList(input);

        Assert.assertTrue(result.isEmpty());
    }

    @Test
    public void TestSuccessfulLabsObservationParse()  throws ParseException {
        String input = "{ \"Labs\": [ { \"Lab\": { \"aboGroup\": \"\", \"aboGroupCd\": \"\", \"chemHemToxRiaSerEtcs\": { \"chemHemToxRiaSerEtc\": [ { \"accession\": \"CH 0527 1\", \"accessioningInstitution\": \"CAMP MASTER\", \"accessioningInstitutionId\": 500, \"collectingSite\": \"\", \"collectingSiteId\": \"\", \"criticalHigh\": \"\", \"criticalLow\": \"\", \"dateReportCompleted\": \"MAY 27,2015@14:01:19\", \"dateReportCompletedFHIR\": \"2015-05-27T14:01:19-05:00\", \"dateReportCompletedFM\": 3150527.140119, \"dateReportCompletedHL7\": \"20150527140119-0500\", \"dateTimeObtainedInexact\": \"\", \"dateTimeObtainedInexactCd\": \"\", \"dateTimeSpecimenTaken\": \"FEB 26,2015@12:34\", \"dateTimeSpecimenTakenFHIR\": \"2015-02-26T12:34:00-05:00\", \"dateTimeSpecimenTakenFM\": 3150226.1234, \"dateTimeSpecimenTakenHL7\": \"201502261234-0500\", \"flag\": \"\", \"hostUid\": \"\", \"labTestId\": 173, \"labTestName\": \"CREATININE\", \"loincCode\": \"2161-8\", \"loincName\": \"CREATININE:MCNC:PT:URINE:QN:\", \"methodOrSite\": \"\", \"orderingSite\": \"\", \"orderingSiteId\": \"\", \"orderingSiteUid\": \"\", \"referenceHigh\": 370, \"referenceLow\": 20, \"releasingSite\": \"CAMP MASTER\", \"releasingSiteId\": 500, \"requestingLocDiv\": \"NURSING\", \"requestingLocDivId\": \"183;SC(\", \"requestingLocation\": \"NO ABRV\", \"requestingPerson\": \"PROVIDER,NINETYNINE\", \"requestingPersonId\": 9024, \"requestingPersonResId\": \"V-500-200-988\", \"resourceId\": \"V-500-63-665-63.04-6849772.8766\", \"result\": 150, \"specimenType\": \"URINE\", \"specimenTypeId\": 71, \"sumReportNum\": \"\", \"typography\": \"URINE\", \"typographyId\": 71, \"uid\": \"L651470001\", \"units\": \"mg\\/dL\", \"verifyPerson\": \"PROGRAMMER,FIVE\", \"verifyPersonId\": 119, \"volume\": \"\", \"workloadCd\": \"82565.0000\", \"workloadProcedure\": \"Creatinine\" }, { \"accession\": \"CH 0527 3\", \"accessioningInstitution\": \"CAMP MASTER\", \"accessioningInstitutionId\": 500, \"collectingSite\": \"\", \"collectingSiteId\": \"\", \"criticalHigh\": \"\", \"criticalLow\": \"\", \"dateReportCompleted\": \"MAY 27,2015@15:00:31\", \"dateReportCompletedFHIR\": \"2015-05-27T15:00:31-05:00\", \"dateReportCompletedFM\": 3150527.150031, \"dateReportCompletedHL7\": \"20150527150031-0500\", \"dateTimeObtainedInexact\": \"\", \"dateTimeObtainedInexactCd\": \"\", \"dateTimeSpecimenTaken\": \"JAN 1,2012@14:56\", \"dateTimeSpecimenTakenFHIR\": \"2012-01-01T14:56:00-05:00\", \"dateTimeSpecimenTakenFM\": 3120101.1456, \"dateTimeSpecimenTakenHL7\": \"201201011456-0500\", \"flag\": \"\", \"hostUid\": \"\", \"labTestId\": 5154, \"labTestName\": \"CHOLESTEROL\\/HDL RATIO\", \"loincCode\": \"9830-1\", \"loincName\": \"CHOLESTEROL.TOTAL\\/CHOLESTEROL.IN HDL:MRTO:PT:SER\\/PLAS:QN:\", \"methodOrSite\": \"\", \"orderingSite\": \"\", \"orderingSiteId\": \"\", \"orderingSiteUid\": \"\", \"referenceHigh\": 5, \"referenceLow\": 0, \"releasingSite\": \"CAMP MASTER\", \"releasingSiteId\": 500, \"requestingLocDiv\": \"PRIMARY CARE\", \"requestingLocDivId\": \"32;SC(\", \"requestingLocation\": \"PCM\", \"requestingPerson\": \"PROVIDER,NINETYNINE\", \"requestingPersonId\": 9024, \"requestingPersonResId\": \"V-500-200-988\", \"resourceId\": \"V-500-63-665-63.04-6879897.8544\", \"result\": 3.5, \"specimenType\": \"SERUM\", \"specimenTypeId\": 72, \"sumReportNum\": \"\", \"typography\": \"SERUM\", \"typographyId\": 72, \"uid\": \"L651470003\", \"units\": \"ratio\", \"verifyPerson\": \"PROGRAMMER,FIVE\", \"verifyPersonId\": 119, \"volume\": \"\", \"workloadCd\": \"81323.0000\", \"workloadProcedure\": \"Gen Chem Specimen\" } ] }, \"doNotTransfuse\": \"\", \"doNotTransfuseCd\": \"\", \"hospitalId\": \"666-66-9997\", \"labsIen\": 665, \"lrDfn\": 665, \"patientIcn\": \"5000000364V598024\", \"patientName\": \"TRASH,TONY\", \"patientNameId\": 100860, \"resourceId\": \"V-500-63-665\", \"resourceType\": \"Laboratory\", \"rhType\": \"\", \"rhTypeCd\": \"\" } } ] }";

        ObservationParser parser = new ObservationParser();

        List<Observation> result = parser.parseLabsList(input);

        Assert.assertEquals("Correct number of items", 2, result.size());

        Quantity value = (Quantity) result.get(0).getValue();
        Assert.assertEquals("Correct value", "150.0", value.getValue().toString());
        Assert.assertEquals("Correct units", "mg/dL", value.getUnit());

        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ssX");
        Date expectedDate = sdf.parse("2015-05-27T14:01:19-05:00");
        Assert.assertEquals("Correct issued date and time", expectedDate, result.get(0).getIssued());
    }

    @Test
    public void TestLabsObservationParseOrgBug()  throws ParseException {
        String input = "{ \"Labs\": [ { \"Lab\": { \"aboGroup\": \"\", \"aboGroupCd\": \"\", \"chemHemToxRiaSerEtcs\": { \"chemHemToxRiaSerEtc\": [ { \"accession\": \"CH 0527 1\", \"accessioningInstitution\": \"CAMP MASTER\", \"accessioningInstitutionId\": 500, \"collectingSite\": \"\", \"collectingSiteId\": \"\", \"criticalHigh\": \"\", \"criticalLow\": \"\", \"dateReportCompleted\": \"MAY 27,2015@14:01:19\", \"dateReportCompletedFHIR\": \"2015-05-27T14:01:19-05:00\", \"dateReportCompletedFM\": 3150527.140119, \"dateReportCompletedHL7\": \"20150527140119-0500\", \"dateTimeObtainedInexact\": \"\", \"dateTimeObtainedInexactCd\": \"\", \"dateTimeSpecimenTaken\": \"FEB 26,2015@12:34\", \"dateTimeSpecimenTakenFHIR\": \"2015-02-26T12:34:00-05:00\", \"dateTimeSpecimenTakenFM\": 3150226.1234, \"dateTimeSpecimenTakenHL7\": \"201502261234-0500\", \"flag\": \"\", \"hostUid\": \"\", \"labTestId\": 173, \"labTestName\": \"CREATININE\", \"loincCode\": \"2161-8\", \"loincName\": \"CREATININE:MCNC:PT:URINE:QN:\", \"methodOrSite\": \"\", \"orderingSite\": \"\", \"orderingSiteId\": \"\", \"orderingSiteUid\": \"\", \"referenceHigh\": 370, \"referenceLow\": 20, \"releasingSite\": \"CAMP MASTER\", \"releasingSiteId\": 500, \"requestingLocDiv\": \"NURSING\", \"requestingLocDivId\": \"183;SC(\", \"requestingLocation\": \"NO ABRV\", \"requestingPerson\": \"PROVIDER,NINETYNINE\", \"requestingPersonId\": 9024, \"requestingPersonResId\": \"V-500-200-988\", \"resourceId\": \"V-500-63-665-63.04-6849772.8766\", \"result\": 150, \"specimenType\": \"URINE\", \"specimenTypeId\": 71, \"sumReportNum\": \"\", \"typography\": \"URINE\", \"typographyId\": 71, \"uid\": \"L651470001\", \"units\": \"mg\\/dL\", \"verifyPerson\": \"PROGRAMMER,FIVE\", \"verifyPersonId\": 119, \"volume\": \"\", \"workloadCd\": \"82565.0000\", \"workloadProcedure\": \"Creatinine\" }, { \"accession\": \"CH 0527 3\", \"accessioningInstitution\": \"CAMP MASTER\", \"accessioningInstitutionId\": 500, \"collectingSite\": \"\", \"collectingSiteId\": \"\", \"criticalHigh\": \"\", \"criticalLow\": \"\", \"dateReportCompleted\": \"MAY 27,2015@15:00:31\", \"dateReportCompletedFHIR\": \"2015-05-27T15:00:31-05:00\", \"dateReportCompletedFM\": 3150527.150031, \"dateReportCompletedHL7\": \"20150527150031-0500\", \"dateTimeObtainedInexact\": \"\", \"dateTimeObtainedInexactCd\": \"\", \"dateTimeSpecimenTaken\": \"JAN 1,2012@14:56\", \"dateTimeSpecimenTakenFHIR\": \"2012-01-01T14:56:00-05:00\", \"dateTimeSpecimenTakenFM\": 3120101.1456, \"dateTimeSpecimenTakenHL7\": \"201201011456-0500\", \"flag\": \"\", \"hostUid\": \"\", \"labTestId\": 5154, \"labTestName\": \"CHOLESTEROL\\/HDL RATIO\", \"loincCode\": \"9830-1\", \"loincName\": \"CHOLESTEROL.TOTAL\\/CHOLESTEROL.IN HDL:MRTO:PT:SER\\/PLAS:QN:\", \"methodOrSite\": \"\", \"orderingSite\": \"\", \"orderingSiteId\": \"\", \"orderingSiteUid\": \"\", \"referenceHigh\": 5, \"referenceLow\": 0, \"releasingSite\": \"CAMP MASTER\", \"releasingSiteId\": 500, \"requestingLocDiv\": \"PRIMARY CARE\", \"requestingLocDivId\": \"32;SC(\", \"requestingLocation\": \"PCM\", \"requestingPerson\": \"PROVIDER,NINETYNINE\", \"requestingPersonId\": 9024, \"requestingPersonResId\": \"V-500-200-988\", \"resourceId\": \"V-500-63-665-63.04-6879897.8544\", \"result\": 3.5, \"specimenType\": \"SERUM\", \"specimenTypeId\": 72, \"sumReportNum\": \"\", \"typography\": \"SERUM\", \"typographyId\": 72, \"uid\": \"L651470003\", \"units\": \"ratio\", \"verifyPerson\": \"PROGRAMMER,FIVE\", \"verifyPersonId\": 119, \"volume\": \"\", \"workloadCd\": \"81323.0000\", \"workloadProcedure\": \"Gen Chem Specimen\" } ] }, \"doNotTransfuse\": \"\", \"doNotTransfuseCd\": \"\", \"hospitalId\": \"666-66-9997\", \"labsIen\": 665, \"lrDfn\": 665, \"patientIcn\": \"5000000364V598024\", \"patientName\": \"TRASH,TONY\", \"patientNameId\": 100860, \"resourceId\": \"V-500-63-665\", \"resourceType\": \"Laboratory\", \"rhType\": \"\", \"rhTypeCd\": \"\" } } ] }";

        ObservationParser parser = new ObservationParser();

        List<Observation> result = parser.parseLabsList(input);

        Assert.assertEquals("Correct number of items", 2, result.size());

        Assert.assertEquals("Correct organization reference", true, result.get(0).getPerformer().get(1).getReference().startsWith("/Organization"));
        Assert.assertEquals("Correct organization system", HcConstants.URN_VISTA_ORGANIZATION, result.get(0).getPerformer().get(1).getIdentifier().getSystem());
    }

    @Test
    public void TestStupidFormatProblem()  throws ParseException {
        String input = "2019-09-23";
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
        Date actualDate = sdf.parse(input);
        sdf = new SimpleDateFormat("yyyyMMddHHmm");
        Date expectedDate = sdf.parse(input);
        Assert.assertNotEquals("Correct date and time", expectedDate, actualDate);
    }


    @Test
    public void TestLabsObservationParseTextValue() {
        String input = "{ \"Labs\": [ { \"Lab\": { \"aboGroup\": \"\", \"aboGroupCd\": \"\", \"chemHemToxRiaSerEtcs\": { \"chemHemToxRiaSerEtc\": [ { \"accession\": \"CH 0527 1\", \"accessioningInstitution\": \"CAMP MASTER\", \"accessioningInstitutionId\": 500, \"collectingSite\": \"\", \"collectingSiteId\": \"\", \"criticalHigh\": \"\", \"criticalLow\": \"\", \"dateReportCompleted\": \"MAY 27,2015@14:01:19\", \"dateReportCompletedFHIR\": \"2015-05-27T14:01:19-05:00\", \"dateReportCompletedFM\": 3150527.140119, \"dateReportCompletedHL7\": \"20150527140119-0500\", \"dateTimeObtainedInexact\": \"\", \"dateTimeObtainedInexactCd\": \"\", \"dateTimeSpecimenTaken\": \"FEB 26,2015@12:34\", \"dateTimeSpecimenTakenFHIR\": \"2015-02-26T12:34:00-05:00\", \"dateTimeSpecimenTakenFM\": 3150226.1234, \"dateTimeSpecimenTakenHL7\": \"201502261234-0500\", \"flag\": \"\", \"hostUid\": \"\", \"labTestId\": 173, \"labTestName\": \"CREATININE\", \"loincCode\": \"2161-8\", \"loincName\": \"CREATININE:MCNC:PT:URINE:QN:\", \"methodOrSite\": \"\", \"orderingSite\": \"\", \"orderingSiteId\": \"\", \"orderingSiteUid\": \"\", \"referenceHigh\": 370, \"referenceLow\": 20, \"releasingSite\": \"CAMP MASTER\", \"releasingSiteId\": 500, \"requestingLocDiv\": \"NURSING\", \"requestingLocDivId\": \"183;SC(\", \"requestingLocation\": \"NO ABRV\", \"requestingPerson\": \"PROVIDER,NINETYNINE\", \"requestingPersonId\": 9024, \"requestingPersonResId\": \"V-500-200-988\", \"resourceId\": \"V-500-63-665-63.04-6849772.8766\", \"result\": \"POS\", \"specimenType\": \"URINE\", \"specimenTypeId\": 71, \"sumReportNum\": \"\", \"typography\": \"URINE\", \"typographyId\": 71, \"uid\": \"L651470001\", \"units\": \"\", \"verifyPerson\": \"PROGRAMMER,FIVE\", \"verifyPersonId\": 119, \"volume\": \"\", \"workloadCd\": \"82565.0000\", \"workloadProcedure\": \"Creatinine\" }, { \"accession\": \"CH 0527 3\", \"accessioningInstitution\": \"CAMP MASTER\", \"accessioningInstitutionId\": 500, \"collectingSite\": \"\", \"collectingSiteId\": \"\", \"criticalHigh\": \"\", \"criticalLow\": \"\", \"dateReportCompleted\": \"MAY 27,2015@15:00:31\", \"dateReportCompletedFHIR\": \"2015-05-27T15:00:31-05:00\", \"dateReportCompletedFM\": 3150527.150031, \"dateReportCompletedHL7\": \"20150527150031-0500\", \"dateTimeObtainedInexact\": \"\", \"dateTimeObtainedInexactCd\": \"\", \"dateTimeSpecimenTaken\": \"JAN 1,2012@14:56\", \"dateTimeSpecimenTakenFHIR\": \"2012-01-01T14:56:00-05:00\", \"dateTimeSpecimenTakenFM\": 3120101.1456, \"dateTimeSpecimenTakenHL7\": \"201201011456-0500\", \"flag\": \"\", \"hostUid\": \"\", \"labTestId\": 5154, \"labTestName\": \"CHOLESTEROL\\/HDL RATIO\", \"loincCode\": \"9830-1\", \"loincName\": \"CHOLESTEROL.TOTAL\\/CHOLESTEROL.IN HDL:MRTO:PT:SER\\/PLAS:QN:\", \"methodOrSite\": \"\", \"orderingSite\": \"\", \"orderingSiteId\": \"\", \"orderingSiteUid\": \"\", \"referenceHigh\": 5, \"referenceLow\": 0, \"releasingSite\": \"CAMP MASTER\", \"releasingSiteId\": 500, \"requestingLocDiv\": \"PRIMARY CARE\", \"requestingLocDivId\": \"32;SC(\", \"requestingLocation\": \"PCM\", \"requestingPerson\": \"PROVIDER,NINETYNINE\", \"requestingPersonId\": 9024,\"requestingPersonResId\": \"V-500-200-988\", \"resourceId\": \"V-500-63-665-63.04-6879897.8544\", \"result\": 3.5, \"specimenType\": \"SERUM\", \"specimenTypeId\": 72, \"sumReportNum\": \"\", \"typography\": \"SERUM\", \"typographyId\": 72, \"uid\": \"L651470003\", \"units\": \"ratio\", \"verifyPerson\": \"PROGRAMMER,FIVE\", \"verifyPersonId\": 119, \"volume\": \"\", \"workloadCd\": \"81323.0000\", \"workloadProcedure\": \"Gen Chem Specimen\" } ] }, \"doNotTransfuse\": \"\", \"doNotTransfuseCd\": \"\", \"hospitalId\": \"666-66-9997\", \"labsIen\": 665, \"lrDfn\": 665, \"patientIcn\": \"5000000364V598024\", \"patientName\": \"TRASH,TONY\", \"patientNameId\": 100860, \"resourceId\": \"V-500-63-665\", \"resourceType\": \"Laboratory\", \"rhType\": \"\", \"rhTypeCd\": \"\" } } ] }";

        ObservationParser parser = new ObservationParser();

        List<Observation> result = parser.parseLabsList(input);

        Assert.assertEquals("Correct number of items", 2, result.size());
        Assert.assertEquals("Correct value of non-numeric result", "POS", result.get(0).getValue().toString());
    }

    @Test
    public void TestLabsObservationParseMissingReference() {
        String input = "{ \"Labs\": [ { \"Lab\": { \"aboGroup\": \"\", \"aboGroupCd\": \"\", \"chemHemToxRiaSerEtcs\": { \"chemHemToxRiaSerEtc\": [ { \"accession\": \"CH 0527 1\", \"accessioningInstitution\": \"CAMP MASTER\", \"accessioningInstitutionId\": 500, \"collectingSite\": \"\", \"collectingSiteId\": \"\", \"criticalHigh\": \"\", \"criticalLow\": \"\", \"dateReportCompleted\": \"MAY 27,2015@14:01:19\", \"dateReportCompletedFHIR\": \"2015-05-27T14:01:19-05:00\", \"dateReportCompletedFM\": 3150527.140119, \"dateReportCompletedHL7\": \"20150527140119-0500\", \"dateTimeObtainedInexact\": \"\", \"dateTimeObtainedInexactCd\": \"\", \"dateTimeSpecimenTaken\": \"FEB 26,2015@12:34\", \"dateTimeSpecimenTakenFHIR\": \"2015-02-26T12:34:00-05:00\", \"dateTimeSpecimenTakenFM\": 3150226.1234, \"dateTimeSpecimenTakenHL7\": \"201502261234-0500\", \"flag\": \"\", \"hostUid\": \"\", \"labTestId\": 173, \"labTestName\": \"CREATININE\", \"loincCode\": \"2161-8\", \"loincName\": \"CREATININE:MCNC:PT:URINE:QN:\", \"methodOrSite\": \"\", \"orderingSite\": \"\", \"orderingSiteId\": \"\", \"orderingSiteUid\": \"\", \"referenceHigh\": \"\", \"referenceLow\": \"\", \"releasingSite\": \"CAMP MASTER\", \"releasingSiteId\": 500, \"requestingLocDiv\": \"NURSING\", \"requestingLocDivId\": \"183;SC(\", \"requestingLocation\": \"NO ABRV\", \"requestingPerson\": \"PROVIDER,NINETYNINE\", \"requestingPersonId\": 9024, \"requestingPersonResId\": \"V-500-200-988\", \"resourceId\": \"V-500-63-665-63.04-6849772.8766\", \"result\": 150, \"specimenType\": \"URINE\", \"specimenTypeId\": 71, \"sumReportNum\": \"\", \"typography\": \"URINE\", \"typographyId\": 71, \"uid\": \"L651470001\", \"units\": \"mg\\/dL\", \"verifyPerson\": \"PROGRAMMER,FIVE\", \"verifyPersonId\": 119, \"volume\": \"\", \"workloadCd\": \"82565.0000\", \"workloadProcedure\": \"Creatinine\" }, { \"accession\": \"CH 0527 3\", \"accessioningInstitution\": \"CAMP MASTER\", \"accessioningInstitutionId\": 500, \"collectingSite\": \"\", \"collectingSiteId\": \"\", \"criticalHigh\": \"\", \"criticalLow\": \"\", \"dateReportCompleted\": \"MAY 27,2015@15:00:31\", \"dateReportCompletedFHIR\": \"2015-05-27T15:00:31-05:00\", \"dateReportCompletedFM\": 3150527.150031, \"dateReportCompletedHL7\": \"20150527150031-0500\", \"dateTimeObtainedInexact\": \"\", \"dateTimeObtainedInexactCd\": \"\", \"dateTimeSpecimenTaken\": \"JAN 1,2012@14:56\", \"dateTimeSpecimenTakenFHIR\": \"2012-01-01T14:56:00-05:00\", \"dateTimeSpecimenTakenFM\": 3120101.1456, \"dateTimeSpecimenTakenHL7\": \"201201011456-0500\", \"flag\": \"\", \"hostUid\": \"\", \"labTestId\": 5154, \"labTestName\": \"CHOLESTEROL\\/HDL RATIO\", \"loincCode\": \"9830-1\", \"loincName\": \"CHOLESTEROL.TOTAL\\/CHOLESTEROL.IN HDL:MRTO:PT:SER\\/PLAS:QN:\", \"methodOrSite\": \"\", \"orderingSite\": \"\", \"orderingSiteId\": \"\", \"orderingSiteUid\": \"\", \"referenceHigh\": 5, \"referenceLow\": 0, \"releasingSite\": \"CAMP MASTER\", \"releasingSiteId\": 500, \"requestingLocDiv\": \"PRIMARY CARE\", \"requestingLocDivId\": \"32;SC(\", \"requestingLocation\": \"PCM\", \"requestingPerson\": \"PROVIDER,NINETYNINE\", \"requestingPersonId\": 9024, \"requestingPersonResId\": \"V-500-200-988\", \"resourceId\": \"V-500-63-665-63.04-6879897.8544\", \"result\": 3.5, \"specimenType\": \"SERUM\", \"specimenTypeId\": 72, \"sumReportNum\": \"\", \"typography\": \"SERUM\", \"typographyId\": 72, \"uid\": \"L651470003\", \"units\": \"ratio\", \"verifyPerson\": \"PROGRAMMER,FIVE\", \"verifyPersonId\": 119, \"volume\": \"\", \"workloadCd\": \"81323.0000\", \"workloadProcedure\": \"Gen Chem Specimen\" } ] }, \"doNotTransfuse\": \"\", \"doNotTransfuseCd\": \"\", \"hospitalId\": \"666-66-9997\", \"labsIen\": 665, \"lrDfn\": 665, \"patientIcn\": \"5000000364V598024\", \"patientName\": \"TRASH,TONY\", \"patientNameId\": 100860, \"resourceId\": \"V-500-63-665\", \"resourceType\": \"Laboratory\", \"rhType\": \"\", \"rhTypeCd\": \"\" } } ] }";

        ObservationParser parser = new ObservationParser();

        List<Observation> result = parser.parseLabsList(input);

        Assert.assertEquals("Correct number of items", 2, result.size());
        Assert.assertEquals("No reference range on first record", 0, result.get(0).getReferenceRange().size());
        Assert.assertEquals("Reference range exists on second record", 1, result.get(1).getReferenceRange().size());
    }

    @Test
    public void TestInvalidMentalHealthObservationParse () {
        String input = "-1^Patientidentifiernotrecognised";

        ObservationParser parser = new ObservationParser();

        List<Observation> result = parser.parseMentalHealthList(input);

        Assert.assertTrue(result.isEmpty());
    }

    @Test
    public void TestEmptyMentalHealthObservationParse () {
        String input = "";

        ObservationParser parser = new ObservationParser();

        List<Observation> result = parser.parseMentalHealthList(input);

        Assert.assertTrue(result.isEmpty());
    }

    @Test
    public void TestSuccessfulMentalHealthObservationParse() throws ParseException {
        String input = "{ \"Observations\": [ { \"Mhdiag\": { \"axis5-GAF\": 65, \"condition\": \"\", \"conditionCd\": \"\", \"dateTimeOfDiagnosis\": \"SEP 10,2014\", \"dateTimeOfDiagnosisFHIR\": \"2014-09-10\", \"dateTimeOfDiagnosisFM\": 3140910, \"dateTimeOfDiagnosisHL7\": 20140910, \"diagnosis\": \"\", \"diagnosisBy\": \"PROVIDER,SEVEN\", \"diagnosisById\": 990, \"diagnosisByNPI\": \"\", \"diagnosisId\": \"\", \"diagnosisSCT\": \"\", \"dxls\": \"\", \"dxlsCd\": \"\", \"fileEntryDate\": \"JUN 10,2015@14:17\", \"fileEntryDateFHIR\": \"2015-06-10T14:17:00-05:00\", \"fileEntryDateFM\": 3150610.1417, \"fileEntryDateHL7\": \"201506101417-0500\", \"inactivatedDate\": \"\", \"inactivatedDateFHIR\": \"\", \"inactivatedDateFM\": \"\", \"inactivatedDateHL7\": \"\", \"mhdiagIen\": 172, \"patientICN\": \"5000000352V586511\", \"patientName\": \"EHMP,FIVE\", \"patientNameId\": 100848, \"patientType\": \"In-Patient\", \"patientTypeCd\": \"I\", \"psychosocialStressor\": \"\", \"resourceId\": \"V-500-627.8-172\", \"resourceType\": \"Observation\", \"severityCode\": \"\", \"severityCodeCd\": \"\", \"statusChanged\": \"\", \"statusChangedCd\": \"\", \"statusVPRINRu\": \"\", \"statusVPRINRuCd\": \"\", \"transcriber\": \"PROVIDER,SEVEN\", \"transcriberId\": 990 } }, { \"Mhadm\": { \"administeredBy\": \"PROVIDER,SEVEN\", \"administeredById\": 990, \"administeredByResId\": \"V-500-601.84-990\", \"administeredByNPI\": \"\", \"administrationNumber\": 100007, \"comments\": \"\", \"dateGiven\": \"AUG 31,2014@14:00\", \"dateGivenFHIR\": \"2014-08-31T14:00:00-05:00\", \"dateGivenFM\": 3140831.14, \"dateGivenHL7\": \"201408311400-0500\", \"dateSaved\": \"AUG 31,2014@14:03\", \"dateSavedFHIR\": \"2014-08-31T14:03:00-05:00\", \"dateSavedFM\": 3140831.1403, \"dateSavedHL7\": \"201408311403-0500\", \"instrumentName\": \"PHQ-2\", \"instrumentNameId\": 71, \"isComplete\": \"Yes\", \"isCompleteCd\": \"Y\", \"location\": \"PRIMARY CARE\", \"locationId\": 32, \"loincCode\": \"55758-7\", \"mhadmIen\": 100007, \"numberOfQuestionsAnswered\": 2, \"orderedBy\": \"PROVIDER,SEVEN\", \"orderedById\": 990, \"orderedByNPI\": \"\", \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"resourceId\": \"V-500-601.84-100007\", \"resourceType\": \"Observation\", \"results\": { \"Mhres\": { \"administration\": 100007, \"administrationId\": 100007, \"instrument\": \"PHQ-2\", \"mhresIen\": 100007, \"rawScore\": 4, \"resourceId\": \"V-500-601.92-100007\", \"resourceType\": \"Observation\", \"resultId\": 100007, \"scale\": \"Depression\", \"transformedScore1\": \"\", \"transformedScore2\": \"\", \"transformedScore3\": \"\" } }, \"sctPreferredTerm\": \"Assessment using PHQ-2 questionnaire\", \"signed\": \"No\", \"signedCd\": \"N\", \"snomedCode\": 454711000124102, \"transmissionStatus\": \"\", \"transmissionStatusCd\": \"\", \"transmissionTime\": \"\", \"transmissionTimeFHIR\": \"\", \"transmissionTimeFM\": \"\", \"transmissionTimeHL7\": \"\" } }, { \"Mhadm\": { \"administeredBy\": \"PROVIDER,SEVEN\", \"administeredById\": 990, \"administeredByResId\": \"V-500-601.84-990\", \"administeredByNPI\": \"\", \"administrationNumber\": 100008, \"comments\": \"\", \"dateGiven\": \"AUG 31,2014@14:00\", \"dateGivenFHIR\": \"2014-08-31T14:00:00-05:00\", \"dateGivenFM\": 3140831.14, \"dateGivenHL7\": \"201408311400-0500\", \"dateSaved\": \"AUG 31,2014@14:04\", \"dateSavedFHIR\": \"2014-08-31T14:04:00-05:00\", \"dateSavedFM\": 3140831.1404, \"dateSavedHL7\": \"201408311404-0500\", \"instrumentName\": \"PHQ9\", \"instrumentNameId\": 42, \"isComplete\": \"Yes\", \"isCompleteCd\": \"Y\", \"location\": \"PRIMARY CARE\", \"locationId\": 32, \"loincCode\": \"44249-1\", \"mhadmIen\": 100008, \"numberOfQuestionsAnswered\": 10, \"orderedBy\": \"PROVIDER,SEVEN\", \"orderedById\": 990, \"orderedByNPI\": \"\", \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"resourceId\": \"V-500-601.84-100008\", \"resourceType\": \"Observation\", \"results\": { \"Mhres\": { \"administration\": 100008, \"administrationId\": 100008, \"instrument\": \"PHQ9\", \"mhresIen\": 100008, \"rawScore\": 7, \"resourceId\": \"V-500-601.92-100008\", \"resourceType\": \"Observation\", \"resultId\": 100008, \"scale\": \"Total\", \"transformedScore1\": \"\", \"transformedScore2\": \"\", \"transformedScore3\": \"\" } }, \"sctPreferredTerm\": \"Depression screening using PHQ-9 (Patient Health Questionnaire 9) score\", \"signed\": \"No\", \"signedCd\": \"N\", \"snomedCode\": 715252007, \"transmissionStatus\": \"\", \"transmissionStatusCd\": \"\", \"transmissionTime\": \"\", \"transmissionTimeFHIR\": \"\", \"transmissionTimeFM\": \"\", \"transmissionTimeHL7\": \"\" } }, { \"Mhadm\": { \"administeredBy\": \"PROVIDER,SEVEN\", \"administeredById\": 990, \"administeredByResId\": \"V-500-601.84-990\", \"administeredByNPI\": \"\", \"administrationNumber\": 100009, \"comments\": \"\", \"dateGiven\": \"AUG 31,2014@14:00\", \"dateGivenFHIR\": \"2014-08-31T14:00:00-05:00\", \"dateGivenFM\": 3140831.14, \"dateGivenHL7\": \"201408311400-0500\", \"dateSaved\": \"AUG 31,2014@14:05\", \"dateSavedFHIR\": \"2014-08-31T14:05:00-05:00\", \"dateSavedFM\": 3140831.1405, \"dateSavedHL7\": \"201408311405-0500\", \"instrumentName\": \"AUDC\", \"instrumentNameId\": 5, \"isComplete\": \"Yes\", \"isCompleteCd\": \"Y\", \"location\": \"PRIMARY CARE\", \"locationId\": 32, \"loincCode\": \"\", \"mhadmIen\": 100009, \"numberOfQuestionsAnswered\": 3, \"orderedBy\": \"PROVIDER,SEVEN\", \"orderedById\": 990, \"orderedByNPI\": \"\", \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"resourceId\": \"V-500-601.84-100009\", \"resourceType\": \"Observation\", \"results\": { \"Mhres\": { \"administration\": 100009, \"administrationId\": 100009, \"instrument\": \"AUDC\", \"mhresIen\": 100009, \"rawScore\": 8, \"resourceId\": \"V-500-601.92-100009\", \"resourceType\": \"Observation\", \"resultId\": 100009, \"scale\": \"Total\", \"transformedScore1\": \"\", \"transformedScore2\": \"\", \"transformedScore3\": \"\" } }, \"sctPreferredTerm\": \"\", \"signed\": \"No\", \"signedCd\": \"N\", \"snomedCode\": \"\", \"transmissionStatus\": \"\", \"transmissionStatusCd\": \"\", \"transmissionTime\": \"\", \"transmissionTimeFHIR\": \"\", \"transmissionTimeFM\": \"\", \"transmissionTimeHL7\": \"\" } }, { \"Mhadm\": { \"administeredBy\": \"PROVIDER,SEVEN\", \"administeredById\": 990, \"administeredByResId\": \"V-500-601.84-990\", \"administeredByNPI\": \"\", \"administrationNumber\": 100010, \"comments\": \"\", \"dateGiven\": \"AUG 31,2014@14:00\", \"dateGivenFHIR\": \"2014-08-31T14:00:00-05:00\", \"dateGivenFM\": 3140831.14, \"dateGivenHL7\": \"201408311400-0500\", \"dateSaved\": \"AUG 31,2014@14:06\", \"dateSavedFHIR\": \"2014-08-31T14:06:00-05:00\", \"dateSavedFM\": 3140831.1406, \"dateSavedHL7\": \"201408311406-0500\", \"instrumentName\": \"PC PTSD\", \"instrumentNameId\": 56, \"isComplete\": \"Yes\", \"isCompleteCd\": \"Y\", \"location\": \"PRIMARY CARE\", \"locationId\": 32, \"loincCode\": \"71754-6\", \"mhadmIen\": 100010, \"numberOfQuestionsAnswered\": 4, \"orderedBy\": \"PROVIDER,SEVEN\", \"orderedById\": 990, \"orderedByNPI\": \"\", \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"resourceId\": \"V-500-601.84-100010\", \"resourceType\": \"Observation\", \"results\": { \"Mhres\": { \"administration\": 100010, \"administrationId\": 100010, \"instrument\": \"PC PTSD\", \"mhresIen\": 100010, \"rawScore\": 3, \"resourceId\": \"V-500-601.92-100010\", \"resourceType\": \"Observation\", \"resultId\": 100010, \"scale\": \"Total\", \"transformedScore1\": \"\", \"transformedScore2\": \"\", \"transformedScore3\": \"\" } }, \"sctPreferredTerm\": \"\", \"signed\": \"No\", \"signedCd\": \"N\", \"snomedCode\": \"\", \"transmissionStatus\": \"\", \"transmissionStatusCd\": \"\", \"transmissionTime\": \"\", \"transmissionTimeFHIR\": \"\", \"transmissionTimeFM\": \"\", \"transmissionTimeHL7\": \"\" } } ] }";

        ObservationParser parser = new ObservationParser();

        List<Observation> result = parser.parseMentalHealthList(input);

        Assert.assertEquals("Correct number of items", 5, result.size());

        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
        Date expectedDate = sdf.parse("2014-09-10");
        Assert.assertEquals("Correct appointment start date and time", expectedDate, result.get(0).getIssued());
    }

    @Test
    public void TestMentalHealthObservationParseOrgBug() throws ParseException {
        String input = "{ \"Observations\": [ { \"Mhdiag\": { \"axis5-GAF\": 65, \"condition\": \"\", \"conditionCd\": \"\", \"dateTimeOfDiagnosis\": \"SEP 10,2014\", \"dateTimeOfDiagnosisFHIR\": \"2014-09-10\", \"dateTimeOfDiagnosisFM\": 3140910, \"dateTimeOfDiagnosisHL7\": 20140910, \"diagnosis\": \"\", \"diagnosisBy\": \"PROVIDER,SEVEN\", \"diagnosisById\": 990, \"diagnosisByNPI\": \"\", \"diagnosisId\": \"\", \"diagnosisSCT\": \"\", \"dxls\": \"\", \"dxlsCd\": \"\", \"fileEntryDate\": \"JUN 10,2015@14:17\", \"fileEntryDateFHIR\": \"2015-06-10T14:17:00-05:00\", \"fileEntryDateFM\": 3150610.1417, \"fileEntryDateHL7\": \"201506101417-0500\", \"inactivatedDate\": \"\", \"inactivatedDateFHIR\": \"\", \"inactivatedDateFM\": \"\", \"inactivatedDateHL7\": \"\", \"mhdiagIen\": 172, \"patientICN\": \"5000000352V586511\", \"patientName\": \"EHMP,FIVE\", \"patientNameId\": 100848, \"patientType\": \"In-Patient\", \"patientTypeCd\": \"I\", \"psychosocialStressor\": \"\", \"resourceId\": \"V-500-627.8-172\", \"resourceType\": \"Observation\", \"severityCode\": \"\", \"severityCodeCd\": \"\", \"statusChanged\": \"\", \"statusChangedCd\": \"\", \"statusVPRINRu\": \"\", \"statusVPRINRuCd\": \"\", \"transcriber\": \"PROVIDER,SEVEN\", \"transcriberId\": 990 } }, { \"Mhadm\": { \"administeredBy\": \"PROVIDER,SEVEN\", \"administeredById\": 990, \"administeredByResId\": \"V-500-601.84-990\", \"administeredByNPI\": \"\", \"administrationNumber\": 100007, \"comments\": \"\", \"dateGiven\": \"AUG 31,2014@14:00\", \"dateGivenFHIR\": \"2014-08-31T14:00:00-05:00\", \"dateGivenFM\": 3140831.14, \"dateGivenHL7\": \"201408311400-0500\", \"dateSaved\": \"AUG 31,2014@14:03\", \"dateSavedFHIR\": \"2014-08-31T14:03:00-05:00\", \"dateSavedFM\": 3140831.1403, \"dateSavedHL7\": \"201408311403-0500\", \"instrumentName\": \"PHQ-2\", \"instrumentNameId\": 71, \"isComplete\": \"Yes\", \"isCompleteCd\": \"Y\", \"location\": \"PRIMARY CARE\", \"locationId\": 32, \"loincCode\": \"55758-7\", \"mhadmIen\": 100007, \"numberOfQuestionsAnswered\": 2, \"orderedBy\": \"PROVIDER,SEVEN\", \"orderedById\": 990, \"orderedByNPI\": \"\", \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"resourceId\": \"V-500-601.84-100007\", \"resourceType\": \"Observation\", \"results\": { \"Mhres\": { \"administration\": 100007, \"administrationId\": 100007, \"instrument\": \"PHQ-2\", \"mhresIen\": 100007, \"rawScore\": 4, \"resourceId\": \"V-500-601.92-100007\", \"resourceType\": \"Observation\", \"resultId\": 100007, \"scale\": \"Depression\", \"transformedScore1\": \"\", \"transformedScore2\": \"\", \"transformedScore3\": \"\" } }, \"sctPreferredTerm\": \"Assessment using PHQ-2 questionnaire\", \"signed\": \"No\", \"signedCd\": \"N\", \"snomedCode\": 454711000124102, \"transmissionStatus\": \"\", \"transmissionStatusCd\": \"\", \"transmissionTime\": \"\", \"transmissionTimeFHIR\": \"\", \"transmissionTimeFM\": \"\", \"transmissionTimeHL7\": \"\" } }, { \"Mhadm\": { \"administeredBy\": \"PROVIDER,SEVEN\", \"administeredById\": 990, \"administeredByResId\": \"V-500-601.84-990\", \"administeredByNPI\": \"\", \"administrationNumber\": 100008, \"comments\": \"\", \"dateGiven\": \"AUG 31,2014@14:00\", \"dateGivenFHIR\": \"2014-08-31T14:00:00-05:00\", \"dateGivenFM\": 3140831.14, \"dateGivenHL7\": \"201408311400-0500\", \"dateSaved\": \"AUG 31,2014@14:04\", \"dateSavedFHIR\": \"2014-08-31T14:04:00-05:00\", \"dateSavedFM\": 3140831.1404, \"dateSavedHL7\": \"201408311404-0500\", \"instrumentName\": \"PHQ9\", \"instrumentNameId\": 42, \"isComplete\": \"Yes\", \"isCompleteCd\": \"Y\", \"location\": \"PRIMARY CARE\", \"locationId\": 32, \"loincCode\": \"44249-1\", \"mhadmIen\": 100008, \"numberOfQuestionsAnswered\": 10, \"orderedBy\": \"PROVIDER,SEVEN\", \"orderedById\": 990, \"orderedByNPI\": \"\", \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"resourceId\": \"V-500-601.84-100008\", \"resourceType\": \"Observation\", \"results\": { \"Mhres\": { \"administration\": 100008, \"administrationId\": 100008, \"instrument\": \"PHQ9\", \"mhresIen\": 100008, \"rawScore\": 7, \"resourceId\": \"V-500-601.92-100008\", \"resourceType\": \"Observation\", \"resultId\": 100008, \"scale\": \"Total\", \"transformedScore1\": \"\", \"transformedScore2\": \"\", \"transformedScore3\": \"\" } }, \"sctPreferredTerm\": \"Depression screening using PHQ-9 (Patient Health Questionnaire 9) score\", \"signed\": \"No\", \"signedCd\": \"N\", \"snomedCode\": 715252007, \"transmissionStatus\": \"\", \"transmissionStatusCd\": \"\", \"transmissionTime\": \"\", \"transmissionTimeFHIR\": \"\", \"transmissionTimeFM\": \"\", \"transmissionTimeHL7\": \"\" } }, { \"Mhadm\": { \"administeredBy\": \"PROVIDER,SEVEN\", \"administeredById\": 990, \"administeredByResId\": \"V-500-601.84-990\", \"administeredByNPI\": \"\", \"administrationNumber\": 100009, \"comments\": \"\", \"dateGiven\": \"AUG 31,2014@14:00\", \"dateGivenFHIR\": \"2014-08-31T14:00:00-05:00\", \"dateGivenFM\": 3140831.14, \"dateGivenHL7\": \"201408311400-0500\", \"dateSaved\": \"AUG 31,2014@14:05\", \"dateSavedFHIR\": \"2014-08-31T14:05:00-05:00\", \"dateSavedFM\": 3140831.1405, \"dateSavedHL7\": \"201408311405-0500\", \"instrumentName\": \"AUDC\", \"instrumentNameId\": 5, \"isComplete\": \"Yes\", \"isCompleteCd\": \"Y\", \"location\": \"PRIMARY CARE\", \"locationId\": 32, \"loincCode\": \"\", \"mhadmIen\": 100009, \"numberOfQuestionsAnswered\": 3, \"orderedBy\": \"PROVIDER,SEVEN\", \"orderedById\": 990, \"orderedByNPI\": \"\", \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"resourceId\": \"V-500-601.84-100009\", \"resourceType\": \"Observation\", \"results\": { \"Mhres\": { \"administration\": 100009, \"administrationId\": 100009, \"instrument\": \"AUDC\", \"mhresIen\": 100009, \"rawScore\": 8, \"resourceId\": \"V-500-601.92-100009\", \"resourceType\": \"Observation\", \"resultId\": 100009, \"scale\": \"Total\", \"transformedScore1\": \"\", \"transformedScore2\": \"\", \"transformedScore3\": \"\" } }, \"sctPreferredTerm\": \"\", \"signed\": \"No\", \"signedCd\": \"N\", \"snomedCode\": \"\", \"transmissionStatus\": \"\", \"transmissionStatusCd\": \"\", \"transmissionTime\": \"\", \"transmissionTimeFHIR\": \"\", \"transmissionTimeFM\": \"\", \"transmissionTimeHL7\": \"\" } }, { \"Mhadm\": { \"administeredBy\": \"PROVIDER,SEVEN\", \"administeredById\": 990, \"administeredByResId\": \"V-500-601.84-990\", \"administeredByNPI\": \"\", \"administrationNumber\": 100010, \"comments\": \"\", \"dateGiven\": \"AUG 31,2014@14:00\", \"dateGivenFHIR\": \"2014-08-31T14:00:00-05:00\", \"dateGivenFM\": 3140831.14, \"dateGivenHL7\": \"201408311400-0500\", \"dateSaved\": \"AUG 31,2014@14:06\", \"dateSavedFHIR\": \"2014-08-31T14:06:00-05:00\", \"dateSavedFM\": 3140831.1406, \"dateSavedHL7\": \"201408311406-0500\", \"instrumentName\": \"PC PTSD\", \"instrumentNameId\": 56, \"isComplete\": \"Yes\", \"isCompleteCd\": \"Y\", \"location\": \"PRIMARY CARE\", \"locationId\": 32, \"loincCode\": \"71754-6\", \"mhadmIen\": 100010, \"numberOfQuestionsAnswered\": 4, \"orderedBy\": \"PROVIDER,SEVEN\", \"orderedById\": 990, \"orderedByNPI\": \"\", \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"resourceId\": \"V-500-601.84-100010\", \"resourceType\": \"Observation\", \"results\": { \"Mhres\": { \"administration\": 100010, \"administrationId\": 100010, \"instrument\": \"PC PTSD\", \"mhresIen\": 100010, \"rawScore\": 3, \"resourceId\": \"V-500-601.92-100010\", \"resourceType\": \"Observation\", \"resultId\": 100010, \"scale\": \"Total\", \"transformedScore1\": \"\", \"transformedScore2\": \"\", \"transformedScore3\": \"\" } }, \"sctPreferredTerm\": \"\", \"signed\": \"No\", \"signedCd\": \"N\", \"snomedCode\": \"\", \"transmissionStatus\": \"\", \"transmissionStatusCd\": \"\", \"transmissionTime\": \"\", \"transmissionTimeFHIR\": \"\", \"transmissionTimeFM\": \"\", \"transmissionTimeHL7\": \"\" } } ] }";

        ObservationParser parser = new ObservationParser();

        List<Observation> result = parser.parseMentalHealthList(input);

        Assert.assertEquals("Correct organization reference", true, result.get(1).getPerformer().get(1).getReference().startsWith("/Organization"));
        Assert.assertEquals("Correct organization system", HcConstants.URN_VISTA_ORGANIZATION, result.get(1).getPerformer().get(1).getIdentifier().getSystem());
    }

    @Test
    public void TestMHDiagObservationParse() {
        String input = "{ \"Observations\": [ { \"Mhdiag\": { \"axis5-GAF\": 65, \"condition\": \"\", \"conditionCd\": \"\", \"dateTimeOfDiagnosis\": \"SEP 10,2014\", \"dateTimeOfDiagnosisFHIR\": \"2014-09-10\", \"dateTimeOfDiagnosisFM\": 3140910, \"dateTimeOfDiagnosisHL7\": 20140910, \"diagnosis\": \"\", \"diagnosisBy\": \"PROVIDER,SEVEN\", \"diagnosisById\": 990, \"diagnosisByNPI\": \"\", \"diagnosisId\": \"\", \"diagnosisSCT\": \"\", \"dxls\": \"\", \"dxlsCd\": \"\", \"fileEntryDate\": \"JUN 10,2015@14:17\", \"fileEntryDateFHIR\": \"2015-06-10T14:17:00-05:00\", \"fileEntryDateFM\": 3150610.1417, \"fileEntryDateHL7\": \"201506101417-0500\", \"inactivatedDate\": \"\", \"inactivatedDateFHIR\": \"\", \"inactivatedDateFM\": \"\", \"inactivatedDateHL7\": \"\", \"mhdiagIen\": 172, \"patientICN\": \"5000000352V586511\", \"patientName\": \"EHMP,FIVE\", \"patientNameId\": 100848, \"patientType\": \"In-Patient\", \"patientTypeCd\": \"I\", \"psychosocialStressor\": \"\", \"resourceId\": \"V-500-627.8-172\", \"resourceType\": \"Observation\", \"severityCode\": \"\", \"severityCodeCd\": \"\", \"statusChanged\": \"\", \"statusChangedCd\": \"\", \"statusVPRINRu\": \"\", \"statusVPRINRuCd\": \"\", \"transcriber\": \"PROVIDER,SEVEN\", \"transcriberId\": 990 } }, { \"Mhadm\": { \"administeredBy\": \"PROVIDER,SEVEN\", \"administeredById\": 990, \"administeredByResId\": \"V-500-601.84-990\", \"administeredByNPI\": \"\", \"administrationNumber\": 100007, \"comments\": \"\", \"dateGiven\": \"AUG 31,2014@14:00\", \"dateGivenFHIR\": \"2014-08-31T14:00:00-05:00\", \"dateGivenFM\": 3140831.14, \"dateGivenHL7\": \"201408311400-0500\", \"dateSaved\": \"AUG 31,2014@14:03\", \"dateSavedFHIR\": \"2014-08-31T14:03:00-05:00\", \"dateSavedFM\": 3140831.1403, \"dateSavedHL7\": \"201408311403-0500\", \"instrumentName\": \"PHQ-2\", \"instrumentNameId\": 71, \"isComplete\": \"Yes\", \"isCompleteCd\": \"Y\", \"location\": \"PRIMARY CARE\", \"locationId\": 32, \"loincCode\": \"55758-7\", \"mhadmIen\": 100007, \"numberOfQuestionsAnswered\": 2, \"orderedBy\": \"PROVIDER,SEVEN\", \"orderedById\": 990, \"orderedByNPI\": \"\", \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"resourceId\": \"V-500-601.84-100007\", \"resourceType\": \"Observation\", \"results\": { \"Mhres\": { \"administration\": 100007, \"administrationId\": 100007, \"instrument\": \"PHQ-2\", \"mhresIen\": 100007, \"rawScore\": 4, \"resourceId\": \"V-500-601.92-100007\", \"resourceType\": \"Observation\", \"resultId\": 100007, \"scale\": \"Depression\", \"transformedScore1\": \"\", \"transformedScore2\": \"\", \"transformedScore3\": \"\" } }, \"sctPreferredTerm\": \"Assessment using PHQ-2 questionnaire\", \"signed\": \"No\", \"signedCd\": \"N\", \"snomedCode\": 454711000124102, \"transmissionStatus\": \"\", \"transmissionStatusCd\": \"\", \"transmissionTime\": \"\", \"transmissionTimeFHIR\": \"\", \"transmissionTimeFM\": \"\", \"transmissionTimeHL7\": \"\" } }, { \"Mhadm\": { \"administeredBy\": \"PROVIDER,SEVEN\", \"administeredById\": 990, \"administeredByResId\": \"V-500-601.84-990\", \"administeredByNPI\": \"\", \"administrationNumber\": 100008, \"comments\": \"\", \"dateGiven\": \"AUG 31,2014@14:00\", \"dateGivenFHIR\": \"2014-08-31T14:00:00-05:00\", \"dateGivenFM\": 3140831.14, \"dateGivenHL7\": \"201408311400-0500\", \"dateSaved\": \"AUG 31,2014@14:04\", \"dateSavedFHIR\": \"2014-08-31T14:04:00-05:00\", \"dateSavedFM\": 3140831.1404, \"dateSavedHL7\": \"201408311404-0500\", \"instrumentName\": \"PHQ9\", \"instrumentNameId\": 42, \"isComplete\": \"Yes\", \"isCompleteCd\": \"Y\", \"location\": \"PRIMARY CARE\", \"locationId\": 32, \"loincCode\": \"44249-1\", \"mhadmIen\": 100008, \"numberOfQuestionsAnswered\": 10, \"orderedBy\": \"PROVIDER,SEVEN\", \"orderedById\": 990, \"orderedByNPI\": \"\", \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"resourceId\": \"V-500-601.84-100008\", \"resourceType\": \"Observation\", \"results\": { \"Mhres\": { \"administration\": 100008, \"administrationId\": 100008, \"instrument\": \"PHQ9\", \"mhresIen\": 100008, \"rawScore\": 7, \"resourceId\": \"V-500-601.92-100008\", \"resourceType\": \"Observation\", \"resultId\": 100008, \"scale\": \"Total\", \"transformedScore1\": \"\", \"transformedScore2\": \"\", \"transformedScore3\": \"\" } }, \"sctPreferredTerm\": \"Depression screening using PHQ-9 (Patient Health Questionnaire 9) score\", \"signed\": \"No\", \"signedCd\": \"N\", \"snomedCode\": 715252007, \"transmissionStatus\": \"\", \"transmissionStatusCd\": \"\", \"transmissionTime\": \"\", \"transmissionTimeFHIR\": \"\", \"transmissionTimeFM\": \"\", \"transmissionTimeHL7\": \"\" } }, { \"Mhadm\": { \"administeredBy\": \"PROVIDER,SEVEN\", \"administeredById\": 990, \"administeredByResId\": \"V-500-601.84-990\", \"administeredByNPI\": \"\", \"administrationNumber\": 100009, \"comments\": \"\", \"dateGiven\": \"AUG 31,2014@14:00\", \"dateGivenFHIR\": \"2014-08-31T14:00:00-05:00\", \"dateGivenFM\": 3140831.14, \"dateGivenHL7\": \"201408311400-0500\", \"dateSaved\": \"AUG 31,2014@14:05\", \"dateSavedFHIR\": \"2014-08-31T14:05:00-05:00\", \"dateSavedFM\": 3140831.1405, \"dateSavedHL7\": \"201408311405-0500\", \"instrumentName\": \"AUDC\", \"instrumentNameId\": 5, \"isComplete\": \"Yes\", \"isCompleteCd\": \"Y\", \"location\": \"PRIMARY CARE\", \"locationId\": 32, \"loincCode\": \"\", \"mhadmIen\": 100009, \"numberOfQuestionsAnswered\": 3, \"orderedBy\": \"PROVIDER,SEVEN\", \"orderedById\": 990, \"orderedByNPI\": \"\", \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"resourceId\": \"V-500-601.84-100009\", \"resourceType\": \"Observation\", \"results\": { \"Mhres\": { \"administration\": 100009, \"administrationId\": 100009, \"instrument\": \"AUDC\", \"mhresIen\": 100009, \"rawScore\": 8, \"resourceId\": \"V-500-601.92-100009\", \"resourceType\": \"Observation\", \"resultId\": 100009, \"scale\": \"Total\", \"transformedScore1\": \"\", \"transformedScore2\": \"\", \"transformedScore3\": \"\" } }, \"sctPreferredTerm\": \"\", \"signed\": \"No\", \"signedCd\": \"N\", \"snomedCode\": \"\", \"transmissionStatus\": \"\", \"transmissionStatusCd\": \"\", \"transmissionTime\": \"\", \"transmissionTimeFHIR\": \"\", \"transmissionTimeFM\": \"\", \"transmissionTimeHL7\": \"\" } }, { \"Mhadm\": { \"administeredBy\": \"PROVIDER,SEVEN\", \"administeredById\": 990, \"administeredByResId\": \"V-500-601.84-990\", \"administeredByNPI\": \"\", \"administrationNumber\": 100010, \"comments\": \"\", \"dateGiven\": \"AUG 31,2014@14:00\", \"dateGivenFHIR\": \"2014-08-31T14:00:00-05:00\", \"dateGivenFM\": 3140831.14, \"dateGivenHL7\": \"201408311400-0500\", \"dateSaved\": \"AUG 31,2014@14:06\", \"dateSavedFHIR\": \"2014-08-31T14:06:00-05:00\", \"dateSavedFM\": 3140831.1406, \"dateSavedHL7\": \"201408311406-0500\", \"instrumentName\": \"PC PTSD\", \"instrumentNameId\": 56, \"isComplete\": \"Yes\", \"isCompleteCd\": \"Y\", \"location\": \"PRIMARY CARE\", \"locationId\": 32, \"loincCode\": \"71754-6\", \"mhadmIen\": 100010, \"numberOfQuestionsAnswered\": 4, \"orderedBy\": \"PROVIDER,SEVEN\", \"orderedById\": 990, \"orderedByNPI\": \"\", \"patient\": \"EHMP,FIVE\", \"patientICN\": \"5000000352V586511\", \"patientId\": 100848, \"resourceId\": \"V-500-601.84-100010\", \"resourceType\": \"Observation\", \"results\": { \"Mhres\": { \"administration\": 100010, \"administrationId\": 100010, \"instrument\": \"PC PTSD\", \"mhresIen\": 100010, \"rawScore\": 3, \"resourceId\": \"V-500-601.92-100010\", \"resourceType\": \"Observation\", \"resultId\": 100010, \"scale\": \"Total\", \"transformedScore1\": \"\", \"transformedScore2\": \"\", \"transformedScore3\": \"\" } }, \"sctPreferredTerm\": \"\", \"signed\": \"No\", \"signedCd\": \"N\", \"snomedCode\": \"\", \"transmissionStatus\": \"\", \"transmissionStatusCd\": \"\", \"transmissionTime\": \"\", \"transmissionTimeFHIR\": \"\", \"transmissionTimeFM\": \"\", \"transmissionTimeHL7\": \"\" } } ] }";

        ObservationParser parser = new ObservationParser();

        List<Observation> result = parser.parseMentalHealthList(input);

        Observation obs = result.get(0);
        Quantity value = (Quantity) obs.getValue();
        Assert.assertEquals("Correct Value", 65L, value.getValue().longValue());
    }

    @Test
    public void TestInvalidHealthFactorsObservationParse () {
        String input = "-1^Patientidentifiernotrecognised";

        ObservationParser parser = new ObservationParser();

        List<Observation> result = parser.parseHealthFactorsList(input);

        Assert.assertTrue(result.isEmpty());
    }

    @Test
    public void TestEmptyHealthFactorsObservationParse () {
        String input = "";

        ObservationParser parser = new ObservationParser();

        List<Observation> result = parser.parseHealthFactorsList(input);

        Assert.assertTrue(result.isEmpty());
    }


    @Test
    public void TestSuccessfulHealthFactorsObservationParse() throws ParseException {
        String input = "{ \"HealthFactors\": [ { \"HealthFactor\": { \"auditTrail\": \"19-A 989;\", \"comments\": \"\", \"dataSource\": \"TEXT INTEGRATION UTILITIES\", \"dataSourceId\": 19, \"edited\": \"\", \"editedCd\": \"\", \"encounterProvider\": \"PROVIDER,FIFTEEN\", \"encounterProviderId\": 998, \"encounterProviderResId\": \"V-500-200-998\", \"encounterProviderNPI\": \"\", \"eventDateTime\": \"\", \"eventDateTimeFHIR\": \"\", \"eventDateTimeFM\": \"\", \"eventDateTimeHL7\": \"\", \"hlfCategory\": \"TOBACCO [C]\", \"hlfCategoryId\": 6, \"hlfIen\": 804, \"hlfName\": \"HX OF SMOKING\", \"hlfNameId\": 40, \"hlfNameSCT\": \"\", \"levelSeverity\": \"\", \"levelSeverityCd\": \"\", \"magnitude\": \"\", \"orderingProvider\": \"\", \"orderingProviderId\": \"\", \"orderingProviderNPI\": \"\", \"package\": \"ORDER ENTRY\\/RESULTS REPORTING\", \"packageId\": 170, \"patientICN\": \"5000000352V586511\", \"patientName\": \"EHMP,FIVE\", \"patientNameId\": 100848, \"resourceId\": \"V-500-9000010.23-804\", \"resourceType\": \"HealthFactor\", \"ucumCode\": \"\", \"verified\": \"\", \"verifiedCd\": \"\", \"visit\": \"AUG 31,2014@14:00\", \"visitFHIR\": \"2014-08-31T14:00:00-05:00\", \"visitFM\": 3140831.14, \"visitHL7\": \"201408311400-0500\", \"visitId\": 11431, \"visitResId\": \"V-500-9000010-11431\" } }, { \"HealthFactor\": { \"auditTrail\": \"19-A 989;\", \"comments\": \"\", \"dataSource\": \"TEXT INTEGRATION UTILITIES\", \"dataSourceId\": 19, \"edited\": \"\", \"editedCd\": \"\", \"encounterProvider\": \"PROVIDER,FIFTEEN\", \"encounterProviderId\": 998, \"encounterProviderResId\": \"V-500-200-998\", \"encounterProviderNPI\": \"\", \"eventDateTime\": \"\", \"eventDateTimeFHIR\": \"\", \"eventDateTimeFM\": \"\", \"eventDateTimeHL7\": \"\", \"hlfCategory\": \"TOBACCO [C]\", \"hlfCategoryId\": 6, \"hlfIen\": 805, \"hlfName\": \"CURRENT NON-SMOKER\", \"hlfNameId\": 3, \"hlfNameSCT\": \"\", \"levelSeverity\": \"\", \"levelSeverityCd\": \"\", \"magnitude\": \"\", \"orderingProvider\": \"\", \"orderingProviderId\": \"\", \"orderingProviderNPI\": \"\", \"package\": \"ORDER ENTRY\\/RESULTS REPORTING\", \"packageId\": 170, \"patientICN\": \"5000000352V586511\", \"patientName\": \"EHMP,FIVE\", \"patientNameId\": 100848, \"resourceId\": \"V-500-9000010.23-805\", \"resourceType\": \"HealthFactor\", \"ucumCode\": \"\", \"verified\": \"\", \"verifiedCd\": \"\", \"visit\": \"AUG 31,2014@14:00\", \"visitFHIR\": \"2014-08-31T14:00:00-05:00\", \"visitFM\": 3140831.14, \"visitHL7\": \"201408311400-0500\", \"visitId\": 11431, \"visitResId\": \"V-500-9000010-11431\" } }, { \"HealthFactor\": { \"auditTrail\": \"19-A 990;\", \"comments\": \"\", \"dataSource\": \"TEXT INTEGRATION UTILITIES\", \"dataSourceId\": 19, \"edited\": \"\", \"editedCd\": \"\", \"encounterProvider\": \"PROVIDER,FIFTEEN\", \"encounterProviderId\": 998, \"encounterProviderResId\": \"V-500-200-998\", \"encounterProviderNPI\": \"\", \"eventDateTime\": \"\", \"eventDateTimeFHIR\": \"\", \"eventDateTimeFM\": \"\", \"eventDateTimeHL7\": \"\", \"hlfCategory\": \"IRAQ\\/AFGHANISTAN [C]\", \"hlfCategoryId\": 121, \"hlfIen\": 806, \"hlfName\": \"GI SYMPTOMS SCREEN NEGATIVE\", \"hlfNameId\": 127, \"hlfNameSCT\": \"\", \"levelSeverity\": \"\", \"levelSeverityCd\": \"\", \"magnitude\": \"\", \"orderingProvider\": \"\", \"orderingProviderId\": \"\", \"orderingProviderNPI\": \"\", \"package\": \"ORDER ENTRY\\/RESULTS REPORTING\", \"packageId\": 170, \"patientICN\": \"5000000352V586511\", \"patientName\": \"EHMP,FIVE\", \"patientNameId\": 100848, \"resourceId\": \"V-500-9000010.23-806\", \"resourceType\": \"HealthFactor\", \"ucumCode\": \"\", \"verified\": \"\", \"verifiedCd\": \"\", \"visit\": \"AUG 31,2014@14:00\", \"visitFHIR\": \"2014-08-31T14:00:00-05:00\", \"visitFM\": 3140831.14, \"visitHL7\": \"201408311400-0500\", \"visitId\": 11431, \"visitResId\": \"V-500-9000010-11431\" } }, { \"HealthFactor\": { \"auditTrail\": \"19-A 990;\", \"comments\": \"\", \"dataSource\": \"TEXT INTEGRATION UTILITIES\", \"dataSourceId\": 19, \"edited\": \"\", \"editedCd\": \"\", \"encounterProvider\": \"PROVIDER,FIFTEEN\", \"encounterProviderId\": 998, \"encounterProviderResId\": \"V-500-200-998\", \"encounterProviderNPI\": \"\", \"eventDateTime\": \"\", \"eventDateTimeFHIR\": \"\", \"eventDateTimeFM\": \"\", \"eventDateTimeHL7\": \"\", \"hlfCategory\": \"IRAQ\\/AFGHANISTAN [C]\", \"hlfCategoryId\": 121, \"hlfIen\": 807, \"hlfName\": \"UNEXPLAINED FEVERS SCREEN NEGATIVE\", \"hlfNameId\": 129, \"hlfNameSCT\": \"\", \"levelSeverity\": \"\", \"levelSeverityCd\": \"\", \"magnitude\": \"\", \"orderingProvider\": \"\", \"orderingProviderId\": \"\", \"orderingProviderNPI\": \"\", \"package\": \"ORDER ENTRY\\/RESULTS REPORTING\", \"packageId\": 170, \"patientICN\": \"5000000352V586511\", \"patientName\": \"EHMP,FIVE\", \"patientNameId\": 100848, \"resourceId\": \"V-500-9000010.23-807\", \"resourceType\": \"HealthFactor\", \"ucumCode\": \"\", \"verified\": \"\", \"verifiedCd\": \"\", \"visit\": \"AUG 31,2014@14:00\", \"visitFHIR\": \"2014-08-31T14:00:00-05:00\", \"visitFM\": 3140831.14, \"visitHL7\": \"201408311400-0500\", \"visitId\": 11431, \"visitResId\": \"V-500-9000010-11431\" } }, { \"HealthFactor\": { \"auditTrail\": \"19-A 990;\", \"comments\": \"\", \"dataSource\": \"TEXT INTEGRATION UTILITIES\", \"dataSourceId\": 19, \"edited\": \"\", \"editedCd\": \"\", \"encounterProvider\": \"PROVIDER,FIFTEEN\", \"encounterProviderId\": 998, \"encounterProviderResId\": \"V-500-200-998\", \"encounterProviderNPI\": \"\", \"eventDateTime\": \"\", \"eventDateTimeFHIR\": \"\", \"eventDateTimeFM\": \"\", \"eventDateTimeHL7\": \"\", \"hlfCategory\": \"IRAQ\\/AFGHANISTAN [C]\", \"hlfCategoryId\": 121, \"hlfIen\": 808, \"hlfName\": \"SKIN LESION SCREEN NEGATIVE\", \"hlfNameId\": 132, \"hlfNameSCT\": \"\", \"levelSeverity\": \"\", \"levelSeverityCd\": \"\", \"magnitude\": \"\", \"orderingProvider\": \"\", \"orderingProviderId\": \"\", \"orderingProviderNPI\": \"\", \"package\": \"ORDER ENTRY\\/RESULTS REPORTING\", \"packageId\": 170, \"patientICN\": \"5000000352V586511\", \"patientName\": \"EHMP,FIVE\", \"patientNameId\": 100848, \"resourceId\": \"V-500-9000010.23-808\", \"resourceType\": \"HealthFactor\", \"ucumCode\": \"\", \"verified\": \"\", \"verifiedCd\": \"\", \"visit\": \"AUG 31,2014@14:00\", \"visitFHIR\": \"2014-08-31T14:00:00-05:00\", \"visitFM\": 3140831.14, \"visitHL7\": \"201408311400-0500\", \"visitId\": 11431, \"visitResId\": \"V-500-9000010-11431\" } }, { \"HealthFactor\": { \"auditTrail\": \"19-A 990;\", \"comments\": \"IED blast\", \"dataSource\": \"TEXT INTEGRATION UTILITIES\", \"dataSourceId\": 19, \"edited\": \"\", \"editedCd\": \"\", \"encounterProvider\": \"PROVIDER,FIFTEEN\", \"encounterProviderId\": 998, \"encounterProviderResId\": \"V-500-200-998\", \"encounterProviderNPI\": \"\", \"eventDateTime\": \"\", \"eventDateTimeFHIR\": \"\", \"eventDateTimeFM\": \"\", \"eventDateTimeHL7\": \"\", \"hlfCategory\": \"IRAQ\\/AFGHANISTAN [C]\", \"hlfCategoryId\": 121, \"hlfIen\": 809, \"hlfName\": \"EMBEDDED FRAGMENTS PRESENT\", \"hlfNameId\": 613038, \"hlfNameSCT\": \"\", \"levelSeverity\": \"\", \"levelSeverityCd\": \"\", \"magnitude\": \"\", \"orderingProvider\": \"\", \"orderingProviderId\": \"\", \"orderingProviderNPI\": \"\", \"package\": \"ORDER ENTRY\\/RESULTS REPORTING\", \"packageId\": 170, \"patientICN\": \"5000000352V586511\", \"patientName\": \"EHMP,FIVE\", \"patientNameId\": 100848, \"resourceId\": \"V-500-9000010.23-809\", \"resourceType\": \"HealthFactor\", \"ucumCode\": \"\", \"verified\": \"\", \"verifiedCd\": \"\", \"visit\": \"AUG 31,2014@14:00\", \"visitFHIR\": \"2014-08-31T14:00:00-05:00\", \"visitFM\": 3140831.14, \"visitHL7\": \"201408311400-0500\", \"visitId\": 11431, \"visitResId\": \"V-500-9000010-11431\" } } ] }";

        ObservationParser parser = new ObservationParser();

        List<Observation> result = parser.parseHealthFactorsList(input);

        Assert.assertEquals("Correct number of items", 6, result.size());

        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ssX");
        Date expectedDate = sdf.parse("2014-08-31T14:00:00-05:00");
        Assert.assertEquals("Correct issued date and time", expectedDate, result.get(0).getIssued());
    }

}
