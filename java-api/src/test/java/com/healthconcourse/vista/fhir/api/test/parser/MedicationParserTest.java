/* Created by Perspecta http://www.perspecta.com */
/*
        Licensed to the Apache Software Foundation (ASF) under one
        or more contributor license agreements.  See the NOTICE file
        distributed with this work for additional information
        regarding copyright ownership.  The ASF licenses this file
        to you under the Apache License, Version 2.0 (the
        "License"); you may not use this file except in compliance
        with the License.  You may obtain a copy of the License at
        http://www.apache.org/licenses/LICENSE-2.0
        Unless required by applicable law or agreed to in writing,
        software distributed under the License is distributed on an
        "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        KIND, either express or implied.  See the License for the
        specific language governing permissions and limitations
        under the License.
*/
package com.healthconcourse.vista.fhir.api.test.parser;

import com.healthconcourse.vista.fhir.api.parser.MedicationParser;
import org.hl7.fhir.dstu3.model.*;
import org.junit.Assert;
import org.junit.Test;

import java.math.BigDecimal;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;

public class MedicationParserTest {


    @Test
    public void TestSuccessfulMedicationAdminParse() throws ParseException {
        String input = "{ \"Patrx\": { \"activityLogs\": { \"activityLog\": [ { \"activityLog\": \"JUL 30,2015\", \"activityLogFHIR\": \"2015-07-30\", \"activityLogFM\": 3150730, \"activityLogHL7\": 20150730, \"comment\": \"Patient Instructions Not Sent By Provider.\", \"fieldEdited\": \"\", \"initiatorOfActivity\": \"\", \"initiatorOfActivityId\": \"\", \"newValue\": \"\", \"oldValue\": \"\", \"reason\": \"PATIENT INST\", \"reasonCd\": \"G\", \"resourceId\": \"V-500-52-404406-52.3-1\", \"rxReference\": \"ORIGINAL\" }, { \"activityLog\": \"JUL 30,2015@17:23:53\", \"activityLogFHIR\": \"2015-07-30T17:23:53-05:00\", \"activityLogFM\": 3150730.172353, \"activityLogHL7\": \"20150730172353-0500\", \"comment\": \"Discontinued by OE\\/RR.\", \"fieldEdited\": \"\", \"initiatorOfActivity\": \"PROVIDER,FIVE\", \"initiatorOfActivityId\": 988, \"newValue\": \"\", \"oldValue\": \"\", \"otherCommentss\": { \"otherComments\": [ { \"otherComments\": \"PATIENT LOST HIS NOSE\", \"resourceId\": \"V-500-52-404348-52.3-2-52.34-1\" } ] }, \"reason\": \"DISCONTINUED\", \"reasonCd\": \"C\", \"resourceId\": \"V-500-52-404393-52.3-2\", \"rxReference\": \"ORIGINAL\" }, { \"activityLog\": \"JUL 30,2015@17:59\", \"activityLogFHIR\": \"2015-07-30T17:59:00-05:00\", \"activityLogFM\": 3150730.1759, \"activityLogHL7\": \"201507301759-0500\", \"comment\": \"RX placed in a HOLD status (07-30-15) by OERR.\", \"fieldEdited\": \"\", \"initiatorOfActivity\": \"PROVIDER,FIVE\", \"initiatorOfActivityId\": 988, \"newValue\": \"\", \"oldValue\": \"\", \"reason\": \"HOLD\", \"reasonCd\": \"H\", \"resourceId\": \"V-500-52-404392-52.3-3\", \"rxReference\": \"ORIGINAL\" }, { \"activityLog\": \"JUL 30,2015@17:47:26\", \"activityLogFHIR\": \"2015-07-30T17:47:26-05:00\", \"activityLogFM\": 3150730.174726, \"activityLogHL7\": \"20150730174726-0500\", \"comment\": \"Renewed from CPRS\", \"fieldEdited\": \"\", \"initiatorOfActivity\": \"PROGRAMMER,FIVE\", \"initiatorOfActivityId\": 119, \"newValue\": \"\", \"oldValue\": \"\", \"reason\": \"RENEWED\", \"reasonCd\": \"L\", \"resourceId\": \"V-500-52-404347-52.3-4\", \"rxReference\": \"ORIGINAL\" } ] }, \"administeredInClinic\": \"\", \"administeredInClinicCd\": \"\", \"affectedMedication\": \"\", \"agentOrangeExposure\": \"\", \"agentOrangeExposureCd\": \"\", \"ancResults\": \"\", \"archived\": \"\", \"archivedCd\": \"\", \"backdoorSignatureStatus\": \"\", \"backdoorSignatureStatusCd\": \"\", \"billingEligibilityIndicator\": \"\", \"billingEligibilityIndicatorCd\": \"\", \"bingoWaitTime\": \"\", \"cancelDate\": \"\", \"cancelDateFHIR\": \"\", \"cancelDateFM\": \"\", \"cancelDateHL7\": \"\", \"checkingPharmacist\": \"\", \"checkingPharmacistId\": \"\", \"checkingPharmacistResId\": \"\", \"clinic\": \"AUDIOLOGY\", \"clinicId\": 64, \"clozapineDosageMgDay\": \"\", \"combatVeteran\": \"\", \"combatVeteranCd\": \"\", \"copayExceedingCap\": \"\", \"copayExceedingCapId\": \"\", \"copayTransactionType\": \"\", \"copayTransactionTypeId\": \"\", \"copayTypeAudit\": \"\", \"copies\": 1, \"cosigningPhysician\": \"\", \"cosigningPhysicianId\": \"\", \"cosigningPhysicianNPI\": \"\", \"cosigningPhysicianResId\": \"\", \"dateNdcValidated\": \"\", \"dateNdcValidatedFHIR\": \"\", \"dateNdcValidatedFM\": \"\", \"dateNdcValidatedHL7\": \"\", \"dateOfDeathHistory\": \"\", \"dateOfWbcTest\": \"\", \"dateOfWbcTestFHIR\": \"\", \"dateOfWbcTestFM\": \"\", \"dateOfWbcTestHL7\": \"\", \"dawCode\": 0, \"daysSupply\": 90, \"ddstatus\": \"\", \"deletionComments\": \"\", \"discontinueType\": \"\", \"discontinueTypeCd\": \"\", \"dispensedDate\": \"JUL 30,2015\", \"dispensedDateFHIR\": \"2015-07-30\", \"dispensedDateFM\": 3150730, \"dispensedDateHL7\": 20150730, \"division\": \"VEHU SITE\", \"divisionId\": 2, \"drug\": \"FUROSEMIDE 20MG TAB\", \"drugAllergyIndication\": \"\", \"drugAllergyIndicationCd\": \"\", \"drugExpirationDate\": \"\", \"drugExpirationDateFHIR\": \"\", \"drugExpirationDateFM\": \"\", \"drugExpirationDateHL7\": \"\", \"drugId\": 3963, \"enteredBy\": \"PROVIDER,FIVE\", \"enteredById\": 988, \"epharmacySuspenseHoldDate\": \"\", \"epharmacySuspenseHoldDateFHIR\": \"\", \"epharmacySuspenseHoldDateFM\": \"\", \"epharmacySuspenseHoldDateHL7\": \"\", \"expandedPatientInstructions\": \"\", \"expirationDate\": \"JUL 30,2016\", \"expirationDateFHIR\": \"2016-07-30\", \"expirationDateFM\": 3160730, \"expirationDateHL7\": 20160730, \"externalApplication\": \"\", \"externalPlacerOrderNumber\": \"\", \"fillDate\": \"JUL 30,2015\", \"fillDateFHIR\": \"2015-07-30\", \"fillDateFM\": 3150730, \"fillDateHL7\": 20150730, \"fillingPerson\": \"\", \"fillingPersonId\": \"\", \"finishDateTime\": \"JUL 30,2015@17:55:56\", \"finishDateTimeFHIR\": \"2015-07-30T17:55:56-05:00\", \"finishDateTimeFM\": 3150730.175556, \"finishDateTimeHL7\": \"20150730175556-0500\", \"finishingPerson\": \"PROGRAMMER,FIVE\", \"finishingPersonId\": 119, \"forwardOrder\": \"\", \"forwardOrderId\": \"\", \"forwardOrderResId\": \"\", \"genericProvider\": \"\", \"headAndOrNeckCancer\": \"\", \"headAndOrNeckCancerCd\": \"\", \"holdComments\": \"\", \"holdDate\": \"\", \"holdDateFHIR\": \"\", \"holdDateFM\": \"\", \"holdDateHL7\": \"\", \"holdReason\": \"\", \"holdReasonCd\": \"\", \"hospitalCoverage\": 0, \"ibNumber\": \"\", \"ibNumberId\": \"\", \"icdDiagnosiss\": { \"icdDiagnosis\": [ { \"agentOrange\": \"\", \"agentOrangeCd\": \"\", \"combatVeteran\": \"\", \"combatVeteranCd\": \"\", \"headAndOrNeckCancer\": \"\", \"headAndOrNeckCancerCd\": \"\", \"icdDiagnosis\": \"\", \"icdDiagnosisId\": \"\", \"icdDiagnosisSCT\": \"\", \"icdDiagnosisText\": \"\", \"ionizingRadiation\": \"\", \"ionizingRadiationCd\": \"\", \"militarySexualTrauma\": \"\", \"militarySexualTraumaCd\": \"\", \"proj112Shad\": \"\", \"proj112ShadCd\": \"\", \"resourceId\": \"V-500-52-404407-52.052311-1\", \"serviceConnection\": \"NO\", \"serviceConnectionCd\": 0, \"southwestAsiaConditions\": \"\", \"southwestAsiaConditionsCd\": \"\" } ] }, \"ionizingRadiationExposure\": \"\", \"ionizingRadiationExposureCd\": \"\", \"issueDate\": \"JUL 30,2015\", \"issueDateFHIR\": \"2015-07-30\", \"issueDateFM\": 3150730, \"issueDateHL7\": 20150730, \"labelDateTimes\": { \"labelDateTime\": [ { \"device\": \"\", \"fdaMedGuideFilename\": \"\", \"labelComment\": \"From RX number 501113\", \"labelDateTime\": \"JUL 22,2015@17:53:25\", \"labelDateTimeFHIR\": \"2015-07-22T17:53:25-05:00\", \"labelDateTimeFM\": 3150722.175325, \"labelDateTimeHL7\": \"20150722175325-0500\", \"printedBy\": \"PROGRAMMER,FIVE\", \"printedById\": 119, \"resourceId\": \"V-500-52-404394-52.032-1\", \"rxReference\": \"ORIGINAL\", \"warningLabelType\": \"\", \"warningLabelTypeCd\": \"\" } ] }, \"lastDispensedDate\": \"JUL 30,2015\", \"lastDispensedDateFHIR\": \"2015-07-30\", \"lastDispensedDateFM\": 3150730, \"lastDispensedDateHL7\": 20150730, \"lastDispensedDateHolder\": \"APR 21,2014\", \"lastDispensedDateHolderFHIR\": \"2014-04-21\", \"lastDispensedDateHolderFM\": 3140421, \"lastDispensedDateHolderHL7\": 20140421, \"loginDate\": \"JUL 30,2015@17:40:41\", \"loginDateFHIR\": \"2015-07-30T17:40:41-05:00\", \"loginDateFM\": 3150730.174041, \"loginDateHL7\": \"20150730174041-0500\", \"lot\": \"\", \"mailWindow\": \"WINDOW\", \"mailWindowCd\": \"W\", \"maintenanceDoseRx\": \"\", \"maintenanceDoseRxId\": \"\", \"manufacturer\": \"\", \"medicationInstructionss\": { \"medicationInstructions\": [ { \"conjunction\": \"\", \"conjunctionCd\": \"\", \"dispenseUnitsPerDose\": 1, \"dosageOrdered\": 20, \"duration\": \"\", \"noun\": \"TABLET\", \"otherLanguageDosage\": \"\", \"resourceId\": \"V-500-52-404407-52.0113-1\", \"route\": \"ORAL (BY MOUTH)\", \"routeId\": 1, \"schedule\": \"BID\", \"units\": \"MG\", \"unitsId\": 20, \"verb\": \"TAKE\" } ] }, \"methodOfPickUp\": \"\", \"militarySexualTrauma\": \"\", \"militarySexualTraumaCd\": \"\", \"nbrOfRefills\": 2, \"ndc\": \"00172-2908-80\", \"ndcValidatedBy\": \"\", \"ndcValidatedById\": \"\", \"newDrug\": \"\", \"nextPossibleFill\": \"OCT 18,2015\", \"nextPossibleFillFHIR\": \"2015-10-18\", \"nextPossibleFillFM\": 3151018, \"nextPossibleFillHL7\": 20151018, \"oerrSig\": \"YES\", \"oerrSigCd\": 1, \"orderConverted\": \"EXPIRATION TO CPRS\", \"orderConvertedCd\": 2, \"originalQty\": \"\", \"otherPatientInstructions\": \"\", \"patient\": \"TRASH,TONY\", \"patientICN\": \"5000000364V598024\", \"patientId\": 100860, \"patientInstructions\": \"\", \"patientStatus\": \"SC\", \"patientStatusId\": 1, \"patrxIen\": 404407, \"pendingNextPossibleFilldate\": \"\", \"pendingNextPossibleFilldateFHIR\": \"\", \"pendingNextPossibleFilldateFM\": \"\", \"pendingNextPossibleFilldateHL7\": \"\", \"pfssAccountReference\": \"\", \"pfssAccountReferenceId\": \"\", \"pfssChargeId\": \"\", \"pharmacist\": \"\", \"pharmacistId\": \"\", \"pharmacistResId\": \"\", \"pharmacyInstructions\": \"TAKE ONE TABLET PO BID\", \"pharmacyOrderableItem\": \"FUROSEMIDE\", \"pharmacyOrderableItemId\": 282, \"placerOrder\": 38947, \"poeRx\": \"YES\", \"poeRxCd\": 1, \"previousOrder\": 501012, \"previousOrderId\": 404238, \"previousOrderResId\": \"V-500-52-404238\", \"priorFillDate\": \"JAN 2,2015\", \"priorFillDateFHIR\": \"2015-01-02\", \"priorFillDateFM\": 3150102, \"priorFillDateHL7\": 20150102, \"proj112Shad\": \"\", \"proj112ShadCd\": \"\", \"provider\": \"PROVIDER,FIVE\", \"providerComments\": \"\", \"providerId\": 988, \"providerNPI\": 9990000397, \"providerResId\": \"V-500-200-988\", \"qty\": 180, \"reTransmitFlag\": \"\", \"reTransmitFlagCd\": \"\", \"refills\": { \"refill\": [ { \"administeredInClinic\": \"\", \"administeredInClinicCd\": \"\", \"billingEligibilityIndicator\": \"\", \"billingEligibilityIndicatorCd\": \"\", \"bingoWaitTime\": \"\", \"checkingPharmacist\": \"\", \"checkingPharmacistId\": \"\", \"checkingPharmacistResId\": \"\", \"clerkCode\": \"\", \"clerkCodeId\": \"\", \"copayExceedingCap\": \"\", \"copayExceedingCapId\": \"\", \"currentUnitPriceOfDrug\": \"\", \"dateNdcValidated\": \"\", \"dateNdcValidatedFHIR\": \"\", \"dateNdcValidatedFM\": \"\", \"dateNdcValidatedHL7\": \"\", \"dawCode\": \"\", \"daysSupply\": 90, \"dispensedDate\": \"JAN 2,2015\", \"dispensedDateFHIR\": \"2015-01-02\", \"dispensedDateFM\": 3150102, \"dispensedDateHL7\": 20150102, \"division\": \"\", \"divisionId\": \"\", \"drugExpirationDate\": \"\", \"drugExpirationDateFHIR\": \"\", \"drugExpirationDateFM\": \"\", \"drugExpirationDateHL7\": \"\", \"epharmacySuspenseHoldDate\": \"\", \"epharmacySuspenseHoldDateFHIR\": \"\", \"epharmacySuspenseHoldDateFM\": \"\", \"epharmacySuspenseHoldDateHL7\": \"\", \"fillingPerson\": \"\", \"fillingPersonId\": \"\", \"genericProvider\": \"\", \"ibNumber\": \"\", \"ibNumberId\": \"\", \"loginDate\": \"JAN 2,2015\", \"loginDateFHIR\": \"2015-01-02\", \"loginDateFM\": 3150102, \"loginDateHL7\": 20150102, \"lot\": \"\", \"mailWindow\": \"WINDOW\", \"mailWindowCd\": \"W\", \"manufacturer\": \"\", \"ndc\": \"00172-2908-80\", \"ndcValidatedBy\": \"\", \"ndcValidatedById\": \"\", \"pfssAccountReference\": \"\", \"pfssAccountReferenceId\": \"\", \"pfssChargeId\": \"\", \"pharmacistName\": \"\", \"pharmacistNameId\": 0, \"provider\": \"\", \"providerId\": \"\", \"providerNPI\": \"\", \"providerResId\": \"\", \"qty\": 180, \"reTransmitFlag\": \"\", \"reTransmitFlagCd\": \"\", \"refillDate\": \"JAN 2,2015\", \"refillDateFHIR\": \"2015-01-02\", \"refillDateFM\": 3150102, \"refillDateHL7\": 20150102, \"releasedDateTime\": \"JAN 2,2015\", \"releasedDateTimeFHIR\": \"2015-01-02\", \"releasedDateTimeFM\": 3150102, \"releasedDateTimeHL7\": 20150102, \"remarks\": \"\", \"resourceId\": \"V-500-52-404238-52.1-1\", \"returnedToStock\": \"\", \"returnedToStockFHIR\": \"\", \"returnedToStockFM\": \"\", \"returnedToStockHL7\": \"\" } ] }, \"releasedDateTime\": \"\", \"releasedDateTimeFHIR\": \"\", \"releasedDateTimeFM\": \"\", \"releasedDateTimeHL7\": \"\", \"remarks\": \"RENEWED FROM RX # 501012\", \"reprint\": \"\", \"reprintCd\": \"\", \"resourceId\": \"V-500-52-404407\", \"resourceType\": \"PatientPrescription\", \"returnedToStock\": \"\", \"returnedToStockFHIR\": \"\", \"returnedToStockFM\": \"\", \"returnedToStockHL7\": \"\", \"rx\": \"501012A\", \"rxnorm\": \"code not mapped\", \"serviceConnected\": \"\", \"serviceConnectedCd\": \"\", \"severity\": \"\", \"sig\": \"\", \"signatureStatus\": \"\", \"signatureStatusCd\": \"\", \"southwestAsiaConditions\": \"\", \"southwestAsiaConditionsCd\": \"\", \"status\": \"EXPIRED\", \"statusCd\": 11, \"titrationDoseRx\": \"\", \"titrationDoseRxId\": \"\", \"titrationRxFlag\": \"\", \"titrationRxFlagCd\": \"\", \"tpbRx\": \"\", \"tpbRxCd\": \"\", \"tradeName\": \"\", \"typeOfRx\": 0, \"unitPriceOfDrug\": \"0.0113\", \"verifyingPharmacist\": \"\", \"verifyingPharmacistId\": \"\", \"verifyingPharmacistResId\": \"\", \"wasCounselingUnderstood\": \"\", \"wasCounselingUnderstoodCd\": \"\", \"wasThePatientCounseled\": \"NO\", \"wasThePatientCounseledCd\": 0, \"wbcResults\": \"\" }, \"Phpat\": { \"ConversionCompleted\": \"IV VERIFIED\", \"ConversionCompletedCd\": 3, \"activeScriptsC\": 0, \"actualHistoricalFlag\": \"ACTUAL\", \"actualHistoricalFlagCd\": \"A\", \"cap\": \"SAFETY\", \"capCd\": 0, \"clozapineRegistrationNumber\": \"\", \"clozapineStatus\": \"\", \"clozapineStatusCd\": \"\", \"comments\": \"\", \"communityNursingHome\": \"\", \"communityNursingHomeCd\": \"\", \"dateOfLastClozapineRx\": \"\", \"dateOfLastClozapineRxFHIR\": \"\", \"dateOfLastClozapineRxFM\": \"\", \"dateOfLastClozapineRxHL7\": \"\", \"demographicsSent\": \"\", \"demographicsSentCd\": \"\", \"dialysisPatient\": \"NO\", \"dialysisPatientCd\": 0, \"firstServiceDate\": \"APR 21,2015@13:58\", \"firstServiceDateFHIR\": \"2015-04-21T13:58:00-05:00\", \"firstServiceDateFM\": 3150421.1358, \"firstServiceDateHL7\": \"201504211358-0500\", \"holdReason\": \"\", \"inpatientNarrative\": \"\", \"lastDateOfContract\": \"\", \"lastDateOfContractFHIR\": \"\", \"lastDateOfContractFM\": \"\", \"lastDateOfContractHL7\": \"\", \"mail\": \"REGULAR MAIL\", \"mailCd\": 0, \"mailStatusExpirationDate\": \"\", \"mailStatusExpirationDateFHIR\": \"\", \"mailStatusExpirationDateFM\": \"\", \"mailStatusExpirationDateHL7\": \"\", \"name\": \"TRASH,TONY\", \"nameICN\": \"5000000364V598024\", \"nameId\": 100860, \"narrative\": \"\", \"number\": 100860, \"nursingHomeContract\": \"\", \"nursingHomeContractCd\": \"\", \"otherLanguagePreference\": \"\", \"otherLanguagePreferenceCd\": \"\", \"patientStatus\": \"SC\", \"patientStatusId\": 1, \"phpatIen\": 100860, \"pmiLanguagePreference\": \"ENGLISH\", \"pmiLanguagePreferenceCd\": 1, \"prescriptionProfiles\": { \"prescriptionProfile\": [ { \"activeC\": 0, \"drugC\": \"FUROSEMIDE 20MG TAB\", \"prescriptionProfile\": 501012, \"prescriptionProfileId\": 404238, \"resourceId\": \"V-500-55-100860-55.03-1\", \"statusC\": \"DISCONTINUED\" }, { \"activeC\": 0, \"drugC\": \"CETIRIZINE 10MG CAP,ORAL\", \"prescriptionProfile\": 501087, \"prescriptionProfileId\": 404347, \"resourceId\": \"V-500-55-100860-55.03-2\", \"statusC\": \"DISCONTINUED\" }, { \"activeC\": 0, \"drugC\": \"MOMETASONE FUROATE 50MCG 120D NASAL SUSP\", \"prescriptionProfile\": 501088, \"prescriptionProfileId\": 404348, \"resourceId\": \"V-500-55-100860-55.03-3\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"ACETAMINOPHEN 325MG TAB\", \"prescriptionProfile\": 501111, \"prescriptionProfileId\": 404392, \"resourceId\": \"V-500-55-100860-55.03-4\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"FUROSEMIDE 20MG TAB\", \"prescriptionProfile\": 501112, \"prescriptionProfileId\": 404393, \"resourceId\": \"V-500-55-100860-55.03-5\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"ALCOHOL PREP PAD\", \"prescriptionProfile\": 501113, \"prescriptionProfileId\": 404394, \"resourceId\": \"V-500-55-100860-55.03-6\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"CETIRIZINE 10MG CAP,ORAL\", \"prescriptionProfile\": \"501087A\", \"prescriptionProfileId\": 404405, \"resourceId\": \"V-500-55-100860-55.03-7\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"METOPROLOL TARTRATE 50MG TAB\", \"prescriptionProfile\": 501117, \"prescriptionProfileId\": 404406, \"resourceId\": \"V-500-55-100860-55.03-8\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"FUROSEMIDE 20MG TAB\", \"prescriptionProfile\": \"501012A\", \"prescriptionProfileId\": 404407, \"resourceId\": \"V-500-55-100860-55.03-9\", \"statusC\": \"EXPIRED\" } ] }, \"registrationDate\": \"\", \"registrationDateFHIR\": \"\", \"registrationDateFM\": \"\", \"registrationDateHL7\": \"\", \"resourceId\": \"V-500-55-100860\", \"resourceType\": \"Medication\", \"respitePatientEndDate\": \"\", \"respitePatientEndDateFHIR\": \"\", \"respitePatientEndDateFM\": \"\", \"respitePatientEndDateHL7\": \"\", \"respitePatientStartDate\": \"\", \"respitePatientStartDateFHIR\": \"\", \"respitePatientStartDateFM\": \"\", \"respitePatientStartDateHL7\": \"\", \"responsibleProvider\": \"\", \"responsibleProviderId\": \"\", \"responsibleProviderNPI\": \"\", \"responsibleProviderResId\": \"\", \"rxUpdate\": \"\", \"rxUpdateCd\": \"\", \"udDefaultStopDateTime\": \"JUL 4,2015@09:44\", \"udDefaultStopDateTimeFHIR\": \"2015-07-04T09:44:00-05:00\", \"udDefaultStopDateTimeFM\": 3150704.0944, \"udDefaultStopDateTimeHL7\": \"201507040944-0500\", \"udDischargeFlag\": \"\", \"udDischargeFlagCd\": \"\", \"udExpUpDate\": \"\", \"udExpUpDateFHIR\": \"\", \"udExpUpDateFM\": \"\", \"udExpUpDateHL7\": \"\", \"udHoldFlag\": \"\", \"udHoldFlagCd\": \"\", \"udLastAdmissionDate\": \"\", \"udLastAdmissionDateFHIR\": \"\", \"udLastAdmissionDateFM\": \"\", \"udLastAdmissionDateHL7\": \"\", \"udLastDischargeDate\": \"\", \"udLastDischargeDateFHIR\": \"\", \"udLastDischargeDateFM\": \"\", \"udLastDischargeDateHL7\": \"\", \"udLastTransferDate\": \"\", \"udLastTransferDateFHIR\": \"\", \"udLastTransferDateFM\": \"\", \"udLastTransferDateHL7\": \"\", \"udProvider\": \"PROVIDER,THIRTY\", \"udProviderId\": 1057, \"udProviderNPI\": 9990000660, \"unitDoses\": { \"unitDose\": [ { \"activityLogs\": { \"activityLog\": [ { \"action\": \"VERIFIED BY PHARMACIST\", \"actionId\": 22030, \"date\": \"JUN 4,2015@09:44:35\", \"dateFHIR\": \"2015-06-04T09:44:35-05:00\", \"dateFM\": 3150604.094435, \"dateHL7\": \"20150604094435-0500\", \"field\": \"\", \"oldData\": \"\", \"oldDataWordProcessing\": \"\", \"resourceId\": \"V-500-55-100860-55.06-1-55.09-1\", \"user\": 119 }, { \"action\": \"FINISHED BY PHARMACIST\", \"actionId\": 22005, \"date\": \"JUN 4,2015@09:44:32\", \"dateFHIR\": \"2015-06-04T09:44:32-05:00\", \"dateFM\": 3150604.094432, \"dateHL7\": \"20150604094432-0500\", \"field\": \"\", \"oldData\": \"\", \"oldDataWordProcessing\": \"\", \"resourceId\": \"V-500-55-100860-55.06-1-55.09-3\", \"user\": 119 } ] }, \"adminTimes\": \"\", \"appointmentDateTime\": \"JUN 4,2015@09:04:45\", \"appointmentDateTimeFHIR\": \"2015-06-04T09:04:45-05:00\", \"appointmentDateTimeFM\": 3150604.090445, \"appointmentDateTimeHL7\": \"20150604090445-0500\", \"autoCancelledFlag\": \"\", \"autoCancelledFlagCd\": \"\", \"bcmaExpiredFlag\": \"\", \"bcmaExpiredFlagCd\": \"\", \"clerk\": \"PROVIDER,THIRTY\", \"clerkId\": 1057, \"clerkResId\": \"V-500-200-1057\", \"clinic\": \"Emergency Department\", \"clinicId\": 426, \"comments\": \"\", \"dateEnteredByClerk\": \"\", \"dateEnteredByClerkFHIR\": \"\", \"dateEnteredByClerkFM\": \"\", \"dateEnteredByClerkHL7\": \"\", \"dateMarkedCancelled\": \"\", \"dateMarkedCancelledFHIR\": \"\", \"dateMarkedCancelledFM\": \"\", \"dateMarkedCancelledHL7\": \"\", \"dateRenewalMarked\": \"\", \"dateRenewalMarkedFHIR\": \"\", \"dateRenewalMarkedFM\": \"\", \"dateRenewalMarkedHL7\": \"\", \"dateVerifiedByNurse\": \"\", \"dateVerifiedByNurseFHIR\": \"\", \"dateVerifiedByNurseFM\": \"\", \"dateVerifiedByNurseHL7\": \"\", \"dateVerifiedByPharmacist\": \"JUN 4,2015@09:44:35\", \"dateVerifiedByPharmacistFHIR\": \"2015-06-04T09:44:35-05:00\", \"dateVerifiedByPharmacistFM\": 3150604.094435, \"dateVerifiedByPharmacistHL7\": \"20150604094435-0500\", \"dateVerifiedByPhysician\": \"\", \"dateVerifiedByPhysicianFHIR\": \"\", \"dateVerifiedByPhysicianFM\": \"\", \"dateVerifiedByPhysicianHL7\": \"\", \"dayLimit\": \"\", \"dispenseDrugs\": { \"dispenseDrug\": [ { \"dispenseDrug\": \"FUROSEMIDE 10MG\\/ML 4ML INJ\", \"dispenseDrugId\": 984, \"dispenseDrugName\": \"FUROSEMIDE\", \"dispenseDrugNameId\": 197, \"dispenseDrugRxNorm\": \"code not mapped\", \"extraUnitsDispensed\": \"\", \"inactiveDate\": \"\", \"inactiveDateFHIR\": \"\", \"inactiveDateFM\": \"\", \"inactiveDateHL7\": \"\", \"preExchangeUnits\": \"\", \"resourceId\": \"V-500-55-100860-55.06-1-55.07-1\", \"returns\": \"\", \"totalExtraUnitsDispensed\": \"\", \"totalPreExchangeUnits\": \"\", \"totalReturns\": \"\", \"totalUnitsDispensedC\": \"0.00\", \"unitsActuallyDispensed\": \"\", \"unitsCalledFor\": \"\", \"unitsPerDose\": 1 } ] }, \"displayStatus\": \"\", \"displayStatusCd\": \"\", \"dosageOrdered\": \"40MG\", \"dose\": \"\", \"doseLimit\": \"\", \"flagged\": \"\", \"flaggedCd\": \"\", \"followingOrder\": \"\", \"frequencyInMinutes\": \"\", \"holdDate\": \"\", \"holdDateFHIR\": \"\", \"holdDateFM\": \"\", \"holdDateHL7\": \"\", \"holdFlag\": \"\", \"holdFlagCd\": \"\", \"holdStatus\": \"\", \"holdStatusCd\": \"\", \"holdUser\": \"\", \"holdUserId\": \"\", \"hospitalSuppliedSelfMed\": \"\", \"hospitalSuppliedSelfMedCd\": \"\", \"instructions\": \"40MG\", \"labelDate\": \"\", \"labelDateFHIR\": \"\", \"labelDateFM\": \"\", \"labelDateHL7\": \"\", \"labelReason\": \"\", \"labelReasonCd\": \"\", \"lastWard\": \"\", \"lastWardId\": 0, \"logInDate\": \"JUN 4,2015@09:05\", \"logInDateFHIR\": \"2015-06-04T09:05:00-05:00\", \"logInDateFM\": 3150604.0905, \"logInDateHL7\": \"201506040905-0500\", \"markedCancelled\": \"\", \"markedCancelledCd\": \"\", \"markedCancelledUser\": \"\", \"markedCancelledUserId\": \"\", \"medRoute\": \"INTRAVENOUS\", \"medRouteId\": 14, \"mergedPatient\": \"\", \"mostRecentFlagComment\": \"\", \"natureOfOrder\": \"ELECTRONICALLY ENTERED\", \"natureOfOrderCd\": \"E\", \"notToBeGivenFlag\": \"\", \"notToBeGivenFlagCd\": \"\", \"nvFlag\": \"NO\", \"nvFlagCd\": 0, \"oerrHoldFlag\": \"\", \"oerrHoldFlagCd\": \"\", \"offHoldDate\": \"\", \"offHoldDateFHIR\": \"\", \"offHoldDateFM\": \"\", \"offHoldDateHL7\": \"\", \"offHoldFlag\": \"\", \"offHoldFlagCd\": \"\", \"offHoldUser\": \"\", \"offHoldUserId\": \"\", \"orderDate\": \"JUN 4,2015@09:05\", \"orderDateFHIR\": \"2015-06-04T09:05:00-05:00\", \"orderDateFM\": 3150604.0905, \"orderDateHL7\": \"201506040905-0500\", \"orderNumber\": 1524, \"orderableItem\": \"FUROSEMIDE\", \"orderableItemId\": 281, \"ordersFileEntry\": 38725, \"ordersFileParentOrder\": \"\", \"originalOrderNumber\": 1524, \"originalStartDateTime\": \"\", \"originalStartDateTimeFHIR\": \"\", \"originalStartDateTimeFM\": \"\", \"originalStartDateTimeHL7\": \"\", \"originalWard\": \"\", \"originalWardId\": \"\", \"patientName\": \"TRASH,TONY\", \"patientNameICN\": \"5000000364V598024\", \"patientNameId\": 100860, \"physician\": \"\", \"physicianId\": \"\", \"physicianNPI\": \"\", \"physicianResId\": \"\", \"previousOrder\": \"\", \"previousStopDateTime\": \"\", \"previousStopDateTimeFHIR\": \"\", \"previousStopDateTimeFM\": \"\", \"previousStopDateTimeHL7\": \"\", \"priority\": \"ROUTINE\", \"priorityCd\": \"R\", \"provider\": \"PROVIDER,THIRTY\", \"providerComments\": \"\", \"providerId\": 1057, \"providerNPI\": 9990000660, \"providerResId\": \"V-500-200-1057\", \"purgeFlag\": \"\", \"purgeFlagFHIR\": \"\", \"purgeFlagFM\": \"\", \"purgeFlagHL7\": \"\", \"pvFlag\": \"YES\", \"pvFlagCd\": 1, \"reasonForFollowingOrder\": \"\", \"reasonForFollowingOrderCd\": \"\", \"reasonOrderCreated\": \"NEW\", \"reasonOrderCreatedCd\": \"N\", \"renewal\": \"\", \"renewalCd\": \"\", \"renewalUser\": \"\", \"renewalUserId\": \"\", \"requestedDuration\": \"\", \"resourceId\": \"V-500-55-100860-55.06-1\", \"schedule\": \"NOW\", \"scheduleType\": \"ONE TIME\", \"scheduleTypeCd\": \"O\", \"selfMed\": \"\", \"selfMedCd\": \"\", \"siOpiFlag\": \"\", \"siOpiFlagCd\": \"\", \"specialInstructions\": \"\", \"specialInstructionsLong\": \"\", \"startDateTime\": \"JUN 4,2015@09:44\", \"startDateTimeFHIR\": \"2015-06-04T09:44:00-05:00\", \"startDateTimeFM\": 3150604.0944, \"startDateTimeHL7\": \"201506040944-0500\", \"status\": \"EXPIRED\", \"statusCd\": \"E\", \"stopDateTime\": \"JUL 4,2015@09:44\", \"stopDateTimeFHIR\": \"2015-07-04T09:44:00-05:00\", \"stopDateTimeFM\": 3150704.0944, \"stopDateTimeHL7\": \"201507040944-0500\", \"type\": \"UNIT DOSE\", \"typeCd\": \"U\", \"unit\": \"\", \"verifyingNurse\": \"\", \"verifyingNurseId\": \"\", \"verifyingNurseResId\": \"\", \"verifyingPharmacist\": \"PROGRAMMER,FIVE\", \"verifyingPharmacistId\": 119, \"verifyingPharmacistResId\": \"V-500-200-119\" } ] } } }";

        MedicationParser parser = new MedicationParser();

        List<MedicationAdministration> result = parser.parseMedicationAdmin(input);

        Assert.assertEquals("Correct number of items", 11, result.size());

        // First record, which is parsed differently than the subsequent records
        Assert.assertEquals("Correct drug name", "FUROSEMIDE 20MG TAB", result.get(0).getMedicationReference().getDisplay());
        Assert.assertEquals("Correct Status", MedicationAdministration.MedicationAdministrationStatus.COMPLETED, result.get(0).getStatus());
        BigDecimal expectedDose = new BigDecimal(20);
        Assert.assertEquals("Correct Dose Amount", 20L, result.get(0).getDosage().getDose().getValue().longValue());
        Assert.assertEquals("Correct Units", "MG", result.get(0).getDosage().getDose().getCode());
        Assert.assertEquals("Correct Route", "Oral route", result.get(0).getDosage().getRoute().getCoding().get(0).getDisplay());
        SimpleDateFormat sdf = new SimpleDateFormat("MMM dd, yyyy");
        DateTimeType expectedDate = new DateTimeType(sdf.parse("JUL 30, 2015"));
        Assert.assertEquals("Correct effective start date and time", expectedDate.toString(), result.get(0).getEffective().toString());

        //Second record
        Assert.assertEquals("Correct drug name", "FUROSEMIDE", result.get(1).getMedicationReference().getDisplay());
        Assert.assertEquals("Correct Status", MedicationAdministration.MedicationAdministrationStatus.COMPLETED, result.get(1).getStatus());
        Assert.assertEquals("Correct Dose Amount", 40L, result.get(1).getDosage().getDose().getValue().longValue());
        Assert.assertEquals("Correct Units", "MG", result.get(1).getDosage().getDose().getCode());
        Assert.assertEquals("Correct Route", "Intravenous route", result.get(1).getDosage().getRoute().getCoding().get(0).getDisplay());
        sdf = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ssX");
        expectedDate = new DateTimeType(sdf.parse("2015-06-04T09:44:00-05:00"));
        Assert.assertEquals("Correct effective start date and time", expectedDate.toString(), result.get(1).getEffective().toString());
    }

    @Test
    public void TestInvalidMedicationAdminParse() {
        String input = "-1^Patientidentifiernotrecognised";

        MedicationParser parser = new MedicationParser();

        List<MedicationAdministration> result = parser.parseMedicationAdmin(input);

        Assert.assertEquals("Correct number of items", 0, result.size());
    }

    @Test
    public void TestNoRecordsMedicationAdminParse() {
        String input = "{}";

        MedicationParser parser = new MedicationParser();

        List<MedicationAdministration> result = parser.parseMedicationAdmin(input);

        Assert.assertEquals("Correct number of items", 0, result.size());
    }

    @Test
    public void TestSuccessfulDispenseParse() throws ParseException {
        String input = "{ \"Patrx\": { \"activityLogs\": { \"activityLog\": [ { \"activityLog\": \"JUL 30,2015\", \"activityLogFHIR\": \"2015-07-30\", \"activityLogFM\": 3150730, \"activityLogHL7\": 20150730, \"comment\": \"Patient Instructions Not Sent By Provider.\", \"fieldEdited\": \"\", \"initiatorOfActivity\": \"\", \"initiatorOfActivityId\": \"\", \"newValue\": \"\", \"oldValue\": \"\", \"reason\": \"PATIENT INST\", \"reasonCd\": \"G\", \"resourceId\": \"V-500-52-404406-52.3-1\", \"rxReference\": \"ORIGINAL\" }, { \"activityLog\": \"JUL 30,2015@17:23:53\", \"activityLogFHIR\": \"2015-07-30T17:23:53-05:00\", \"activityLogFM\": 3150730.172353, \"activityLogHL7\": \"20150730172353-0500\", \"comment\": \"Discontinued by OE\\/RR.\", \"fieldEdited\": \"\", \"initiatorOfActivity\": \"PROVIDER,FIVE\", \"initiatorOfActivityId\": 988, \"newValue\": \"\", \"oldValue\": \"\", \"otherCommentss\": { \"otherComments\": [ { \"otherComments\": \"PATIENT LOST HIS NOSE\", \"resourceId\": \"V-500-52-404348-52.3-2-52.34-1\" } ] }, \"reason\": \"DISCONTINUED\", \"reasonCd\": \"C\", \"resourceId\": \"V-500-52-404393-52.3-2\", \"rxReference\": \"ORIGINAL\" }, { \"activityLog\": \"JUL 30,2015@17:59\", \"activityLogFHIR\": \"2015-07-30T17:59:00-05:00\", \"activityLogFM\": 3150730.1759, \"activityLogHL7\": \"201507301759-0500\", \"comment\": \"RX placed in a HOLD status (07-30-15) by OERR.\", \"fieldEdited\": \"\", \"initiatorOfActivity\": \"PROVIDER,FIVE\", \"initiatorOfActivityId\": 988, \"newValue\": \"\", \"oldValue\": \"\", \"reason\": \"HOLD\", \"reasonCd\": \"H\", \"resourceId\": \"V-500-52-404392-52.3-3\", \"rxReference\": \"ORIGINAL\" }, { \"activityLog\": \"JUL 30,2015@17:47:26\", \"activityLogFHIR\": \"2015-07-30T17:47:26-05:00\", \"activityLogFM\": 3150730.174726, \"activityLogHL7\": \"20150730174726-0500\", \"comment\": \"Renewed from CPRS\", \"fieldEdited\": \"\", \"initiatorOfActivity\": \"PROGRAMMER,FIVE\", \"initiatorOfActivityId\": 119, \"newValue\": \"\", \"oldValue\": \"\", \"reason\": \"RENEWED\", \"reasonCd\": \"L\", \"resourceId\": \"V-500-52-404347-52.3-4\", \"rxReference\": \"ORIGINAL\" } ] }, \"administeredInClinic\": \"\", \"administeredInClinicCd\": \"\", \"affectedMedication\": \"\", \"agentOrangeExposure\": \"\", \"agentOrangeExposureCd\": \"\", \"ancResults\": \"\", \"archived\": \"\", \"archivedCd\": \"\", \"backdoorSignatureStatus\": \"\", \"backdoorSignatureStatusCd\": \"\", \"billingEligibilityIndicator\": \"\", \"billingEligibilityIndicatorCd\": \"\", \"bingoWaitTime\": \"\", \"cancelDate\": \"\", \"cancelDateFHIR\": \"\", \"cancelDateFM\": \"\", \"cancelDateHL7\": \"\", \"checkingPharmacist\": \"\", \"checkingPharmacistId\": \"\", \"checkingPharmacistResId\": \"\", \"clinic\": \"AUDIOLOGY\", \"clinicId\": 64, \"clozapineDosageMgDay\": \"\", \"combatVeteran\": \"\", \"combatVeteranCd\": \"\", \"copayExceedingCap\": \"\", \"copayExceedingCapId\": \"\", \"copayTransactionType\": \"\", \"copayTransactionTypeId\": \"\", \"copayTypeAudit\": \"\", \"copies\": 1, \"cosigningPhysician\": \"\", \"cosigningPhysicianId\": \"\", \"cosigningPhysicianNPI\": \"\", \"cosigningPhysicianResId\": \"\", \"dateNdcValidated\": \"\", \"dateNdcValidatedFHIR\": \"\", \"dateNdcValidatedFM\": \"\", \"dateNdcValidatedHL7\": \"\", \"dateOfDeathHistory\": \"\", \"dateOfWbcTest\": \"\", \"dateOfWbcTestFHIR\": \"\", \"dateOfWbcTestFM\": \"\", \"dateOfWbcTestHL7\": \"\", \"dawCode\": 0, \"daysSupply\": 90, \"ddstatus\": \"\", \"deletionComments\": \"\", \"discontinueType\": \"\", \"discontinueTypeCd\": \"\", \"dispensedDate\": \"JUL 30,2015\", \"dispensedDateFHIR\": \"2015-07-30\", \"dispensedDateFM\": 3150730, \"dispensedDateHL7\": 20150730, \"division\": \"VEHU SITE\", \"divisionId\": 2, \"drug\": \"FUROSEMIDE 20MG TAB\", \"drugAllergyIndication\": \"\", \"drugAllergyIndicationCd\": \"\", \"drugExpirationDate\": \"\", \"drugExpirationDateFHIR\": \"\", \"drugExpirationDateFM\": \"\", \"drugExpirationDateHL7\": \"\", \"drugId\": 3963, \"enteredBy\": \"PROVIDER,FIVE\", \"enteredById\": 988, \"epharmacySuspenseHoldDate\": \"\", \"epharmacySuspenseHoldDateFHIR\": \"\", \"epharmacySuspenseHoldDateFM\": \"\", \"epharmacySuspenseHoldDateHL7\": \"\", \"expandedPatientInstructions\": \"\", \"expirationDate\": \"JUL 30,2016\", \"expirationDateFHIR\": \"2016-07-30\", \"expirationDateFM\": 3160730, \"expirationDateHL7\": 20160730, \"externalApplication\": \"\", \"externalPlacerOrderNumber\": \"\", \"fillDate\": \"JUL 30,2015\", \"fillDateFHIR\": \"2015-07-30\", \"fillDateFM\": 3150730, \"fillDateHL7\": 20150730, \"fillingPerson\": \"\", \"fillingPersonId\": \"\", \"finishDateTime\": \"JUL 30,2015@17:55:56\", \"finishDateTimeFHIR\": \"2015-07-30T17:55:56-05:00\", \"finishDateTimeFM\": 3150730.175556, \"finishDateTimeHL7\": \"20150730175556-0500\", \"finishingPerson\": \"PROGRAMMER,FIVE\", \"finishingPersonId\": 119, \"forwardOrder\": \"\", \"forwardOrderId\": \"\", \"forwardOrderResId\": \"\", \"genericProvider\": \"\", \"headAndOrNeckCancer\": \"\", \"headAndOrNeckCancerCd\": \"\", \"holdComments\": \"\", \"holdDate\": \"\", \"holdDateFHIR\": \"\", \"holdDateFM\": \"\", \"holdDateHL7\": \"\", \"holdReason\": \"\", \"holdReasonCd\": \"\", \"hospitalCoverage\": 0, \"ibNumber\": \"\", \"ibNumberId\": \"\", \"icdDiagnosiss\": { \"icdDiagnosis\": [ { \"agentOrange\": \"\", \"agentOrangeCd\": \"\", \"combatVeteran\": \"\", \"combatVeteranCd\": \"\", \"headAndOrNeckCancer\": \"\", \"headAndOrNeckCancerCd\": \"\", \"icdDiagnosis\": \"\", \"icdDiagnosisId\": \"\", \"icdDiagnosisSCT\": \"\", \"icdDiagnosisText\": \"\", \"ionizingRadiation\": \"\", \"ionizingRadiationCd\": \"\", \"militarySexualTrauma\": \"\", \"militarySexualTraumaCd\": \"\", \"proj112Shad\": \"\", \"proj112ShadCd\": \"\", \"resourceId\": \"V-500-52-404407-52.052311-1\", \"serviceConnection\": \"NO\", \"serviceConnectionCd\": 0, \"southwestAsiaConditions\": \"\", \"southwestAsiaConditionsCd\": \"\" } ] }, \"ionizingRadiationExposure\": \"\", \"ionizingRadiationExposureCd\": \"\", \"issueDate\": \"JUL 30,2015\", \"issueDateFHIR\": \"2015-07-30\", \"issueDateFM\": 3150730, \"issueDateHL7\": 20150730, \"labelDateTimes\": { \"labelDateTime\": [ { \"device\": \"\", \"fdaMedGuideFilename\": \"\", \"labelComment\": \"From RX number 501113\", \"labelDateTime\": \"JUL 22,2015@17:53:25\", \"labelDateTimeFHIR\": \"2015-07-22T17:53:25-05:00\", \"labelDateTimeFM\": 3150722.175325, \"labelDateTimeHL7\": \"20150722175325-0500\", \"printedBy\": \"PROGRAMMER,FIVE\", \"printedById\": 119, \"resourceId\": \"V-500-52-404394-52.032-1\", \"rxReference\": \"ORIGINAL\", \"warningLabelType\": \"\", \"warningLabelTypeCd\": \"\" } ] }, \"lastDispensedDate\": \"JUL 30,2015\", \"lastDispensedDateFHIR\": \"2015-07-30\", \"lastDispensedDateFM\": 3150730, \"lastDispensedDateHL7\": 20150730, \"lastDispensedDateHolder\": \"APR 21,2014\", \"lastDispensedDateHolderFHIR\": \"2014-04-21\", \"lastDispensedDateHolderFM\": 3140421, \"lastDispensedDateHolderHL7\": 20140421, \"loginDate\": \"JUL 30,2015@17:40:41\", \"loginDateFHIR\": \"2015-07-30T17:40:41-05:00\", \"loginDateFM\": 3150730.174041, \"loginDateHL7\": \"20150730174041-0500\", \"lot\": \"\", \"mailWindow\": \"WINDOW\", \"mailWindowCd\": \"W\", \"maintenanceDoseRx\": \"\", \"maintenanceDoseRxId\": \"\", \"manufacturer\": \"\", \"medicationInstructionss\": { \"medicationInstructions\": [ { \"conjunction\": \"\", \"conjunctionCd\": \"\", \"dispenseUnitsPerDose\": 1, \"dosageOrdered\": 20, \"duration\": \"\", \"noun\": \"TABLET\", \"otherLanguageDosage\": \"\", \"resourceId\": \"V-500-52-404407-52.0113-1\", \"route\": \"ORAL (BY MOUTH)\", \"routeId\": 1, \"schedule\": \"BID\", \"units\": \"MG\", \"unitsId\": 20, \"verb\": \"TAKE\" } ] }, \"methodOfPickUp\": \"\", \"militarySexualTrauma\": \"\", \"militarySexualTraumaCd\": \"\", \"nbrOfRefills\": 2, \"ndc\": \"00172-2908-80\", \"ndcValidatedBy\": \"\", \"ndcValidatedById\": \"\", \"newDrug\": \"\", \"nextPossibleFill\": \"OCT 18,2015\", \"nextPossibleFillFHIR\": \"2015-10-18\", \"nextPossibleFillFM\": 3151018, \"nextPossibleFillHL7\": 20151018, \"oerrSig\": \"YES\", \"oerrSigCd\": 1, \"orderConverted\": \"EXPIRATION TO CPRS\", \"orderConvertedCd\": 2, \"originalQty\": \"\", \"otherPatientInstructions\": \"\", \"patient\": \"TRASH,TONY\", \"patientICN\": \"5000000364V598024\", \"patientId\": 100860, \"patientInstructions\": \"\", \"patientStatus\": \"SC\", \"patientStatusId\": 1, \"patrxIen\": 404407, \"pendingNextPossibleFilldate\": \"\", \"pendingNextPossibleFilldateFHIR\": \"\", \"pendingNextPossibleFilldateFM\": \"\", \"pendingNextPossibleFilldateHL7\": \"\", \"pfssAccountReference\": \"\", \"pfssAccountReferenceId\": \"\", \"pfssChargeId\": \"\", \"pharmacist\": \"\", \"pharmacistId\": \"\", \"pharmacistResId\": \"\", \"pharmacyInstructions\": \"TAKE ONE TABLET PO BID\", \"pharmacyOrderableItem\": \"FUROSEMIDE\", \"pharmacyOrderableItemId\": 282, \"placerOrder\": 38947, \"poeRx\": \"YES\", \"poeRxCd\": 1, \"previousOrder\": 501012, \"previousOrderId\": 404238, \"previousOrderResId\": \"V-500-52-404238\", \"priorFillDate\": \"JAN 2,2015\", \"priorFillDateFHIR\": \"2015-01-02\", \"priorFillDateFM\": 3150102, \"priorFillDateHL7\": 20150102, \"proj112Shad\": \"\", \"proj112ShadCd\": \"\", \"provider\": \"PROVIDER,FIVE\", \"providerComments\": \"\", \"providerId\": 988, \"providerNPI\": 9990000397, \"providerResId\": \"V-500-200-988\", \"qty\": 180, \"reTransmitFlag\": \"\", \"reTransmitFlagCd\": \"\", \"refills\": { \"refill\": [ { \"administeredInClinic\": \"\", \"administeredInClinicCd\": \"\", \"billingEligibilityIndicator\": \"\", \"billingEligibilityIndicatorCd\": \"\", \"bingoWaitTime\": \"\", \"checkingPharmacist\": \"\", \"checkingPharmacistId\": \"\", \"checkingPharmacistResId\": \"\", \"clerkCode\": \"\", \"clerkCodeId\": \"\", \"copayExceedingCap\": \"\", \"copayExceedingCapId\": \"\", \"currentUnitPriceOfDrug\": \"\", \"dateNdcValidated\": \"\", \"dateNdcValidatedFHIR\": \"\", \"dateNdcValidatedFM\": \"\", \"dateNdcValidatedHL7\": \"\", \"dawCode\": \"\", \"daysSupply\": 90, \"dispensedDate\": \"JAN 2,2015\", \"dispensedDateFHIR\": \"2015-01-02\", \"dispensedDateFM\": 3150102, \"dispensedDateHL7\": 20150102, \"division\": \"\", \"divisionId\": \"\", \"drugExpirationDate\": \"\", \"drugExpirationDateFHIR\": \"\", \"drugExpirationDateFM\": \"\", \"drugExpirationDateHL7\": \"\", \"epharmacySuspenseHoldDate\": \"\", \"epharmacySuspenseHoldDateFHIR\": \"\", \"epharmacySuspenseHoldDateFM\": \"\", \"epharmacySuspenseHoldDateHL7\": \"\", \"fillingPerson\": \"\", \"fillingPersonId\": \"\", \"genericProvider\": \"\", \"ibNumber\": \"\", \"ibNumberId\": \"\", \"loginDate\": \"JAN 2,2015\", \"loginDateFHIR\": \"2015-01-02\", \"loginDateFM\": 3150102, \"loginDateHL7\": 20150102, \"lot\": \"\", \"mailWindow\": \"WINDOW\", \"mailWindowCd\": \"W\", \"manufacturer\": \"\", \"ndc\": \"00172-2908-80\", \"ndcValidatedBy\": \"\", \"ndcValidatedById\": \"\", \"pfssAccountReference\": \"\", \"pfssAccountReferenceId\": \"\", \"pfssChargeId\": \"\", \"pharmacistName\": \"\", \"pharmacistNameId\": 0, \"provider\": \"\", \"providerId\": \"\", \"providerNPI\": \"\", \"providerResId\": \"\", \"qty\": 180, \"reTransmitFlag\": \"\", \"reTransmitFlagCd\": \"\", \"refillDate\": \"JAN 2,2015\", \"refillDateFHIR\": \"2015-01-02\", \"refillDateFM\": 3150102, \"refillDateHL7\": 20150102, \"releasedDateTime\": \"JAN 2,2015\", \"releasedDateTimeFHIR\": \"2015-01-02\", \"releasedDateTimeFM\": 3150102, \"releasedDateTimeHL7\": 20150102, \"remarks\": \"\", \"resourceId\": \"V-500-52-404238-52.1-1\", \"returnedToStock\": \"\", \"returnedToStockFHIR\": \"\", \"returnedToStockFM\": \"\", \"returnedToStockHL7\": \"\" } ] }, \"releasedDateTime\": \"\", \"releasedDateTimeFHIR\": \"\", \"releasedDateTimeFM\": \"\", \"releasedDateTimeHL7\": \"\", \"remarks\": \"RENEWED FROM RX # 501012\", \"reprint\": \"\", \"reprintCd\": \"\", \"resourceId\": \"V-500-52-404407\", \"resourceType\": \"PatientPrescription\", \"returnedToStock\": \"\", \"returnedToStockFHIR\": \"\", \"returnedToStockFM\": \"\", \"returnedToStockHL7\": \"\", \"rx\": \"501012A\", \"rxnorm\": \"code not mapped\", \"serviceConnected\": \"\", \"serviceConnectedCd\": \"\", \"severity\": \"\", \"sig\": \"\", \"signatureStatus\": \"\", \"signatureStatusCd\": \"\", \"southwestAsiaConditions\": \"\", \"southwestAsiaConditionsCd\": \"\", \"status\": \"EXPIRED\", \"statusCd\": 11, \"titrationDoseRx\": \"\", \"titrationDoseRxId\": \"\", \"titrationRxFlag\": \"\", \"titrationRxFlagCd\": \"\", \"tpbRx\": \"\", \"tpbRxCd\": \"\", \"tradeName\": \"\", \"typeOfRx\": 0, \"unitPriceOfDrug\": \"0.0113\", \"verifyingPharmacist\": \"\", \"verifyingPharmacistId\": \"\", \"verifyingPharmacistResId\": \"\", \"wasCounselingUnderstood\": \"\", \"wasCounselingUnderstoodCd\": \"\", \"wasThePatientCounseled\": \"NO\", \"wasThePatientCounseledCd\": 0, \"wbcResults\": \"\" }, \"Phpat\": { \"ConversionCompleted\": \"IV VERIFIED\", \"ConversionCompletedCd\": 3, \"activeScriptsC\": 0, \"actualHistoricalFlag\": \"ACTUAL\", \"actualHistoricalFlagCd\": \"A\", \"cap\": \"SAFETY\", \"capCd\": 0, \"clozapineRegistrationNumber\": \"\", \"clozapineStatus\": \"\", \"clozapineStatusCd\": \"\", \"comments\": \"\", \"communityNursingHome\": \"\", \"communityNursingHomeCd\": \"\", \"dateOfLastClozapineRx\": \"\", \"dateOfLastClozapineRxFHIR\": \"\", \"dateOfLastClozapineRxFM\": \"\", \"dateOfLastClozapineRxHL7\": \"\", \"demographicsSent\": \"\", \"demographicsSentCd\": \"\", \"dialysisPatient\": \"NO\", \"dialysisPatientCd\": 0, \"firstServiceDate\": \"APR 21,2015@13:58\", \"firstServiceDateFHIR\": \"2015-04-21T13:58:00-05:00\", \"firstServiceDateFM\": 3150421.1358, \"firstServiceDateHL7\": \"201504211358-0500\", \"holdReason\": \"\", \"inpatientNarrative\": \"\", \"lastDateOfContract\": \"\", \"lastDateOfContractFHIR\": \"\", \"lastDateOfContractFM\": \"\", \"lastDateOfContractHL7\": \"\", \"mail\": \"REGULAR MAIL\", \"mailCd\": 0, \"mailStatusExpirationDate\": \"\", \"mailStatusExpirationDateFHIR\": \"\", \"mailStatusExpirationDateFM\": \"\", \"mailStatusExpirationDateHL7\": \"\", \"name\": \"TRASH,TONY\", \"nameICN\": \"5000000364V598024\", \"nameId\": 100860, \"narrative\": \"\", \"number\": 100860, \"nursingHomeContract\": \"\", \"nursingHomeContractCd\": \"\", \"otherLanguagePreference\": \"\", \"otherLanguagePreferenceCd\": \"\", \"patientStatus\": \"SC\", \"patientStatusId\": 1, \"phpatIen\": 100860, \"pmiLanguagePreference\": \"ENGLISH\", \"pmiLanguagePreferenceCd\": 1, \"prescriptionProfiles\": { \"prescriptionProfile\": [ { \"activeC\": 0, \"drugC\": \"FUROSEMIDE 20MG TAB\", \"prescriptionProfile\": 501012, \"prescriptionProfileId\": 404238, \"resourceId\": \"V-500-55-100860-55.03-1\", \"statusC\": \"DISCONTINUED\" }, { \"activeC\": 0, \"drugC\": \"CETIRIZINE 10MG CAP,ORAL\", \"prescriptionProfile\": 501087, \"prescriptionProfileId\": 404347, \"resourceId\": \"V-500-55-100860-55.03-2\", \"statusC\": \"DISCONTINUED\" }, { \"activeC\": 0, \"drugC\": \"MOMETASONE FUROATE 50MCG 120D NASAL SUSP\", \"prescriptionProfile\": 501088, \"prescriptionProfileId\": 404348, \"resourceId\": \"V-500-55-100860-55.03-3\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"ACETAMINOPHEN 325MG TAB\", \"prescriptionProfile\": 501111, \"prescriptionProfileId\": 404392, \"resourceId\": \"V-500-55-100860-55.03-4\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"FUROSEMIDE 20MG TAB\", \"prescriptionProfile\": 501112, \"prescriptionProfileId\": 404393, \"resourceId\": \"V-500-55-100860-55.03-5\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"ALCOHOL PREP PAD\", \"prescriptionProfile\": 501113, \"prescriptionProfileId\": 404394, \"resourceId\": \"V-500-55-100860-55.03-6\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"CETIRIZINE 10MG CAP,ORAL\", \"prescriptionProfile\": \"501087A\", \"prescriptionProfileId\": 404405, \"resourceId\": \"V-500-55-100860-55.03-7\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"METOPROLOL TARTRATE 50MG TAB\", \"prescriptionProfile\": 501117, \"prescriptionProfileId\": 404406, \"resourceId\": \"V-500-55-100860-55.03-8\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"FUROSEMIDE 20MG TAB\", \"prescriptionProfile\": \"501012A\", \"prescriptionProfileId\": 404407, \"resourceId\": \"V-500-55-100860-55.03-9\", \"statusC\": \"EXPIRED\" } ] }, \"registrationDate\": \"\", \"registrationDateFHIR\": \"\", \"registrationDateFM\": \"\", \"registrationDateHL7\": \"\", \"resourceId\": \"V-500-55-100860\", \"resourceType\": \"Medication\", \"respitePatientEndDate\": \"\", \"respitePatientEndDateFHIR\": \"\", \"respitePatientEndDateFM\": \"\", \"respitePatientEndDateHL7\": \"\", \"respitePatientStartDate\": \"\", \"respitePatientStartDateFHIR\": \"\", \"respitePatientStartDateFM\": \"\", \"respitePatientStartDateHL7\": \"\", \"responsibleProvider\": \"\", \"responsibleProviderId\": \"\", \"responsibleProviderNPI\": \"\", \"responsibleProviderResId\": \"\", \"rxUpdate\": \"\", \"rxUpdateCd\": \"\", \"udDefaultStopDateTime\": \"JUL 4,2015@09:44\", \"udDefaultStopDateTimeFHIR\": \"2015-07-04T09:44:00-05:00\", \"udDefaultStopDateTimeFM\": 3150704.0944, \"udDefaultStopDateTimeHL7\": \"201507040944-0500\", \"udDischargeFlag\": \"\", \"udDischargeFlagCd\": \"\", \"udExpUpDate\": \"\", \"udExpUpDateFHIR\": \"\", \"udExpUpDateFM\": \"\", \"udExpUpDateHL7\": \"\", \"udHoldFlag\": \"\", \"udHoldFlagCd\": \"\", \"udLastAdmissionDate\": \"\", \"udLastAdmissionDateFHIR\": \"\", \"udLastAdmissionDateFM\": \"\", \"udLastAdmissionDateHL7\": \"\", \"udLastDischargeDate\": \"\", \"udLastDischargeDateFHIR\": \"\", \"udLastDischargeDateFM\": \"\", \"udLastDischargeDateHL7\": \"\", \"udLastTransferDate\": \"\", \"udLastTransferDateFHIR\": \"\", \"udLastTransferDateFM\": \"\", \"udLastTransferDateHL7\": \"\", \"udProvider\": \"PROVIDER,THIRTY\", \"udProviderId\": 1057, \"udProviderNPI\": 9990000660, \"unitDoses\": { \"unitDose\": [ { \"activityLogs\": { \"activityLog\": [ { \"action\": \"VERIFIED BY PHARMACIST\", \"actionId\": 22030, \"date\": \"JUN 4,2015@09:44:35\", \"dateFHIR\": \"2015-06-04T09:44:35-05:00\", \"dateFM\": 3150604.094435, \"dateHL7\": \"20150604094435-0500\", \"field\": \"\", \"oldData\": \"\", \"oldDataWordProcessing\": \"\", \"resourceId\": \"V-500-55-100860-55.06-1-55.09-1\", \"user\": 119 }, { \"action\": \"FINISHED BY PHARMACIST\", \"actionId\": 22005, \"date\": \"JUN 4,2015@09:44:32\", \"dateFHIR\": \"2015-06-04T09:44:32-05:00\", \"dateFM\": 3150604.094432, \"dateHL7\": \"20150604094432-0500\", \"field\": \"\", \"oldData\": \"\", \"oldDataWordProcessing\": \"\", \"resourceId\": \"V-500-55-100860-55.06-1-55.09-3\", \"user\": 119 } ] }, \"adminTimes\": \"\", \"appointmentDateTime\": \"JUN 4,2015@09:04:45\", \"appointmentDateTimeFHIR\": \"2015-06-04T09:04:45-05:00\", \"appointmentDateTimeFM\": 3150604.090445, \"appointmentDateTimeHL7\": \"20150604090445-0500\", \"autoCancelledFlag\": \"\", \"autoCancelledFlagCd\": \"\", \"bcmaExpiredFlag\": \"\", \"bcmaExpiredFlagCd\": \"\", \"clerk\": \"PROVIDER,THIRTY\", \"clerkId\": 1057, \"clerkResId\": \"V-500-200-1057\", \"clinic\": \"Emergency Department\", \"clinicId\": 426, \"comments\": \"\", \"dateEnteredByClerk\": \"\", \"dateEnteredByClerkFHIR\": \"\", \"dateEnteredByClerkFM\": \"\", \"dateEnteredByClerkHL7\": \"\", \"dateMarkedCancelled\": \"\", \"dateMarkedCancelledFHIR\": \"\", \"dateMarkedCancelledFM\": \"\", \"dateMarkedCancelledHL7\": \"\", \"dateRenewalMarked\": \"\", \"dateRenewalMarkedFHIR\": \"\", \"dateRenewalMarkedFM\": \"\", \"dateRenewalMarkedHL7\": \"\", \"dateVerifiedByNurse\": \"\", \"dateVerifiedByNurseFHIR\": \"\", \"dateVerifiedByNurseFM\": \"\", \"dateVerifiedByNurseHL7\": \"\", \"dateVerifiedByPharmacist\": \"JUN 4,2015@09:44:35\", \"dateVerifiedByPharmacistFHIR\": \"2015-06-04T09:44:35-05:00\", \"dateVerifiedByPharmacistFM\": 3150604.094435, \"dateVerifiedByPharmacistHL7\": \"20150604094435-0500\", \"dateVerifiedByPhysician\": \"\", \"dateVerifiedByPhysicianFHIR\": \"\", \"dateVerifiedByPhysicianFM\": \"\", \"dateVerifiedByPhysicianHL7\": \"\", \"dayLimit\": \"\", \"dispenseDrugs\": { \"dispenseDrug\": [ { \"dispenseDrug\": \"FUROSEMIDE 10MG\\/ML 4ML INJ\", \"dispenseDrugId\": 984, \"dispenseDrugName\": \"FUROSEMIDE\", \"dispenseDrugNameId\": 197, \"dispenseDrugRxNorm\": \"code not mapped\", \"extraUnitsDispensed\": \"\", \"inactiveDate\": \"\", \"inactiveDateFHIR\": \"\", \"inactiveDateFM\": \"\", \"inactiveDateHL7\": \"\", \"preExchangeUnits\": \"\", \"resourceId\": \"V-500-55-100860-55.06-1-55.07-1\", \"returns\": \"\", \"totalExtraUnitsDispensed\": \"\", \"totalPreExchangeUnits\": \"\", \"totalReturns\": \"\", \"totalUnitsDispensedC\": \"0.00\", \"unitsActuallyDispensed\": \"\", \"unitsCalledFor\": \"\", \"unitsPerDose\": 1 } ] }, \"displayStatus\": \"\", \"displayStatusCd\": \"\", \"dosageOrdered\": \"40MG\", \"dose\": \"\", \"doseLimit\": \"\", \"flagged\": \"\", \"flaggedCd\": \"\", \"followingOrder\": \"\", \"frequencyInMinutes\": \"\", \"holdDate\": \"\", \"holdDateFHIR\": \"\", \"holdDateFM\": \"\", \"holdDateHL7\": \"\", \"holdFlag\": \"\", \"holdFlagCd\": \"\", \"holdStatus\": \"\", \"holdStatusCd\": \"\", \"holdUser\": \"\", \"holdUserId\": \"\", \"hospitalSuppliedSelfMed\": \"\", \"hospitalSuppliedSelfMedCd\": \"\", \"instructions\": \"40MG\", \"labelDate\": \"\", \"labelDateFHIR\": \"\", \"labelDateFM\": \"\", \"labelDateHL7\": \"\", \"labelReason\": \"\", \"labelReasonCd\": \"\", \"lastWard\": \"\", \"lastWardId\": 0, \"logInDate\": \"JUN 4,2015@09:05\", \"logInDateFHIR\": \"2015-06-04T09:05:00-05:00\", \"logInDateFM\": 3150604.0905, \"logInDateHL7\": \"201506040905-0500\", \"markedCancelled\": \"\", \"markedCancelledCd\": \"\", \"markedCancelledUser\": \"\", \"markedCancelledUserId\": \"\", \"medRoute\": \"INTRAVENOUS\", \"medRouteId\": 14, \"mergedPatient\": \"\", \"mostRecentFlagComment\": \"\", \"natureOfOrder\": \"ELECTRONICALLY ENTERED\", \"natureOfOrderCd\": \"E\", \"notToBeGivenFlag\": \"\", \"notToBeGivenFlagCd\": \"\", \"nvFlag\": \"NO\", \"nvFlagCd\": 0, \"oerrHoldFlag\": \"\", \"oerrHoldFlagCd\": \"\", \"offHoldDate\": \"\", \"offHoldDateFHIR\": \"\", \"offHoldDateFM\": \"\", \"offHoldDateHL7\": \"\", \"offHoldFlag\": \"\", \"offHoldFlagCd\": \"\", \"offHoldUser\": \"\", \"offHoldUserId\": \"\", \"orderDate\": \"JUN 4,2015@09:05\", \"orderDateFHIR\": \"2015-06-04T09:05:00-05:00\", \"orderDateFM\": 3150604.0905, \"orderDateHL7\": \"201506040905-0500\", \"orderNumber\": 1524, \"orderableItem\": \"FUROSEMIDE\", \"orderableItemId\": 281, \"ordersFileEntry\": 38725, \"ordersFileParentOrder\": \"\", \"originalOrderNumber\": 1524, \"originalStartDateTime\": \"\", \"originalStartDateTimeFHIR\": \"\", \"originalStartDateTimeFM\": \"\", \"originalStartDateTimeHL7\": \"\", \"originalWard\": \"\", \"originalWardId\": \"\", \"patientName\": \"TRASH,TONY\", \"patientNameICN\": \"5000000364V598024\", \"patientNameId\": 100860, \"physician\": \"\", \"physicianId\": \"\", \"physicianNPI\": \"\", \"physicianResId\": \"\", \"previousOrder\": \"\", \"previousStopDateTime\": \"\", \"previousStopDateTimeFHIR\": \"\", \"previousStopDateTimeFM\": \"\", \"previousStopDateTimeHL7\": \"\", \"priority\": \"ROUTINE\", \"priorityCd\": \"R\", \"provider\": \"PROVIDER,THIRTY\", \"providerComments\": \"\", \"providerId\": 1057, \"providerNPI\": 9990000660, \"providerResId\": \"V-500-200-1057\", \"purgeFlag\": \"\", \"purgeFlagFHIR\": \"\", \"purgeFlagFM\": \"\", \"purgeFlagHL7\": \"\", \"pvFlag\": \"YES\", \"pvFlagCd\": 1, \"reasonForFollowingOrder\": \"\", \"reasonForFollowingOrderCd\": \"\", \"reasonOrderCreated\": \"NEW\", \"reasonOrderCreatedCd\": \"N\", \"renewal\": \"\", \"renewalCd\": \"\", \"renewalUser\": \"\", \"renewalUserId\": \"\", \"requestedDuration\": \"\", \"resourceId\": \"V-500-55-100860-55.06-1\", \"schedule\": \"NOW\", \"scheduleType\": \"ONE TIME\", \"scheduleTypeCd\": \"O\", \"selfMed\": \"\", \"selfMedCd\": \"\", \"siOpiFlag\": \"\", \"siOpiFlagCd\": \"\", \"specialInstructions\": \"\", \"specialInstructionsLong\": \"\", \"startDateTime\": \"JUN 4,2015@09:44\", \"startDateTimeFHIR\": \"2015-06-04T09:44:00-05:00\", \"startDateTimeFM\": 3150604.0944, \"startDateTimeHL7\": \"201506040944-0500\", \"status\": \"EXPIRED\", \"statusCd\": \"E\", \"stopDateTime\": \"JUL 4,2015@09:44\", \"stopDateTimeFHIR\": \"2015-07-04T09:44:00-05:00\", \"stopDateTimeFM\": 3150704.0944, \"stopDateTimeHL7\": \"201507040944-0500\", \"type\": \"UNIT DOSE\", \"typeCd\": \"U\", \"unit\": \"\", \"verifyingNurse\": \"\", \"verifyingNurseId\": \"\", \"verifyingNurseResId\": \"\", \"verifyingPharmacist\": \"PROGRAMMER,FIVE\", \"verifyingPharmacistId\": 119, \"verifyingPharmacistResId\": \"V-500-200-119\" } ] } } }";

        MedicationParser parser = new MedicationParser();

        List<MedicationDispense> result = parser.parseMedicationDispense(input);

        Assert.assertEquals("Correct number of items", 11, result.size());

        // First record, which is parsed differently than the subsequent records
        Assert.assertEquals("Correct drug name", "FUROSEMIDE 20MG TAB", result.get(0).getMedicationReference().getDisplay());
        Assert.assertEquals("Correct Status", MedicationDispense.MedicationDispenseStatus.COMPLETED, result.get(0).getStatus());
        BigDecimal expectedDose = new BigDecimal(20);
        Assert.assertEquals("Correct Dose Amount", 20L, result.get(0).getDosageInstruction().get(0).getDoseSimpleQuantity().getValue().longValue());
        Assert.assertEquals("Correct Units", "MG", result.get(0).getDosageInstruction().get(0).getDoseSimpleQuantity().getCode());
        Assert.assertEquals("Correct Route", "Oral route", result.get(0).getDosageInstruction().get(0).getRoute().getCoding().get(0).getDisplay());
        SimpleDateFormat sdf = new SimpleDateFormat("MMM dd, yyyy");
        Date expectedDate = sdf.parse("JUL 30, 2015");
        Assert.assertEquals("Correct effective start date and time", expectedDate, result.get(0).getWhenHandedOver());

        //Second record
        Assert.assertEquals("Correct drug name", "FUROSEMIDE", result.get(1).getMedicationReference().getDisplay());
        Assert.assertEquals("Correct Status", MedicationDispense.MedicationDispenseStatus.COMPLETED, result.get(1).getStatus());
        Assert.assertEquals("Correct Dose Amount", 40L, result.get(1).getDosageInstruction().get(0).getDoseSimpleQuantity().getValue().longValue());
        Assert.assertEquals("Correct Units", "MG", result.get(1).getDosageInstruction().get(0).getDoseSimpleQuantity().getCode());
        sdf = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ssX");
        expectedDate = sdf.parse("2015-06-04T09:44:00-05:00");
        Assert.assertEquals("Correct Route", "Intravenous route", result.get(1).getDosageInstruction().get(0).getRoute().getCoding().get(0).getDisplay());
        Assert.assertEquals("Correct effective start date and time", expectedDate, result.get(1).getWhenHandedOver());
    }

    @Test
    public void TestInvalidDispenseParse() {
        String input = "-1^Patientidentifiernotrecognised";

        MedicationParser parser = new MedicationParser();

        List<MedicationDispense> result = parser.parseMedicationDispense(input);

        Assert.assertEquals("Correct number of items", 0, result.size());
    }

    @Test
    public void TestSuccessfulMedicationStatementParse() throws ParseException {
        String input = "{ \"Patrx\": { \"activityLogs\": { \"activityLog\": [ { \"activityLog\": \"JUL 30,2015\", \"activityLogFHIR\": \"2015-07-30\", \"activityLogFM\": 3150730, \"activityLogHL7\": 20150730, \"comment\": \"Patient Instructions Not Sent By Provider.\", \"fieldEdited\": \"\", \"initiatorOfActivity\": \"\", \"initiatorOfActivityId\": \"\", \"newValue\": \"\", \"oldValue\": \"\", \"reason\": \"PATIENT INST\", \"reasonCd\": \"G\", \"resourceId\": \"V-500-52-404406-52.3-1\", \"rxReference\": \"ORIGINAL\" }, { \"activityLog\": \"JUL 30,2015@17:23:53\", \"activityLogFHIR\": \"2015-07-30T17:23:53-05:00\", \"activityLogFM\": 3150730.172353, \"activityLogHL7\": \"20150730172353-0500\", \"comment\": \"Discontinued by OE\\/RR.\", \"fieldEdited\": \"\", \"initiatorOfActivity\": \"PROVIDER,FIVE\", \"initiatorOfActivityId\": 988, \"newValue\": \"\", \"oldValue\": \"\", \"otherCommentss\": { \"otherComments\": [ { \"otherComments\": \"PATIENT LOST HIS NOSE\", \"resourceId\": \"V-500-52-404348-52.3-2-52.34-1\" } ] }, \"reason\": \"DISCONTINUED\", \"reasonCd\": \"C\", \"resourceId\": \"V-500-52-404393-52.3-2\", \"rxReference\": \"ORIGINAL\" }, { \"activityLog\": \"JUL 30,2015@17:59\", \"activityLogFHIR\": \"2015-07-30T17:59:00-05:00\", \"activityLogFM\": 3150730.1759, \"activityLogHL7\": \"201507301759-0500\", \"comment\": \"RX placed in a HOLD status (07-30-15) by OERR.\", \"fieldEdited\": \"\", \"initiatorOfActivity\": \"PROVIDER,FIVE\", \"initiatorOfActivityId\": 988, \"newValue\": \"\", \"oldValue\": \"\", \"reason\": \"HOLD\", \"reasonCd\": \"H\", \"resourceId\": \"V-500-52-404392-52.3-3\", \"rxReference\": \"ORIGINAL\" }, { \"activityLog\": \"JUL 30,2015@17:47:26\", \"activityLogFHIR\": \"2015-07-30T17:47:26-05:00\", \"activityLogFM\": 3150730.174726, \"activityLogHL7\": \"20150730174726-0500\", \"comment\": \"Renewed from CPRS\", \"fieldEdited\": \"\", \"initiatorOfActivity\": \"PROGRAMMER,FIVE\", \"initiatorOfActivityId\": 119, \"newValue\": \"\", \"oldValue\": \"\", \"reason\": \"RENEWED\", \"reasonCd\": \"L\", \"resourceId\": \"V-500-52-404347-52.3-4\", \"rxReference\": \"ORIGINAL\" } ] }, \"administeredInClinic\": \"\", \"administeredInClinicCd\": \"\", \"affectedMedication\": \"\", \"agentOrangeExposure\": \"\", \"agentOrangeExposureCd\": \"\", \"ancResults\": \"\", \"archived\": \"\", \"archivedCd\": \"\", \"backdoorSignatureStatus\": \"\", \"backdoorSignatureStatusCd\": \"\", \"billingEligibilityIndicator\": \"\", \"billingEligibilityIndicatorCd\": \"\", \"bingoWaitTime\": \"\", \"cancelDate\": \"\", \"cancelDateFHIR\": \"\", \"cancelDateFM\": \"\", \"cancelDateHL7\": \"\", \"checkingPharmacist\": \"\", \"checkingPharmacistId\": \"\", \"checkingPharmacistResId\": \"\", \"clinic\": \"AUDIOLOGY\", \"clinicId\": 64, \"clozapineDosageMgDay\": \"\", \"combatVeteran\": \"\", \"combatVeteranCd\": \"\", \"copayExceedingCap\": \"\", \"copayExceedingCapId\": \"\", \"copayTransactionType\": \"\", \"copayTransactionTypeId\": \"\", \"copayTypeAudit\": \"\", \"copies\": 1, \"cosigningPhysician\": \"\", \"cosigningPhysicianId\": \"\", \"cosigningPhysicianNPI\": \"\", \"cosigningPhysicianResId\": \"\", \"dateNdcValidated\": \"\", \"dateNdcValidatedFHIR\": \"\", \"dateNdcValidatedFM\": \"\", \"dateNdcValidatedHL7\": \"\", \"dateOfDeathHistory\": \"\", \"dateOfWbcTest\": \"\", \"dateOfWbcTestFHIR\": \"\", \"dateOfWbcTestFM\": \"\", \"dateOfWbcTestHL7\": \"\", \"dawCode\": 0, \"daysSupply\": 90, \"ddstatus\": \"\", \"deletionComments\": \"\", \"discontinueType\": \"\", \"discontinueTypeCd\": \"\", \"dispensedDate\": \"JUL 30,2015\", \"dispensedDateFHIR\": \"2015-07-30\", \"dispensedDateFM\": 3150730, \"dispensedDateHL7\": 20150730, \"division\": \"VEHU SITE\", \"divisionId\": 2, \"drug\": \"FUROSEMIDE 20MG TAB\", \"drugAllergyIndication\": \"\", \"drugAllergyIndicationCd\": \"\", \"drugExpirationDate\": \"\", \"drugExpirationDateFHIR\": \"\", \"drugExpirationDateFM\": \"\", \"drugExpirationDateHL7\": \"\", \"drugId\": 3963, \"enteredBy\": \"PROVIDER,FIVE\", \"enteredById\": 988, \"epharmacySuspenseHoldDate\": \"\", \"epharmacySuspenseHoldDateFHIR\": \"\", \"epharmacySuspenseHoldDateFM\": \"\", \"epharmacySuspenseHoldDateHL7\": \"\", \"expandedPatientInstructions\": \"\", \"expirationDate\": \"JUL 30,2016\", \"expirationDateFHIR\": \"2016-07-30\", \"expirationDateFM\": 3160730, \"expirationDateHL7\": 20160730, \"externalApplication\": \"\", \"externalPlacerOrderNumber\": \"\", \"fillDate\": \"JUL 30,2015\", \"fillDateFHIR\": \"2015-07-30\", \"fillDateFM\": 3150730, \"fillDateHL7\": 20150730, \"fillingPerson\": \"\", \"fillingPersonId\": \"\", \"finishDateTime\": \"JUL 30,2015@17:55:56\", \"finishDateTimeFHIR\": \"2015-07-30T17:55:56-05:00\", \"finishDateTimeFM\": 3150730.175556, \"finishDateTimeHL7\": \"20150730175556-0500\", \"finishingPerson\": \"PROGRAMMER,FIVE\", \"finishingPersonId\": 119, \"forwardOrder\": \"\", \"forwardOrderId\": \"\", \"forwardOrderResId\": \"\", \"genericProvider\": \"\", \"headAndOrNeckCancer\": \"\", \"headAndOrNeckCancerCd\": \"\", \"holdComments\": \"\", \"holdDate\": \"\", \"holdDateFHIR\": \"\", \"holdDateFM\": \"\", \"holdDateHL7\": \"\", \"holdReason\": \"\", \"holdReasonCd\": \"\", \"hospitalCoverage\": 0, \"ibNumber\": \"\", \"ibNumberId\": \"\", \"icdDiagnosiss\": { \"icdDiagnosis\": [ { \"agentOrange\": \"\", \"agentOrangeCd\": \"\", \"combatVeteran\": \"\", \"combatVeteranCd\": \"\", \"headAndOrNeckCancer\": \"\", \"headAndOrNeckCancerCd\": \"\", \"icdDiagnosis\": \"\", \"icdDiagnosisId\": \"\", \"icdDiagnosisSCT\": \"\", \"icdDiagnosisText\": \"\", \"ionizingRadiation\": \"\", \"ionizingRadiationCd\": \"\", \"militarySexualTrauma\": \"\", \"militarySexualTraumaCd\": \"\", \"proj112Shad\": \"\", \"proj112ShadCd\": \"\", \"resourceId\": \"V-500-52-404407-52.052311-1\", \"serviceConnection\": \"NO\", \"serviceConnectionCd\": 0, \"southwestAsiaConditions\": \"\", \"southwestAsiaConditionsCd\": \"\" } ] }, \"ionizingRadiationExposure\": \"\", \"ionizingRadiationExposureCd\": \"\", \"issueDate\": \"JUL 30,2015\", \"issueDateFHIR\": \"2015-07-30\", \"issueDateFM\": 3150730, \"issueDateHL7\": 20150730, \"labelDateTimes\": { \"labelDateTime\": [ { \"device\": \"\", \"fdaMedGuideFilename\": \"\", \"labelComment\": \"From RX number 501113\", \"labelDateTime\": \"JUL 22,2015@17:53:25\", \"labelDateTimeFHIR\": \"2015-07-22T17:53:25-05:00\", \"labelDateTimeFM\": 3150722.175325, \"labelDateTimeHL7\": \"20150722175325-0500\", \"printedBy\": \"PROGRAMMER,FIVE\", \"printedById\": 119, \"resourceId\": \"V-500-52-404394-52.032-1\", \"rxReference\": \"ORIGINAL\", \"warningLabelType\": \"\", \"warningLabelTypeCd\": \"\" } ] }, \"lastDispensedDate\": \"JUL 30,2015\", \"lastDispensedDateFHIR\": \"2015-07-30\", \"lastDispensedDateFM\": 3150730, \"lastDispensedDateHL7\": 20150730, \"lastDispensedDateHolder\": \"APR 21,2014\", \"lastDispensedDateHolderFHIR\": \"2014-04-21\", \"lastDispensedDateHolderFM\": 3140421, \"lastDispensedDateHolderHL7\": 20140421, \"loginDate\": \"JUL 30,2015@17:40:41\", \"loginDateFHIR\": \"2015-07-30T17:40:41-05:00\", \"loginDateFM\": 3150730.174041, \"loginDateHL7\": \"20150730174041-0500\", \"lot\": \"\", \"mailWindow\": \"WINDOW\", \"mailWindowCd\": \"W\", \"maintenanceDoseRx\": \"\", \"maintenanceDoseRxId\": \"\", \"manufacturer\": \"\", \"medicationInstructionss\": { \"medicationInstructions\": [ { \"conjunction\": \"\", \"conjunctionCd\": \"\", \"dispenseUnitsPerDose\": 1, \"dosageOrdered\": 20, \"duration\": \"\", \"noun\": \"TABLET\", \"otherLanguageDosage\": \"\", \"resourceId\": \"V-500-52-404407-52.0113-1\", \"route\": \"ORAL (BY MOUTH)\", \"routeId\": 1, \"schedule\": \"BID\", \"units\": \"MG\", \"unitsId\": 20, \"verb\": \"TAKE\" } ] }, \"methodOfPickUp\": \"\", \"militarySexualTrauma\": \"\", \"militarySexualTraumaCd\": \"\", \"nbrOfRefills\": 2, \"ndc\": \"00172-2908-80\", \"ndcValidatedBy\": \"\", \"ndcValidatedById\": \"\", \"newDrug\": \"\", \"nextPossibleFill\": \"OCT 18,2015\", \"nextPossibleFillFHIR\": \"2015-10-18\", \"nextPossibleFillFM\": 3151018, \"nextPossibleFillHL7\": 20151018, \"oerrSig\": \"YES\", \"oerrSigCd\": 1, \"orderConverted\": \"EXPIRATION TO CPRS\", \"orderConvertedCd\": 2, \"originalQty\": \"\", \"otherPatientInstructions\": \"\", \"patient\": \"TRASH,TONY\", \"patientICN\": \"5000000364V598024\", \"patientId\": 100860, \"patientInstructions\": \"\", \"patientStatus\": \"SC\", \"patientStatusId\": 1, \"patrxIen\": 404407, \"pendingNextPossibleFilldate\": \"\", \"pendingNextPossibleFilldateFHIR\": \"\", \"pendingNextPossibleFilldateFM\": \"\", \"pendingNextPossibleFilldateHL7\": \"\", \"pfssAccountReference\": \"\", \"pfssAccountReferenceId\": \"\", \"pfssChargeId\": \"\", \"pharmacist\": \"\", \"pharmacistId\": \"\", \"pharmacistResId\": \"\", \"pharmacyInstructions\": \"TAKE ONE TABLET PO BID\", \"pharmacyOrderableItem\": \"FUROSEMIDE\", \"pharmacyOrderableItemId\": 282, \"placerOrder\": 38947, \"poeRx\": \"YES\", \"poeRxCd\": 1, \"previousOrder\": 501012, \"previousOrderId\": 404238, \"previousOrderResId\": \"V-500-52-404238\", \"priorFillDate\": \"JAN 2,2015\", \"priorFillDateFHIR\": \"2015-01-02\", \"priorFillDateFM\": 3150102, \"priorFillDateHL7\": 20150102, \"proj112Shad\": \"\", \"proj112ShadCd\": \"\", \"provider\": \"PROVIDER,FIVE\", \"providerComments\": \"\", \"providerId\": 988, \"providerNPI\": 9990000397, \"providerResId\": \"V-500-200-988\", \"qty\": 180, \"reTransmitFlag\": \"\", \"reTransmitFlagCd\": \"\", \"refills\": { \"refill\": [ { \"administeredInClinic\": \"\", \"administeredInClinicCd\": \"\", \"billingEligibilityIndicator\": \"\", \"billingEligibilityIndicatorCd\": \"\", \"bingoWaitTime\": \"\", \"checkingPharmacist\": \"\", \"checkingPharmacistId\": \"\", \"checkingPharmacistResId\": \"\", \"clerkCode\": \"\", \"clerkCodeId\": \"\", \"copayExceedingCap\": \"\", \"copayExceedingCapId\": \"\", \"currentUnitPriceOfDrug\": \"\", \"dateNdcValidated\": \"\", \"dateNdcValidatedFHIR\": \"\", \"dateNdcValidatedFM\": \"\", \"dateNdcValidatedHL7\": \"\", \"dawCode\": \"\", \"daysSupply\": 90, \"dispensedDate\": \"JAN 2,2015\", \"dispensedDateFHIR\": \"2015-01-02\", \"dispensedDateFM\": 3150102, \"dispensedDateHL7\": 20150102, \"division\": \"\", \"divisionId\": \"\", \"drugExpirationDate\": \"\", \"drugExpirationDateFHIR\": \"\", \"drugExpirationDateFM\": \"\", \"drugExpirationDateHL7\": \"\", \"epharmacySuspenseHoldDate\": \"\", \"epharmacySuspenseHoldDateFHIR\": \"\", \"epharmacySuspenseHoldDateFM\": \"\", \"epharmacySuspenseHoldDateHL7\": \"\", \"fillingPerson\": \"\", \"fillingPersonId\": \"\", \"genericProvider\": \"\", \"ibNumber\": \"\", \"ibNumberId\": \"\", \"loginDate\": \"JAN 2,2015\", \"loginDateFHIR\": \"2015-01-02\", \"loginDateFM\": 3150102, \"loginDateHL7\": 20150102, \"lot\": \"\", \"mailWindow\": \"WINDOW\", \"mailWindowCd\": \"W\", \"manufacturer\": \"\", \"ndc\": \"00172-2908-80\", \"ndcValidatedBy\": \"\", \"ndcValidatedById\": \"\", \"pfssAccountReference\": \"\", \"pfssAccountReferenceId\": \"\", \"pfssChargeId\": \"\", \"pharmacistName\": \"\", \"pharmacistNameId\": 0, \"provider\": \"\", \"providerId\": \"\", \"providerNPI\": \"\", \"providerResId\": \"\", \"qty\": 180, \"reTransmitFlag\": \"\", \"reTransmitFlagCd\": \"\", \"refillDate\": \"JAN 2,2015\", \"refillDateFHIR\": \"2015-01-02\", \"refillDateFM\": 3150102, \"refillDateHL7\": 20150102, \"releasedDateTime\": \"JAN 2,2015\", \"releasedDateTimeFHIR\": \"2015-01-02\", \"releasedDateTimeFM\": 3150102, \"releasedDateTimeHL7\": 20150102, \"remarks\": \"\", \"resourceId\": \"V-500-52-404238-52.1-1\", \"returnedToStock\": \"\", \"returnedToStockFHIR\": \"\", \"returnedToStockFM\": \"\", \"returnedToStockHL7\": \"\" } ] }, \"releasedDateTime\": \"\", \"releasedDateTimeFHIR\": \"\", \"releasedDateTimeFM\": \"\", \"releasedDateTimeHL7\": \"\", \"remarks\": \"RENEWED FROM RX # 501012\", \"reprint\": \"\", \"reprintCd\": \"\", \"resourceId\": \"V-500-52-404407\", \"resourceType\": \"PatientPrescription\", \"returnedToStock\": \"\", \"returnedToStockFHIR\": \"\", \"returnedToStockFM\": \"\", \"returnedToStockHL7\": \"\", \"rx\": \"501012A\", \"rxnorm\": \"code not mapped\", \"serviceConnected\": \"\", \"serviceConnectedCd\": \"\", \"severity\": \"\", \"sig\": \"\", \"signatureStatus\": \"\", \"signatureStatusCd\": \"\", \"southwestAsiaConditions\": \"\", \"southwestAsiaConditionsCd\": \"\", \"status\": \"EXPIRED\", \"statusCd\": 11, \"titrationDoseRx\": \"\", \"titrationDoseRxId\": \"\", \"titrationRxFlag\": \"\", \"titrationRxFlagCd\": \"\", \"tpbRx\": \"\", \"tpbRxCd\": \"\", \"tradeName\": \"\", \"typeOfRx\": 0, \"unitPriceOfDrug\": \"0.0113\", \"verifyingPharmacist\": \"\", \"verifyingPharmacistId\": \"\", \"verifyingPharmacistResId\": \"\", \"wasCounselingUnderstood\": \"\", \"wasCounselingUnderstoodCd\": \"\", \"wasThePatientCounseled\": \"NO\", \"wasThePatientCounseledCd\": 0, \"wbcResults\": \"\" }, \"Phpat\": { \"ConversionCompleted\": \"IV VERIFIED\", \"ConversionCompletedCd\": 3, \"activeScriptsC\": 0, \"actualHistoricalFlag\": \"ACTUAL\", \"actualHistoricalFlagCd\": \"A\", \"cap\": \"SAFETY\", \"capCd\": 0, \"clozapineRegistrationNumber\": \"\", \"clozapineStatus\": \"\", \"clozapineStatusCd\": \"\", \"comments\": \"\", \"communityNursingHome\": \"\", \"communityNursingHomeCd\": \"\", \"dateOfLastClozapineRx\": \"\", \"dateOfLastClozapineRxFHIR\": \"\", \"dateOfLastClozapineRxFM\": \"\", \"dateOfLastClozapineRxHL7\": \"\", \"demographicsSent\": \"\", \"demographicsSentCd\": \"\", \"dialysisPatient\": \"NO\", \"dialysisPatientCd\": 0, \"firstServiceDate\": \"APR 21,2015@13:58\", \"firstServiceDateFHIR\": \"2015-04-21T13:58:00-05:00\", \"firstServiceDateFM\": 3150421.1358, \"firstServiceDateHL7\": \"201504211358-0500\", \"holdReason\": \"\", \"inpatientNarrative\": \"\", \"lastDateOfContract\": \"\", \"lastDateOfContractFHIR\": \"\", \"lastDateOfContractFM\": \"\", \"lastDateOfContractHL7\": \"\", \"mail\": \"REGULAR MAIL\", \"mailCd\": 0, \"mailStatusExpirationDate\": \"\", \"mailStatusExpirationDateFHIR\": \"\", \"mailStatusExpirationDateFM\": \"\", \"mailStatusExpirationDateHL7\": \"\", \"name\": \"TRASH,TONY\", \"nameICN\": \"5000000364V598024\", \"nameId\": 100860, \"narrative\": \"\", \"number\": 100860, \"nursingHomeContract\": \"\", \"nursingHomeContractCd\": \"\", \"otherLanguagePreference\": \"\", \"otherLanguagePreferenceCd\": \"\", \"patientStatus\": \"SC\", \"patientStatusId\": 1, \"phpatIen\": 100860, \"pmiLanguagePreference\": \"ENGLISH\", \"pmiLanguagePreferenceCd\": 1, \"prescriptionProfiles\": { \"prescriptionProfile\": [ { \"activeC\": 0, \"drugC\": \"FUROSEMIDE 20MG TAB\", \"prescriptionProfile\": 501012, \"prescriptionProfileId\": 404238, \"resourceId\": \"V-500-55-100860-55.03-1\", \"statusC\": \"DISCONTINUED\" }, { \"activeC\": 0, \"drugC\": \"CETIRIZINE 10MG CAP,ORAL\", \"prescriptionProfile\": 501087, \"prescriptionProfileId\": 404347, \"resourceId\": \"V-500-55-100860-55.03-2\", \"statusC\": \"DISCONTINUED\" }, { \"activeC\": 0, \"drugC\": \"MOMETASONE FUROATE 50MCG 120D NASAL SUSP\", \"prescriptionProfile\": 501088, \"prescriptionProfileId\": 404348, \"resourceId\": \"V-500-55-100860-55.03-3\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"ACETAMINOPHEN 325MG TAB\", \"prescriptionProfile\": 501111, \"prescriptionProfileId\": 404392, \"resourceId\": \"V-500-55-100860-55.03-4\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"FUROSEMIDE 20MG TAB\", \"prescriptionProfile\": 501112, \"prescriptionProfileId\": 404393, \"resourceId\": \"V-500-55-100860-55.03-5\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"ALCOHOL PREP PAD\", \"prescriptionProfile\": 501113, \"prescriptionProfileId\": 404394, \"resourceId\": \"V-500-55-100860-55.03-6\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"CETIRIZINE 10MG CAP,ORAL\", \"prescriptionProfile\": \"501087A\", \"prescriptionProfileId\": 404405, \"resourceId\": \"V-500-55-100860-55.03-7\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"METOPROLOL TARTRATE 50MG TAB\", \"prescriptionProfile\": 501117, \"prescriptionProfileId\": 404406, \"resourceId\": \"V-500-55-100860-55.03-8\", \"statusC\": \"EXPIRED\" }, { \"activeC\": 0, \"drugC\": \"FUROSEMIDE 20MG TAB\", \"prescriptionProfile\": \"501012A\", \"prescriptionProfileId\": 404407, \"resourceId\": \"V-500-55-100860-55.03-9\", \"statusC\": \"EXPIRED\" } ] }, \"registrationDate\": \"\", \"registrationDateFHIR\": \"\", \"registrationDateFM\": \"\", \"registrationDateHL7\": \"\", \"resourceId\": \"V-500-55-100860\", \"resourceType\": \"Medication\", \"respitePatientEndDate\": \"\", \"respitePatientEndDateFHIR\": \"\", \"respitePatientEndDateFM\": \"\", \"respitePatientEndDateHL7\": \"\", \"respitePatientStartDate\": \"\", \"respitePatientStartDateFHIR\": \"\", \"respitePatientStartDateFM\": \"\", \"respitePatientStartDateHL7\": \"\", \"responsibleProvider\": \"\", \"responsibleProviderId\": \"\", \"responsibleProviderNPI\": \"\", \"responsibleProviderResId\": \"\", \"rxUpdate\": \"\", \"rxUpdateCd\": \"\", \"udDefaultStopDateTime\": \"JUL 4,2015@09:44\", \"udDefaultStopDateTimeFHIR\": \"2015-07-04T09:44:00-05:00\", \"udDefaultStopDateTimeFM\": 3150704.0944, \"udDefaultStopDateTimeHL7\": \"201507040944-0500\", \"udDischargeFlag\": \"\", \"udDischargeFlagCd\": \"\", \"udExpUpDate\": \"\", \"udExpUpDateFHIR\": \"\", \"udExpUpDateFM\": \"\", \"udExpUpDateHL7\": \"\", \"udHoldFlag\": \"\", \"udHoldFlagCd\": \"\", \"udLastAdmissionDate\": \"\", \"udLastAdmissionDateFHIR\": \"\", \"udLastAdmissionDateFM\": \"\", \"udLastAdmissionDateHL7\": \"\", \"udLastDischargeDate\": \"\", \"udLastDischargeDateFHIR\": \"\", \"udLastDischargeDateFM\": \"\", \"udLastDischargeDateHL7\": \"\", \"udLastTransferDate\": \"\", \"udLastTransferDateFHIR\": \"\", \"udLastTransferDateFM\": \"\", \"udLastTransferDateHL7\": \"\", \"udProvider\": \"PROVIDER,THIRTY\", \"udProviderId\": 1057, \"udProviderNPI\": 9990000660, \"unitDoses\": { \"unitDose\": [ { \"activityLogs\": { \"activityLog\": [ { \"action\": \"VERIFIED BY PHARMACIST\", \"actionId\": 22030, \"date\": \"JUN 4,2015@09:44:35\", \"dateFHIR\": \"2015-06-04T09:44:35-05:00\", \"dateFM\": 3150604.094435, \"dateHL7\": \"20150604094435-0500\", \"field\": \"\", \"oldData\": \"\", \"oldDataWordProcessing\": \"\", \"resourceId\": \"V-500-55-100860-55.06-1-55.09-1\", \"user\": 119 }, { \"action\": \"FINISHED BY PHARMACIST\", \"actionId\": 22005, \"date\": \"JUN 4,2015@09:44:32\", \"dateFHIR\": \"2015-06-04T09:44:32-05:00\", \"dateFM\": 3150604.094432, \"dateHL7\": \"20150604094432-0500\", \"field\": \"\", \"oldData\": \"\", \"oldDataWordProcessing\": \"\", \"resourceId\": \"V-500-55-100860-55.06-1-55.09-3\", \"user\": 119 } ] }, \"adminTimes\": \"\", \"appointmentDateTime\": \"JUN 4,2015@09:04:45\", \"appointmentDateTimeFHIR\": \"2015-06-04T09:04:45-05:00\", \"appointmentDateTimeFM\": 3150604.090445, \"appointmentDateTimeHL7\": \"20150604090445-0500\", \"autoCancelledFlag\": \"\", \"autoCancelledFlagCd\": \"\", \"bcmaExpiredFlag\": \"\", \"bcmaExpiredFlagCd\": \"\", \"clerk\": \"PROVIDER,THIRTY\", \"clerkId\": 1057, \"clerkResId\": \"V-500-200-1057\", \"clinic\": \"Emergency Department\", \"clinicId\": 426, \"comments\": \"\", \"dateEnteredByClerk\": \"\", \"dateEnteredByClerkFHIR\": \"\", \"dateEnteredByClerkFM\": \"\", \"dateEnteredByClerkHL7\": \"\", \"dateMarkedCancelled\": \"\", \"dateMarkedCancelledFHIR\": \"\", \"dateMarkedCancelledFM\": \"\", \"dateMarkedCancelledHL7\": \"\", \"dateRenewalMarked\": \"\", \"dateRenewalMarkedFHIR\": \"\", \"dateRenewalMarkedFM\": \"\", \"dateRenewalMarkedHL7\": \"\", \"dateVerifiedByNurse\": \"\", \"dateVerifiedByNurseFHIR\": \"\", \"dateVerifiedByNurseFM\": \"\", \"dateVerifiedByNurseHL7\": \"\", \"dateVerifiedByPharmacist\": \"JUN 4,2015@09:44:35\", \"dateVerifiedByPharmacistFHIR\": \"2015-06-04T09:44:35-05:00\", \"dateVerifiedByPharmacistFM\": 3150604.094435, \"dateVerifiedByPharmacistHL7\": \"20150604094435-0500\", \"dateVerifiedByPhysician\": \"\", \"dateVerifiedByPhysicianFHIR\": \"\", \"dateVerifiedByPhysicianFM\": \"\", \"dateVerifiedByPhysicianHL7\": \"\", \"dayLimit\": \"\", \"dispenseDrugs\": { \"dispenseDrug\": [ { \"dispenseDrug\": \"FUROSEMIDE 10MG\\/ML 4ML INJ\", \"dispenseDrugId\": 984, \"dispenseDrugName\": \"FUROSEMIDE\", \"dispenseDrugNameId\": 197, \"dispenseDrugRxNorm\": \"code not mapped\", \"extraUnitsDispensed\": \"\", \"inactiveDate\": \"\", \"inactiveDateFHIR\": \"\", \"inactiveDateFM\": \"\", \"inactiveDateHL7\": \"\", \"preExchangeUnits\": \"\", \"resourceId\": \"V-500-55-100860-55.06-1-55.07-1\", \"returns\": \"\", \"totalExtraUnitsDispensed\": \"\", \"totalPreExchangeUnits\": \"\", \"totalReturns\": \"\", \"totalUnitsDispensedC\": \"0.00\", \"unitsActuallyDispensed\": \"\", \"unitsCalledFor\": \"\", \"unitsPerDose\": 1 } ] }, \"displayStatus\": \"\", \"displayStatusCd\": \"\", \"dosageOrdered\": \"40MG\", \"dose\": \"\", \"doseLimit\": \"\", \"flagged\": \"\", \"flaggedCd\": \"\", \"followingOrder\": \"\", \"frequencyInMinutes\": \"\", \"holdDate\": \"\", \"holdDateFHIR\": \"\", \"holdDateFM\": \"\", \"holdDateHL7\": \"\", \"holdFlag\": \"\", \"holdFlagCd\": \"\", \"holdStatus\": \"\", \"holdStatusCd\": \"\", \"holdUser\": \"\", \"holdUserId\": \"\", \"hospitalSuppliedSelfMed\": \"\", \"hospitalSuppliedSelfMedCd\": \"\", \"instructions\": \"40MG\", \"labelDate\": \"\", \"labelDateFHIR\": \"\", \"labelDateFM\": \"\", \"labelDateHL7\": \"\", \"labelReason\": \"\", \"labelReasonCd\": \"\", \"lastWard\": \"\", \"lastWardId\": 0, \"logInDate\": \"JUN 4,2015@09:05\", \"logInDateFHIR\": \"2015-06-04T09:05:00-05:00\", \"logInDateFM\": 3150604.0905, \"logInDateHL7\": \"201506040905-0500\", \"markedCancelled\": \"\", \"markedCancelledCd\": \"\", \"markedCancelledUser\": \"\", \"markedCancelledUserId\": \"\", \"medRoute\": \"INTRAVENOUS\", \"medRouteId\": 14, \"mergedPatient\": \"\", \"mostRecentFlagComment\": \"\", \"natureOfOrder\": \"ELECTRONICALLY ENTERED\", \"natureOfOrderCd\": \"E\", \"notToBeGivenFlag\": \"\", \"notToBeGivenFlagCd\": \"\", \"nvFlag\": \"NO\", \"nvFlagCd\": 0, \"oerrHoldFlag\": \"\", \"oerrHoldFlagCd\": \"\", \"offHoldDate\": \"\", \"offHoldDateFHIR\": \"\", \"offHoldDateFM\": \"\", \"offHoldDateHL7\": \"\", \"offHoldFlag\": \"\", \"offHoldFlagCd\": \"\", \"offHoldUser\": \"\", \"offHoldUserId\": \"\", \"orderDate\": \"JUN 4,2015@09:05\", \"orderDateFHIR\": \"2015-06-04T09:05:00-05:00\", \"orderDateFM\": 3150604.0905, \"orderDateHL7\": \"201506040905-0500\", \"orderNumber\": 1524, \"orderableItem\": \"FUROSEMIDE\", \"orderableItemId\": 281, \"ordersFileEntry\": 38725, \"ordersFileParentOrder\": \"\", \"originalOrderNumber\": 1524, \"originalStartDateTime\": \"\", \"originalStartDateTimeFHIR\": \"\", \"originalStartDateTimeFM\": \"\", \"originalStartDateTimeHL7\": \"\", \"originalWard\": \"\", \"originalWardId\": \"\", \"patientName\": \"TRASH,TONY\", \"patientNameICN\": \"5000000364V598024\", \"patientNameId\": 100860, \"physician\": \"\", \"physicianId\": \"\", \"physicianNPI\": \"\", \"physicianResId\": \"\", \"previousOrder\": \"\", \"previousStopDateTime\": \"\", \"previousStopDateTimeFHIR\": \"\", \"previousStopDateTimeFM\": \"\", \"previousStopDateTimeHL7\": \"\", \"priority\": \"ROUTINE\", \"priorityCd\": \"R\", \"provider\": \"PROVIDER,THIRTY\", \"providerComments\": \"\", \"providerId\": 1057, \"providerNPI\": 9990000660, \"providerResId\": \"V-500-200-1057\", \"purgeFlag\": \"\", \"purgeFlagFHIR\": \"\", \"purgeFlagFM\": \"\", \"purgeFlagHL7\": \"\", \"pvFlag\": \"YES\", \"pvFlagCd\": 1, \"reasonForFollowingOrder\": \"\", \"reasonForFollowingOrderCd\": \"\", \"reasonOrderCreated\": \"NEW\", \"reasonOrderCreatedCd\": \"N\", \"renewal\": \"\", \"renewalCd\": \"\", \"renewalUser\": \"\", \"renewalUserId\": \"\", \"requestedDuration\": \"\", \"resourceId\": \"V-500-55-100860-55.06-1\", \"schedule\": \"NOW\", \"scheduleType\": \"ONE TIME\", \"scheduleTypeCd\": \"O\", \"selfMed\": \"\", \"selfMedCd\": \"\", \"siOpiFlag\": \"\", \"siOpiFlagCd\": \"\", \"specialInstructions\": \"\", \"specialInstructionsLong\": \"\", \"startDateTime\": \"JUN 4,2015@09:44\", \"startDateTimeFHIR\": \"2015-06-04T09:44:00-05:00\", \"startDateTimeFM\": 3150604.0944, \"startDateTimeHL7\": \"201506040944-0500\", \"status\": \"EXPIRED\", \"statusCd\": \"E\", \"stopDateTime\": \"JUL 4,2015@09:44\", \"stopDateTimeFHIR\": \"2015-07-04T09:44:00-05:00\", \"stopDateTimeFM\": 3150704.0944, \"stopDateTimeHL7\": \"201507040944-0500\", \"type\": \"UNIT DOSE\", \"typeCd\": \"U\", \"unit\": \"\", \"verifyingNurse\": \"\", \"verifyingNurseId\": \"\", \"verifyingNurseResId\": \"\", \"verifyingPharmacist\": \"PROGRAMMER,FIVE\", \"verifyingPharmacistId\": 119, \"verifyingPharmacistResId\": \"V-500-200-119\" } ] } } }";

        MedicationParser parser = new MedicationParser();

        List<MedicationStatement> result = parser.parseMedicationStatement(input);

        Assert.assertEquals("Correct number of items", 11, result.size());

        // First record, which is parsed differently than the subsequent records
        Assert.assertEquals("Correct drug name", "FUROSEMIDE 20MG TAB", result.get(0).getMedicationReference().getDisplay());
        Assert.assertEquals("Correct Status", MedicationStatement.MedicationStatementStatus.COMPLETED, result.get(0).getStatus());
        Assert.assertEquals("Correct Dose Amount", 20L, result.get(0).getDosage().get(0).getDoseSimpleQuantity().getValue().longValue());
        Assert.assertEquals("Correct Units", "MG", result.get(0).getDosage().get(0).getDoseSimpleQuantity().getCode());
        Assert.assertEquals("Correct Route", "Oral route", result.get(0).getDosage().get(0).getRoute().getCoding().get(0).getDisplay());
        SimpleDateFormat sdf = new SimpleDateFormat("MMM dd, yyyy");
        Date expectedDate = sdf.parse("JUL 30, 2015");
        Assert.assertEquals("Correct effective start date and time", expectedDate, result.get(0).getEffectivePeriod().getStart());

        //Second record
        Assert.assertEquals("Correct drug name", "FUROSEMIDE", result.get(1).getMedicationReference().getDisplay());
        Assert.assertEquals("Correct Status", MedicationStatement.MedicationStatementStatus.COMPLETED, result.get(1).getStatus());
        Assert.assertEquals("Correct Dose Amount", 40L, result.get(1).getDosage().get(0).getDoseSimpleQuantity().getValue().longValue());
        Assert.assertEquals("Correct Units", "MG", result.get(1).getDosage().get(0).getDoseSimpleQuantity().getCode());
        sdf = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ssX");
        expectedDate = sdf.parse("2015-06-04T09:44:00-05:00");
        Assert.assertEquals("Correct Route", "Intravenous route", result.get(1).getDosage().get(0).getRoute().getCoding().get(0).getDisplay());
        Assert.assertEquals("Correct effective start date and time", expectedDate, result.get(1).getEffectivePeriod().getStart());
    }

    @Test
    public void TestEmptyMedicationStatementParse() {
        String input = "";

        MedicationParser parser = new MedicationParser();

        List<MedicationStatement> result = parser.parseMedicationStatement(input);

        Assert.assertEquals("Correct number of items", 0, result.size());
    }
    @Test
    public void TestNotFoundMedicationStatementParse() {
        String input = "-1^Patientidentifiernotrecognised";

        MedicationParser parser = new MedicationParser();

        List<MedicationStatement> result = parser.parseMedicationStatement(input);

        Assert.assertEquals("Correct number of items", 0, result.size());
    }

    @Test
    public void TestNoMedicationStatementParse() {
        String input = "{}";

        MedicationParser parser = new MedicationParser();

        List<MedicationStatement> result = parser.parseMedicationStatement(input);

        Assert.assertEquals("Correct number of items", 0, result.size());
    }
}
