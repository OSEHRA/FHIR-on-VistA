/* Created by Perspecta http://www.perspecta.com */
/*
        Licensed to the Apache Software Foundation (ASF) under one
        or more contributor license agreements.  See the NOTICE file
        distributed with this work for additional information
        regarding copyright ownership.  The ASF licenses this file
        to you under the Apache License, Version 2.0 (the
        "License"); you may not use this file except in compliance
        with the License.  You may obtain a copy of the License at
        http://www.apache.org/licenses/LICENSE-2.0
        Unless required by applicable law or agreed to in writing,
        software distributed under the License is distributed on an
        "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        KIND, either express or implied.  See the License for the
        specific language governing permissions and limitations
        under the License.
*/
package com.healthconcourse.vista.fhir.api.test.parser;

import com.healthconcourse.vista.fhir.api.parser.MedicationParser;
import org.hl7.fhir.dstu3.model.*;
import org.junit.Assert;
import org.junit.Test;
import java.util.List;

public class MedicationParserTest {


    @Test
    public void TestSuccesfulMedicationAdminParse() {
        String input = "3043460050V279846^507_52_404253^EXPIRED^ACEBUTOLOL HCL 200MG CAP^APR 28, 2015^REASON^;ORAL (BY MOUTH);^180^90|507_52_404254^DISCONTINUED BY PROVIDER^AMLODIPINE BESYLATE 5MG TAB^APR 28, 2015^REASON^;ORAL (BY MOUTH);^90^90|507_52_404255^EXPIRED^FUROSEMIDE 10MG/ML ORAL SOLN^APR 28, 2015^REASON^;ORAL (BY MOUTH);^5^90|507_52_404256^DISCONTINUED BY PROVIDER^METOLAZONE 2.5MG TAB^APR 28, 2015^REASON^;ORAL (BY MOUTH);^90^90|507_52_404262^EXPIRED^CLOPIDOGREL BISULFATE 75MG TAB^APR 29, 2015^REASON^;ORAL (BY MOUTH);^60^30|";

        MedicationParser parser = new MedicationParser();

        List<MedicationAdministration> result = parser.parseMedicationAdmin(input);

        Assert.assertEquals("Correct number of items", 5, result.size());
    }

    @Test
    public void TestSuccesfulMedicationAdminBadDataParse() {
        String input = "3043460050V279846^507_52_404253^ACTIVE^ACEBUTOLOL HCL 200MG CAP^TEN 13, 2015^REASON^SITE;ORAL (BY MOUTH);200MG^180^90|507_52_404254^DISCONTINUED BY PROVIDER^AMLODIPINE BESYLATE 5MG TAB^APR 28, 2015^REASON^;TOPICAL;5^90^90|507_52_404255^EXPIRED^FUROSEMIDE 10MG/ML ORAL SOLN^APR 28, 2015^REASON^;NASAL;^5^90|507_52_404256^^METOLAZONE 2.5MG TAB^APR 28, 2015^REASON^;ORAL (BY MOUTH);^90^90|507_52_404262^EXPIRED^CLOPIDOGREL BISULFATE 75MG TAB^APR 29, 2015^REASON^;ORAL (BY MOUTH);^60^30|";

        MedicationParser parser = new MedicationParser();

        List<MedicationAdministration> result = parser.parseMedicationAdmin(input);

        Assert.assertEquals("Correct number of items", 5, result.size());
    }

    @Test
    public void TestInvaledMedicationAdminParse() {
        String input = "3043460050V279846^";

        MedicationParser parser = new MedicationParser();

        List<MedicationAdministration> result = parser.parseMedicationAdmin(input);

        Assert.assertEquals("Correct number of items", 0, result.size());
    }

    @Test
    public void TestSuccesfulDispenseParse() {
        String input = "5000001533V676621^507_55_1560^ACTIVE^SAL ACID, LACTIC ACID, FLEX COL^JUL 26, 2017@18:00^REASON^;IV PIGGYBACK;10MG^^|507_55_^^AMOXAPINE 100MG TAB^^REASON^;;100MG^^|507_52_404298^EXPIRED^SIMVASTATIN 80MG TAB^NOV 19, 2013@08:55^REASON^;ORAL (BY MOUTH);100MG^90^90|507_52_404299^EXPIRED^SIMVASTATIN 80MG TAB^DEC 02, 2014@13:44^REASON^;ORAL (BY MOUTH);100MG^90^90|507_52_404300^EXPIRED^LISINOPRIL 20MG TAB^NOV 19, 2013^REASON^;ORAL (BY MOUTH);100MG^90^90|507_52_404301^DISCONTINUED^LISINOPRIL 20MG TAB^DEC 02, 2014@13:44^REASON^;ORAL (BY MOUTH);100MG^90^90|507_52_404302^EXPIRED^LISINOPRIL 40MG TAB^MAR 01, 2015@13:56^REASON^;ORAL (BY MOUTH);100MG^90^90|507_52_404303^EXPIRED^CHLORTHALIDONE 25MG TAB^NOV 19, 2013@08:55^REASON^;ORAL (BY MOUTH);100MG^45^90|507_52_404304^EXPIRED^ASPIRIN 81MG EC TAB^NOV 19, 2013@08:55^REASON^;ORAL (BY MOUTH);100MG^90^90|507_52_404305^EXPIRED^CALCIUM CARBONATE 1.25GM (CA 500MG) TAB^NOV 19, 2013@08:55^REASON^;ORAL (BY MOUTH);100MG^270^90|507_52_404306^EXPIRED^GLYBURIDE 2.5MG TAB^NOV 19, 2013@08:55^REASON^;ORAL (BY MOUTH);100MG^90^90|507_52_404307^EXPIRED^LEVOTHYROXINE NA (SYNTHROID) 0.125MG TAB^NOV 19, 2013@08:55^REASON^;ORAL (BY MOUTH);100MG^90^90|507_52_404308^EXPIRED^VENLAFAXINE HCL 37.5MG TAB^NOV 19, 2013@08:55^REASON^;ORAL (BY MOUTH);100MG^360^90|507_52_404309^DISCONTINUED^CHLORTHALIDONE 25MG TAB^DEC 02, 2014@13:44^REASON^;ORAL (BY MOUTH);100MG^45^90|507_52_404310^EXPIRED^ASPIRIN 81MG EC TAB^DEC 02, 2014@13:44^REASON^;ORAL (BY MOUTH);100MG^90^90|507_52_404311^EXPIRED^CALCIUM CARBONATE 1.25GM (CA 500MG) TAB^DEC 02, 2014@13:44^REASON^;ORAL (BY MOUTH);100MG^270^90|507_52_404312^EXPIRED^GLYBURIDE 2.5MG TAB^DEC 02, 2014@13:44^REASON^;ORAL (BY MOUTH);100MG^90^90|507_52_404313^EXPIRED^LEVOTHYROXINE NA (SYNTHROID) 0.125MG TAB^DEC 02, 2014@13:44^REASON^;ORAL (BY MOUTH);100MG^90^90|507_52_404314^EXPIRED^VENLAFAXINE HCL 37.5MG TAB^DEC 02, 2014@13:44^REASON^;ORAL (BY MOUTH);100MG^360^90|507_52_404315^DISCONTINUED^CHLORTHALIDONE 25MG TAB^MAR 01, 2015@13:56^REASON^;ORAL (BY MOUTH);100MG^90^90|507_52_404323^EXPIRED^CHOLECALCIFEROL (VIT D3) 1,000UNIT TAB^NOV 19, 2013^REASON^;ORAL (BY MOUTH);100MG^90^90|507_52_404324^EXPIRED^CHLORTHALIDONE 25MG TAB^MAR 01, 2015^REASON^;ORAL (BY MOUTH);100MG^90^90|507_52_404325^EXPIRED^CHOLECALCIFEROL (VIT D3) 1,000UNIT TAB^DEC 02, 2014^REASON^;ORAL (BY MOUTH);100MG^90^90|507_52_404435^DISCONTINUED^HALOPERIDOL 10MG TAB^JUL 25, 2017^REASON^;ORAL (BY MOUTH);100MG^20^10|507_52_404436^DISCONTINUED^WARFARIN (C0UMADIN) NA 7.5MG TAB^JUL 25, 2017^REASON^;ORAL (BY MOUTH);100MG^30^30|507_52_404437^DISCONTINUED^THYROID 60-65MG (1 GR.) TAB^JUL 25, 2017^REASON^;ORAL (BY MOUTH);100MG^12^30|";

        MedicationParser parser = new MedicationParser();

        List<MedicationDispense> result = parser.parseMedicationDispense(input);

        Assert.assertEquals("Correct number of items", 26, result.size());
    }

    @Test
    public void TestInvalidDispenseParse() {
        String input = "5000001533V676621^507_55_1560^";

        MedicationParser parser = new MedicationParser();

        List<MedicationDispense> result = parser.parseMedicationDispense(input);

        Assert.assertEquals("Correct number of items", 0, result.size());
    }

    @Test
    public void TestSuccesfulMedicationStatementParse() {
        String input = "3043460050V279846^507_52_404253^EXPIRED^ACEBUTOLOL HCL 200MG CAP^APR 28, 2015^REASON^;ORAL (BY MOUTH);^180^90|507_52_404254^DISCONTINUED BY PROVIDER^AMLODIPINE BESYLATE 5MG TAB^APR 28, 2015^REASON^;ORAL (BY MOUTH);^90^90|507_52_404255^EXPIRED^FUROSEMIDE 10MG/ML ORAL SOLN^APR 28, 2015^REASON^;ORAL (BY MOUTH);^5^90|507_52_404256^DISCONTINUED BY PROVIDER^METOLAZONE 2.5MG TAB^APR 28, 2015^REASON^;ORAL (BY MOUTH);^90^90|507_52_404262^EXPIRED^CLOPIDOGREL BISULFATE 75MG TAB^APR 29, 2015^REASON^;ORAL (BY MOUTH);^60^30|";

        MedicationParser parser = new MedicationParser();

        List<MedicationStatement> result = parser.parseMedicationStatement(input);

        Assert.assertEquals("Correct number of items", 5, result.size());
    }

    @Test
    public void TestInvalidMedicationStatementParse() {
        String input = "3043460050V279846^507_52_404253^EXPIRED^";

        MedicationParser parser = new MedicationParser();

        List<MedicationStatement> result = parser.parseMedicationStatement(input);

        Assert.assertEquals("Correct number of items", 0, result.size());
    }

    @Test
    public void TestEmptyMedicationStatementParse() {
        String input = "";

        MedicationParser parser = new MedicationParser();

        List<MedicationStatement> result = parser.parseMedicationStatement(input);

        Assert.assertEquals("Correct number of items", 0, result.size());
    }

    @Test
    public void TestAdditionOfRxNormCodes() {
        String input = "9983386479V988252^V_507_55_444^EXPIRED^WARFARIN 2MG TABS^199505241100-0500^REASON^;ORAL;^^^RXN11289|V_507_55_454^DISCONTINUED^AMITRIPTYLINE 100MG^199506091400-0500^REASON^;ORAL;^^^RXN704|V_507_55_460^EXPIRED^ASCORBIC ACID 250MG TAB^199506221700-0500^REASON^;ORAL;^^^RXN1151|V_507_55_461^EXPIRED^FERROUS SULFATE 300MG TAB^199506221200-0500^REASON^;ORAL;^^^^missing VistA data|V_507_55_462^EXPIRED^BECLOMETHASONE 40MCG(HFA) 100D ORAL INHL^199506221200-0500^REASON^;ORAL;^^^RXN1348|V_507_55_463^EXPIRED^DIGOXIN 0.25MG TAB^199506220900-0500^REASON^;ORAL;^^^RXN3407|V_507_55_464^EXPIRED^FUROSEMID 20MG TABS ^199506220900-0500^REASON^;ORAL;^^^RXN4603|V_507_55_465^EXPIRED^PROPRANOLOL 10MG TAB^199506230900-0500^REASON^;ORAL;^^^RXN8787|V_507_55_466^EXPIRED^PRIMIDONE 250MG TAB^199506230900-0500^REASON^;ORAL;^^^RXN8691|V_507_55_467^EXPIRED^MULTIVITAMIN CAP/TAB^199506231100-0500^REASON^;ORAL;^^^RXN218488|V_507_55_468^EXPIRED^BACLOFEN 10MG TAB^199506230900-0500^REASON^;ORAL;^^^RXN1292|V_507_55_469^EXPIRED^QUINIDINE SULFATE 200MG TAB^199506230900-0500^REASON^;ORAL;^^^RXN9068|V_507_55_470^EXPIRED^PENICILLAMINE 250MG CAP^199506230900-0500^REASON^;ORAL;^^^RXN7975|V_507_55_475^EXPIRED^ZZPEN-G POTASSIUM 5MIL.UNIT VIAL^199506301500-0500^REASON^;IV PIGGYBACK;^^^RXN70618|V_507_55_477^EXPIRED^DIGOXIN 0.25MG TAB^199507070900-0500^REASON^;ORAL;^^^RXN3407|V_507_55_482^EXPIRED^DIGOXIN (LANOXIN) 0.125MG TAB^199507101600-0500^REASON^;ORAL;^^^RXN3407|V_507_55_484^EXPIRED^BECLOMETHASONE 40MCG(HFA) 100D ORAL INHL^199507111200-0500^REASON^;ORAL;^^^RXN1348|V_507_55_485^EXPIRED^MYLANTA TABLET^199507121700-0500^REASON^;ORAL;^^^^missing VistA data|V_507_55_19^EXPIRED^AMITRIPTYLINE 100MG^199507191400-0500^REASON^;ORAL;^^^RXN704|V_507_55_20^EXPIRED^ASCORBIC ACID 250MG TAB^199507190900-0500^REASON^;ORAL;^^^RXN1151|V_507_55_489^EXPIRED^AMPICILLIN 250MG CAP^199507240900-0500^REASON^;ORAL;^^^RXN733|V_507_55_501^EXPIRED^SULFAMETHOXAZO 200/TRIMETH 40MG/5ML SUSP^199507270900-0500^REASON^;ORAL;^^^RXN10831|V_507_55_520^EXPIRED^IBUPROFEN 800MG TAB^199508180800-0500^REASON^;ORAL;^^^RXN5640|V_507_55_522^EXPIRED^ASCORBIC ACID 250MG TAB^199508291700-0500^REASON^;ORAL;^^^RXN1151|V_507_55_524^EXPIRED^IBUPROFEN 800MG TAB^199508291300-0500^REASON^;ORAL;^^^RXN5640|V_507_55_528^EXPIRED^AMPICILLIN 250MG CAP^199509150900-0500^REASON^;ORAL;^^^RXN733|V_507_55_530^EXPIRED^ZZHYDROCHLOROTHIAZIDE 50MG S.T.^199509290900-0500^REASON^;ORAL;^^^RXN5487|V_507_55_532^DISCONTINUED (EDIT)^AMPICILLIN 250MG CAP^199510031500-0500^REASON^;ORAL;^^^RXN733|V_507_55_534^EXPIRED^AMPICILLIN 250MG CAP^199510061500-0500^REASON^;INTRAMUSCULAR SUBCUTANEOUS;^^^RXN733|V_507_55_535^EXPIRED^DIAZEPAM 5MG TAB^199510110900-0500^REASON^;ORAL (BY MOUTH);^^^RXN3322|V_507_55_536^DISCONTINUED (EDIT)^DIAZEPAM 5MG TAB^199510130000-0500^REASON^;ORAL (BY MOUTH);^^^RXN3322|V_507_55_537^EXPIRED^DIAZEPAM 5MG TAB^199510130900-0500^REASON^;ORAL (BY MOUTH);^^^RXN3322|V_507_55_538^EXPIRED^DIAZEPAM 5MG TAB^199510130900-0500^REASON^;ORAL (BY MOUTH);^^^RXN3322|V_507_55_542^DISCONTINUED (EDIT)^AMPICILLIN 250MG CAP^199510161500-0500^REASON^;ORAL;^^^RXN733|V_507_55_529^EXPIRED^FUROSEMID 20MG TABS ^199509291200-0500^REASON^;ORAL;^^^RXN4603|V_507_55_543^DISCONTINUED (EDIT)^ASPIRIN 325MG BUFFERED TAB^199510161700-0500^REASON^;ORAL;^^^RXN1191|V_507_55_523^DISCONTINUED (EDIT)^IBUPROFEN 800MG TAB^199508291300-0500^REASON^;ORAL;^^^RXN5640|V_507_55_544^DISCONTINUED (EDIT)^PHENYTOIN 100MG CAP^199510161700-0500^REASON^;ORAL;^^^RXN8183|V_507_55_545^DISCONTINUED (EDIT)^PENICILLIN VK 250MG TAB^199510161500-0500^REASON^;ORAL;^^^RXN70618|V_507_55_546^DISCONTINUED (EDIT)^ACETAMINOPHEN 325MG C.T.^199510161700-0500^REASON^;ORAL;^^^RXN161|V_507_55_547^DISCONTINUED (EDIT)^ACETAMINOPHEN 325MG C.T.^199510161700-0500^REASON^;ORAL;^^^RXN161|V_507_55_548^DISCONTINUED (EDIT)^IBUPROFEN 800MG TAB^199510161700-0500^REASON^;ORAL;^^^RXN5640|V_507_55_549^DISCONTINUED (EDIT)^PENICILLIN VK 250MG TAB^199510161500-0500^REASON^;ORAL;^^^RXN70618|V_507_55_550^DISCONTINUED (EDIT)^PHENYTOIN 100MG CAP^199510161700-0500^REASON^;ORAL;^^^RXN8183|V_507_55_551^DISCONTINUED (EDIT)^ACETAMINOPHEN 325MG C.T.^199510161700-0500^REASON^;ORAL;^^^RXN161|V_507_55_552^DISCONTINUED (EDIT)^NAPROXEN 375MG TAB^199510161700-0500^REASON^;ORAL;^^^RXN7258|V_507_55_553^DISCONTINUED (EDIT)^PENICILLIN VK 250MG TAB^199510161600-0500^REASON^;ORAL;^^^RXN70618|V_507_55_554^DISCONTINUED (EDIT)^PHENOBARBITAL 32MG TAB^199510161700-0500^REASON^;ORAL;^^^RXN8134|V_507_55_555^EXPIRED^ACETAMINOPHEN 325MG C.T.^199510161700-0500^REASON^;ORAL;^^^RXN161|V_507_55_556^EXPIRED^NAPROXEN 375MG TAB^199510161700-0500^REASON^;ORAL;^^^RXN7258|V_507_55_557^EXPIRED^PENICILLIN VK 250MG TAB^199510161600-0500^REASON^;ORAL;^^^RXN70618|V_507_55_558^EXPIRED^PHENOBARBITAL 32MG TAB^199510161700-0500^REASON^;ORAL;^^^RXN8134|V_507_52_400981^EXPIRED^AMITRIPTYLINE 100MG^19950623^REASON^;;^30^30^RXN704|V_507_52_400986^EXPIRED^PREDNISONE 20MG TAB^19950629^REASON^;;^30^30^RXN8640|V_507_52_401036^EXPIRED^AMINOPHYLLIN 200MG TAB  ^19951010^REASON^;;^120^30^^missing VistA data|V_507_52_401037^DISCONTINUED^DIGOXIN (LANOXIN) 0.125MG TAB^19951010^REASON^;;^30^30^RXN3407|V_507_52_401038^EXPIRED^FUROSEMIDE 40MG TAB^19951010^REASON^;;^30^30^RXN4603|V_507_52_401039^EXPIRED^IBUPROFEN 800MG TAB^19951011^REASON^;;^120^30^RXN5640|V_507_52_401040^EXPIRED^DIGOXIN (LANOXIN) 0.125MG TAB^19951011^REASON^;;^30^30^RXN3407|V_507_52_401042^DISCONTINUED^BACLOFEN 10MG TAB^19951011^REASON^;;^120^60^RXN1292|V_507_52_401153^EXPIRED^FUROSEMIDE 10MG/ML INJ^19960222^REASON^;;^10^30^RXN4603|";

        MedicationParser parser = new MedicationParser();

        List<MedicationStatement> result = parser.parseMedicationStatement(input);

        Assert.assertEquals("Correct number of items", 61, result.size());

        CodeableConcept code = result.get(0).getMedicationCodeableConcept();

        Assert.assertTrue("Record contains an RXNorm code", code.getCoding() != null);

        Reference ref = result.get(2).getMedicationReference();

        Assert.assertNotNull("Record is display only", ref.getDisplay());
    }
}
